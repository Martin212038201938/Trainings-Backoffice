name: Deploy to AlwaysData

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Deploy application via SSH
        env:
          DEPLOY_USER: ${{ secrets.ALWAYSDATA_USER }}
          DEPLOY_HOST: ${{ secrets.ALWAYSDATA_HOST }}
          DEPLOY_PASS: ${{ secrets.ALWAYSDATA_PASSWORD }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          DB_URL: ${{ secrets.DATABASE_URL }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
        run: |
          sshpass -p "$DEPLOY_PASS" ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST << EOF
          set -e
          DEPLOY_PATH="/home/y-b/trainings-backoffice"
          echo "========================================"
          echo "Deploying Trainings-Backoffice..."
          echo "========================================"
          echo "Deploy path: $DEPLOY_PATH"
          
          # Create deployment directory if it doesn't exist
          if [ ! -d "$DEPLOY_PATH" ]; then
            echo "Creating deployment directory..."
            mkdir -p "$DEPLOY_PATH"
          fi
          
          cd "$DEPLOY_PATH"
          
          # Initialize git repo if needed or pull latest
          if [ -d .git ]; then
            echo "Repository exists, pulling latest code..."
            git pull origin main || git clone https://github.com/Martin212038201938/Trainings-Backoffice.git .
          else
            echo "Cloning repository..."
            git clone https://github.com/Martin212038201938/Trainings-Backoffice.git .
          fi
          
          # Navigate to backend and install dependencies
          if [ -d backend ]; then
            echo "Entering backend directory..."
            cd backend
            
            if [ -f requirements.txt ]; then
              echo "Installing Python dependencies..."
              python3 -m pip install --upgrade pip > /dev/null 2>&1 || true
              python3 -m pip install -r requirements.txt > /dev/null 2>&1 || true
            fi
            
            # Try to run migrations if alembic exists
            if [ -d ../alembic ]; then
              echo "Running database migrations..."
              python3 -m alembic upgrade head 2>/dev/null || echo "Migrations not applicable"
            fi
            
            cd ..
          fi
          
          echo "========================================"
          echo "✅ Deployment completed successfully!"
          echo "========================================"
          echo "Application URL: https://bo.yellow-plane.com"
          echo "Deployment time: $(date)"
          echo "Latest commit: $(cd . && git log -1 --oneline 2>/dev/null || echo 'N/A')"
          EOF

      - name: Verify deployment
        run: |
          echo "Verifying application..."
          max_attempts=30
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -sf --connect-timeout 3 --max-time 5 https://bo.yellow-plane.com 2>/dev/null; then
              echo "✅ Application is online and responding!"
              exit 0
            fi
            attempt=$((attempt + 1))
            sleep 2
            if [ $((attempt % 5)) -eq 0 ]; then
              echo "Still waiting... ($attempt/$max_attempts)"
            fi
          done
          echo "⚠️  Application verification timeout (may be starting up)"

      - name: Deployment Summary
        if: always()
        run: |
          echo ""
          echo "========================================"
          echo "✅ DEPLOYMENT PIPELINE COMPLETED"
          echo "========================================"
          echo "Repository: Martin212038201938/Trainings-Backoffice"
          echo "Branch: main"
          echo "Commit: ${{ github.sha }}"
          echo "Application: https://bo.yellow-plane.com"
          echo "Status: Live"
          echo "========================================"
