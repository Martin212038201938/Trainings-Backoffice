<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yellow-Boat Academy</title>
    <style>
        :root {
            --yb-hellblau: #488BCB;
            --yb-gelb: #FDD850;
            --yb-grau: #939597;
            --yb-grau-light: #A4B1BA;
            --yb-hellblau-light: #6ba3d6;
            --yb-hellblau-dark: #3a7ab8;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #e8f1f8; }

        /* Login */
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, var(--yb-hellblau) 0%, var(--yb-hellblau-light) 100%); }
        .login-box { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); width: 100%; max-width: 400px; }
        .login-box h1 { margin-bottom: 1.5rem; color: var(--yb-hellblau); text-align: center; }
        .login-logo { display: block; margin: 0 auto 1rem; max-width: 120px; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--yb-grau); }
        .form-group input { width: 100%; padding: 0.75rem; border: 1px solid var(--yb-grau-light); border-radius: 4px; font-size: 1rem; }
        .form-group input:focus { outline: none; border-color: var(--yb-hellblau); box-shadow: 0 0 0 2px rgba(72, 139, 203, 0.2); }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; transition: all 0.2s; }
        .btn-primary { background: var(--yb-gelb); color: #333; width: 100%; font-weight: 600; }
        .btn-primary:hover { background: #f5cc3a; transform: translateY(-1px); }
        .error { color: #dc3545; margin-top: 1rem; }

        /* Dashboard */
        .app-container { display: none; }
        .header { background: var(--yb-hellblau); color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.5rem; display: flex; align-items: center; gap: 0.75rem; }
        .header-logo { height: 36px; }
        .user-info { display: flex; align-items: center; gap: 1rem; }
        .btn-logout { background: rgba(255,255,255,0.2); color: white; padding: 0.5rem 1rem; border: 1px solid rgba(255,255,255,0.3); }
        .btn-logout:hover { background: rgba(255,255,255,0.3); }

        .main-content { display: flex; min-height: calc(100vh - 60px); }
        .sidebar { width: 250px; background: white; border-right: 1px solid #ddd; padding: 1rem 0; }
        .sidebar a { display: block; padding: 0.75rem 1.5rem; color: var(--yb-grau); text-decoration: none; transition: all 0.2s; }
        .sidebar a:hover, .sidebar a.active { background: #e8f1f8; border-left: 3px solid var(--yb-gelb); color: var(--yb-hellblau); }

        .content { flex: 1; padding: 2rem; background: #e8f1f8; }
        .card { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 1rem; }
        .card-header { padding: 1rem 1.5rem; border-bottom: 1px solid #ddd; font-weight: 600; display: flex; justify-content: space-between; align-items: center; color: var(--yb-hellblau); }
        .card-body { padding: 1.5rem; }

        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #ddd; }
        th { font-weight: 600; background: #f8f9fa; color: var(--yb-grau); }

        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
        .btn-success { background: var(--yb-gelb); color: #333; font-weight: 500; }
        .btn-success:hover { background: #f5cc3a; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: var(--yb-grau-light); color: white; }

        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-top: 3px solid var(--yb-gelb); }
        .stat-card h3 { font-size: 2rem; color: var(--yb-hellblau); }
        .stat-card p { color: var(--yb-grau); margin-top: 0.5rem; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(72, 139, 203, 0.5); justify-content: center; align-items: center; overflow-y: auto; padding: 2rem 0; }
        .modal-content { background: white; padding: 2rem; border-radius: 8px; width: 100%; max-width: 700px; max-height: 90vh; overflow-y: auto; margin: auto; }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 1rem; color: var(--yb-hellblau); }
        .close { cursor: pointer; font-size: 1.5rem; color: var(--yb-grau); }
        .close:hover { color: var(--yb-hellblau); }

        /* Additional Yellow-Boat styling */
        h2 { color: var(--yb-hellblau); }
        .badge { background: var(--yb-hellblau) !important; }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <img src="https://www.yellow-boat.com/wp-content/uploads/2016/10/yellowBoatLogoico.png" alt="Yellow-Boat Academy" class="login-logo">
            <h1>Yellow-Boat Academy</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Benutzername</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Passwort</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn btn-primary">Anmelden</button>
                <div class="error" id="loginError"></div>
            </form>
        </div>
    </div>

    <!-- App -->
    <div class="app-container" id="appContainer">
        <header class="header">
            <h1>
                <img src="https://www.yellow-boat.com/wp-content/uploads/2016/10/yellowBoatLogoico.png" alt="Yellow-Boat" class="header-logo">
                Yellow-Boat Academy
            </h1>
            <div class="user-info">
                <span id="currentUser"></span>
                <button class="btn btn-logout" onclick="logout()">Abmelden</button>
            </div>
        </header>

        <div class="main-content">
            <nav class="sidebar">
                <a href="#" onclick="showSection('dashboard')" class="active" data-section="dashboard">Dashboard</a>
                <a href="#" onclick="showSection('trainings')" data-section="trainings">Trainings</a>
                <a href="#" onclick="showSection('customers')" data-section="customers">Kunden</a>
                <a href="#" onclick="showSection('trainers')" data-section="trainers">Trainer</a>
                <a href="#" onclick="showSection('brands')" data-section="brands">Marken</a>
                <a href="#" onclick="showSection('locations')" data-section="locations">Locations</a>
                <div id="adminNav" style="display:none; border-top: 1px solid #ddd; margin-top: 1rem; padding-top: 1rem;">
                    <small style="padding: 0 1.5rem; color: #6c757d;">Admin</small>
                    <a href="#" onclick="showSection('users')" data-section="users">Benutzer</a>
                </div>
                <div id="trainerNav" style="display:none; border-top: 1px solid #ddd; margin-top: 1rem; padding-top: 1rem;">
                    <small style="padding: 0 1.5rem; color: #6c757d;">Trainer Portal</small>
                    <a href="#" onclick="showSection('trainer-dashboard')" data-section="trainer-dashboard">Mein Dashboard</a>
                    <a href="#" onclick="showSection('open-trainings')" data-section="open-trainings">Offene Trainings</a>
                </div>
            </nav>

            <main class="content">
                <!-- Dashboard -->
                <div id="section-dashboard" class="section">
                    <h2>Dashboard</h2>
                    <div class="stats" id="dashboardStats">
                        <div class="stat-card">
                            <h3 id="statTrainings">-</h3>
                            <p>Trainings</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="statCustomers">-</h3>
                            <p>Kunden</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="statTrainers">-</h3>
                            <p>Trainer</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="statBrands">-</h3>
                            <p>Marken</p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">Letzte Trainings</div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr><th>Titel</th><th>Status</th><th>Datum</th></tr>
                                </thead>
                                <tbody id="recentTrainings"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Trainings -->
                <div id="section-trainings" class="section" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            Trainings
                            <button class="btn btn-sm btn-success" onclick="showCreateModal('training')">+ Neu</button>
                        </div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr><th>Titel</th><th>Status</th><th>Datum</th><th>Aktionen</th></tr>
                                </thead>
                                <tbody id="trainingsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Customers -->
                <div id="section-customers" class="section" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            Kunden
                            <button class="btn btn-sm btn-success" onclick="showCreateModal('customer')">+ Neu</button>
                        </div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr><th>Name</th><th>Email</th><th>Firma</th><th>Aktionen</th></tr>
                                </thead>
                                <tbody id="customersTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Trainers -->
                <div id="section-trainers" class="section" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            Trainer
                            <button class="btn btn-sm btn-success" onclick="showCreateModal('trainer')">+ Neu</button>
                        </div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr><th>Name</th><th>Email</th><th>Spezialisierung</th><th>Aktionen</th></tr>
                                </thead>
                                <tbody id="trainersTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Brands -->
                <div id="section-brands" class="section" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            Marken
                            <button class="btn btn-sm btn-success" onclick="showCreateModal('brand')">+ Neu</button>
                        </div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr><th>Name</th><th>Beschreibung</th><th>Aktionen</th></tr>
                                </thead>
                                <tbody id="brandsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Locations -->
                <div id="section-locations" class="section" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            Locations
                            <button class="btn btn-sm btn-success" onclick="showCreateModal('location')">+ Neu</button>
                        </div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Ort</th>
                                        <th>Max TN</th>
                                        <th>Catering</th>
                                        <th>Aktionen</th>
                                    </tr>
                                </thead>
                                <tbody id="locationsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Users (Admin only) -->
                <div id="section-users" class="section" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            Benutzer verwalten
                            <button class="btn btn-sm btn-success" onclick="showCreateModal('user')">+ Neuer Benutzer</button>
                        </div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr><th>Benutzername</th><th>Email</th><th>Rolle</th><th>Status</th><th>Trainer-Profil</th><th>Aktionen</th></tr>
                                </thead>
                                <tbody id="usersTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Trainer Dashboard -->
                <div id="section-trainer-dashboard" class="section" style="display:none;">
                    <h2>Mein Trainer Dashboard</h2>
                    <div class="stats" id="trainerStats">
                        <div class="stat-card">
                            <h3 id="statMyTrainings">-</h3>
                            <p>Meine Trainings</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="statCompleted">-</h3>
                            <p>Abgeschlossen</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="statEarnings">-</h3>
                            <p>Verdienst (€)</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="statPendingApps">-</h3>
                            <p>Offene Bewerbungen</p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">Meine letzten Trainings</div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr><th>Titel</th><th>Datum</th><th>Status</th><th>Verdienst</th></tr>
                                </thead>
                                <tbody id="myTrainingsTable"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card" style="margin-top: 1rem;">
                        <div class="card-header">Meine Bewerbungen</div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr><th>Training</th><th>Tagessatz</th><th>Nachricht</th><th>Status</th><th>Datum</th><th>Aktionen</th></tr>
                                </thead>
                                <tbody id="myApplicationsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Open Trainings for Application -->
                <div id="section-open-trainings" class="section" style="display:none;">
                    <h2>Offene Trainings</h2>
                    <p style="color: #6c757d; margin-bottom: 1rem;">Hier findest du Trainings, auf die du dich bewerben kannst.</p>
                    <div id="openTrainingsList"></div>
                </div>
            </main>
        </div>
    </div>

    <!-- Create Modal -->
    <div class="modal" id="createModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Neu erstellen</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <form id="createForm">
                <div id="modalFields"></div>
                <button type="submit" class="btn btn-primary" style="margin-top: 1rem;">Speichern</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = '';
        let token = localStorage.getItem('token');
        let currentUser = null;

        // Check if logged in
        if (token) {
            checkAuth();
        }

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const formData = new URLSearchParams();
                formData.append('username', username);
                formData.append('password', password);

                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });

                const data = await res.json();

                if (res.ok) {
                    token = data.access_token;
                    localStorage.setItem('token', token);
                    checkAuth();
                } else {
                    document.getElementById('loginError').textContent = data.error || 'Login fehlgeschlagen';
                }
            } catch (err) {
                document.getElementById('loginError').textContent = 'Verbindungsfehler';
            }
        });

        async function checkAuth() {
            try {
                const res = await fetch(`${API_URL}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    currentUser = await res.json();
                    document.getElementById('currentUser').textContent = currentUser.username;
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('appContainer').style.display = 'block';

                    // Show role-specific navigation
                    if (currentUser.role === 'admin') {
                        document.getElementById('adminNav').style.display = 'block';
                    }
                    if (currentUser.role === 'trainer') {
                        document.getElementById('trainerNav').style.display = 'block';
                        // Hide sections trainers shouldn't see
                        document.querySelector('[data-section="dashboard"]').style.display = 'none';
                        document.querySelector('[data-section="customers"]').style.display = 'none';
                        document.querySelector('[data-section="trainers"]').style.display = 'none';
                        // Trainers can view brands but not create
                        const brandsLink = document.querySelector('[data-section="brands"]');
                        if (brandsLink) brandsLink.textContent = 'Marken (Ansicht)';
                        // Start on trainer dashboard instead
                        showSection('trainer-dashboard');
                        return;
                    }

                    loadDashboard();
                } else {
                    logout();
                }
            } catch (err) {
                logout();
            }
        }

        function logout() {
            token = null;
            currentUser = null;
            localStorage.removeItem('token');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('currentUser').textContent = '';
            document.getElementById('adminNav').style.display = 'none';
            document.getElementById('trainerNav').style.display = 'none';
        }

        function showSection(name) {
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
            document.getElementById(`section-${name}`).style.display = 'block';
            document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
            const navItem = document.querySelector(`[data-section="${name}"]`);
            if (navItem) navItem.classList.add('active');

            if (name === 'dashboard') loadDashboard();
            else if (name === 'trainings') loadTrainings();
            else if (name === 'customers') loadCustomers();
            else if (name === 'trainers') loadTrainers();
            else if (name === 'brands') loadBrands();
            else if (name === 'locations') loadLocations();
            else if (name === 'users') loadUsers();
            else if (name === 'trainer-dashboard') loadTrainerDashboard();
            else if (name === 'open-trainings') loadOpenTrainings();
        }

        async function loadTrainerDashboard() {
            try {
                const data = await apiCall('/trainer/dashboard').then(r => r.json());

                if (data.error) {
                    document.getElementById('trainerStats').innerHTML = `<p style="color: #dc3545;">${data.error}</p>`;
                    return;
                }

                // Update stats
                document.getElementById('statMyTrainings').textContent = data.stats.total_trainings;
                document.getElementById('statCompleted').textContent = data.stats.completed_trainings;
                document.getElementById('statEarnings').textContent = data.stats.total_earnings.toFixed(2);
                document.getElementById('statPendingApps').textContent = data.stats.pending_applications;

                // Update my trainings table
                document.getElementById('myTrainingsTable').innerHTML = data.recent_trainings.map(t => `
                    <tr>
                        <td>${t.title || '-'}</td>
                        <td>${t.date ? new Date(t.date).toLocaleDateString('de') : '-'}</td>
                        <td>${t.status || '-'}</td>
                        <td>${t.earnings ? t.earnings.toFixed(2) + ' €' : '-'}</td>
                    </tr>
                `).join('') || '<tr><td colspan="4">Keine Trainings</td></tr>';

                // Update applications table
                document.getElementById('myApplicationsTable').innerHTML = data.applications.map(a => `
                    <tr>
                        <td>Training #${a.training_id}</td>
                        <td>${a.proposed_rate ? a.proposed_rate.toFixed(2) + ' €' : '-'}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${a.message || ''}">${a.message || '-'}</td>
                        <td><span style="color: ${a.status === 'accepted' ? '#28a745' : a.status === 'rejected' ? '#dc3545' : '#ffc107'};">${a.status}</span></td>
                        <td>${a.created_at ? new Date(a.created_at).toLocaleDateString('de') : '-'}</td>
                        <td>
                            ${a.status === 'pending' ? `<button class="btn btn-sm btn-danger" onclick="withdrawApplication(${a.id})">Zurückziehen</button>` : ''}
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="6">Keine Bewerbungen</td></tr>';
            } catch (err) {
                console.error('Error loading trainer dashboard:', err);
            }
        }

        async function loadOpenTrainings() {
            try {
                const trainings = await apiCall('/trainer/open-trainings').then(r => r.json());

                if (trainings.error) {
                    document.getElementById('openTrainingsList').innerHTML = `<p style="color: #dc3545;">${trainings.error}</p>`;
                    return;
                }

                document.getElementById('openTrainingsList').innerHTML = trainings.map(t => `
                    <div class="card" style="margin-bottom: 1rem;">
                        <div class="card-header">
                            ${t.title}
                            ${t.already_applied
                                ? '<span style="color: #28a745; float: right;">✓ Beworben</span>'
                                : `<button class="btn btn-sm btn-success" style="float: right;" onclick="applyForTraining(${t.id})">Bewerben</button>`
                            }
                        </div>
                        <div class="card-body">
                            <p><strong>Datum:</strong> ${t.start_date ? new Date(t.start_date).toLocaleDateString('de') : 'TBD'} ${t.end_date ? '- ' + new Date(t.end_date).toLocaleDateString('de') : ''}</p>
                            <p><strong>Dauer:</strong> ${t.duration_days || '?'} Tag(e)</p>
                            <p><strong>Ort:</strong> ${t.location || 'TBD'}</p>
                            ${t.description ? `<p><strong>Details:</strong> ${t.description}</p>` : ''}
                        </div>
                    </div>
                `).join('') || '<p>Keine offenen Trainings verfügbar.</p>';
            } catch (err) {
                console.error('Error loading open trainings:', err);
            }
        }

        async function applyForTraining(trainingId) {
            const rate = prompt('Dein Tagessatz (€):', '');
            if (rate === null) return;

            const message = prompt('Nachricht (optional):', '');

            try {
                const res = await apiCall(`/trainer/apply/${trainingId}`, {
                    method: 'POST',
                    body: JSON.stringify({
                        proposed_rate: rate ? parseFloat(rate) : null,
                        message: message || null
                    })
                });

                const data = await res.json();
                if (res.ok) {
                    alert('Bewerbung erfolgreich eingereicht!');
                    loadOpenTrainings();
                } else {
                    alert(data.error || 'Fehler bei der Bewerbung');
                }
            } catch (err) {
                alert('Fehler bei der Bewerbung');
            }
        }

        async function withdrawApplication(applicationId) {
            if (!confirm('Bewerbung wirklich zurückziehen?')) return;

            try {
                await apiCall(`/trainer/applications/${applicationId}`, { method: 'DELETE' });
                loadTrainerDashboard();
            } catch (err) {
                alert('Fehler beim Zurückziehen');
            }
        }

        let allTrainers = []; // Cache trainers for linking

        async function loadUsers() {
            if (currentUser.role !== 'admin') {
                document.getElementById('usersTable').innerHTML = '<tr><td colspan="6">Keine Berechtigung</td></tr>';
                return;
            }

            // Load trainers for linking dropdown
            const trainersRes = await apiCall('/trainers');
            if (trainersRes.ok) {
                allTrainers = await trainersRes.json();
            }

            const users = await apiCall('/auth/users').then(r => r.json());
            document.getElementById('usersTable').innerHTML = users.map(u => `
                <tr>
                    <td>${u.username}</td>
                    <td>${u.email}</td>
                    <td><span class="badge" style="background: ${u.role === 'admin' ? '#dc3545' : u.role === 'trainer' ? '#28a745' : '#007bff'}; color: white; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.75rem;">${u.role}</span></td>
                    <td>${u.is_active ? '<span style="color: #28a745;">Aktiv</span>' : '<span style="color: #dc3545;">Inaktiv</span>'}</td>
                    <td>
                        ${u.role === 'trainer' ? `
                            ${u.trainer_id
                                ? `<span style="color: #28a745;">${u.trainer_name}</span>
                                   <button class="btn btn-sm btn-secondary" onclick="showLinkTrainerModal(${u.id}, ${u.trainer_id})" style="margin-left:0.5rem;">Ändern</button>`
                                : `<button class="btn btn-sm btn-success" onclick="showLinkTrainerModal(${u.id}, null)">Verknüpfen</button>`
                            }
                        ` : '-'}
                    </td>
                    <td>
                        ${u.id !== currentUser.id ? `<button class="btn btn-sm btn-danger" onclick="deleteUser(${u.id})">Löschen</button>` : '<em>Aktueller User</em>'}
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="6">Keine Benutzer</td></tr>';
        }

        function showLinkTrainerModal(userId, currentTrainerId) {
            const availableTrainers = allTrainers.filter(t => !t.user_id || t.id === currentTrainerId);

            const options = availableTrainers.map(t =>
                `<option value="${t.id}" ${t.id === currentTrainerId ? 'selected' : ''}>${t.name} (${t.email})</option>`
            ).join('');

            const html = `
                <div class="modal-header">
                    <h3>Trainer verknüpfen</h3>
                    <span class="close" onclick="closeModal()">&times;</span>
                </div>
                <form onsubmit="linkUserToTrainer(event, ${userId})">
                    <div class="form-group">
                        <label>Trainer auswählen</label>
                        <select name="trainer_id" style="width:100%;padding:0.5rem;">
                            <option value="">-- Keine Verknüpfung --</option>
                            ${options}
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary" style="margin-top: 1rem;">Speichern</button>
                </form>
            `;

            document.getElementById('createModal').querySelector('.modal-content').innerHTML = html;
            document.getElementById('createModal').style.display = 'flex';
        }

        async function linkUserToTrainer(event, userId) {
            event.preventDefault();
            const form = event.target;
            const trainerId = form.trainer_id.value || null;

            const res = await apiCall(`/auth/users/${userId}/link-trainer`, {
                method: 'POST',
                body: JSON.stringify({ trainer_id: trainerId ? parseInt(trainerId) : null })
            });

            if (!res.ok) {
                const error = await res.json().catch(() => ({}));
                alert(error.error || 'Fehler beim Verknüpfen');
                return;
            }

            closeModal();
            loadUsers();
        }

        async function deleteUser(id) {
            if (!confirm('Benutzer wirklich löschen?')) return;
            const res = await apiCall(`/auth/users/${id}`, { method: 'DELETE' });
            if (!res.ok) {
                const error = await res.json().catch(() => ({}));
                alert(error.error || 'Fehler beim Löschen');
                return;
            }
            loadUsers();
        }

        async function apiCall(endpoint, options = {}) {
            const res = await fetch(`${API_URL}${endpoint}`, {
                ...options,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });
            if (res.status === 401) logout();
            return res;
        }

        async function loadDashboard() {
            const [trainings, customers, trainers, brands] = await Promise.all([
                apiCall('/trainings').then(r => r.json()),
                apiCall('/customers').then(r => r.json()),
                apiCall('/trainers').then(r => r.json()),
                apiCall('/brands').then(r => r.json())
            ]);

            document.getElementById('statTrainings').textContent = trainings.length;
            document.getElementById('statCustomers').textContent = customers.length;
            document.getElementById('statTrainers').textContent = trainers.length;
            document.getElementById('statBrands').textContent = brands.length;

            const recent = trainings.slice(0, 5);
            document.getElementById('recentTrainings').innerHTML = recent.map(t => `
                <tr>
                    <td>${t.title || '-'}</td>
                    <td>${t.status || '-'}</td>
                    <td>${t.date ? new Date(t.date).toLocaleDateString('de') : '-'}</td>
                </tr>
            `).join('') || '<tr><td colspan="3">Keine Trainings</td></tr>';
        }

        async function loadTrainings() {
            try {
                const res = await apiCall('/trainings');
                if (!res.ok) {
                    console.error('Failed to load trainings:', res.status);
                    document.getElementById('trainingsTable').innerHTML = '<tr><td colspan="4">Fehler beim Laden</td></tr>';
                    return;
                }
                const trainings = await res.json();
                document.getElementById('trainingsTable').innerHTML = trainings.map(t => `
                    <tr>
                        <td>${t.title || '-'}</td>
                        <td>${t.status || '-'}</td>
                        <td>${t.date ? new Date(t.date).toLocaleDateString('de') : '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="showEditModal('training', ${t.id})" style="margin-right:0.25rem;">Bearbeiten</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteItem('trainings', ${t.id})">Löschen</button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="4">Keine Trainings</td></tr>';
            } catch (err) {
                console.error('Error loading trainings:', err);
                document.getElementById('trainingsTable').innerHTML = '<tr><td colspan="4">Fehler beim Laden</td></tr>';
            }
        }

        async function loadCustomers() {
            try {
                const res = await apiCall('/customers');
                if (!res.ok) {
                    console.error('Failed to load customers:', res.status);
                    document.getElementById('customersTable').innerHTML = '<tr><td colspan="4">Fehler beim Laden</td></tr>';
                    return;
                }
                const customers = await res.json();
                document.getElementById('customersTable').innerHTML = customers.map(c => `
                    <tr>
                        <td title="Tel: ${c.phone || '-'}\nAdresse: ${c.street || ''} ${c.street_number || ''}, ${c.postal_code || ''} ${c.city || ''}">${c.name || c.company || '-'}</td>
                        <td>${c.email || '-'}</td>
                        <td>${c.company || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="showEditModal('customer', ${c.id})" style="margin-right:0.25rem;">Bearbeiten</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteItem('customers', ${c.id})">Löschen</button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="4">Keine Kunden</td></tr>';
            } catch (err) {
                console.error('Error loading customers:', err);
                document.getElementById('customersTable').innerHTML = '<tr><td colspan="4">Fehler beim Laden</td></tr>';
            }
        }

        async function loadTrainers() {
            try {
                const res = await apiCall('/trainers');
                if (!res.ok) {
                    console.error('Failed to load trainers:', res.status);
                    document.getElementById('trainersTable').innerHTML = '<tr><td colspan="4">Fehler beim Laden</td></tr>';
                    return;
                }
                const trainers = await res.json();
                document.getElementById('trainersTable').innerHTML = trainers.map(t => {
                    const specs = t.specializations || {selected: [], custom: []};
                    const allSpecs = [...(specs.selected || []), ...(specs.custom || [])];
                    return `
                        <tr>
                            <td title="Tel: ${t.phone || '-'}\nRegion: ${t.region || '-'}\nTagessatz: ${t.default_day_rate ? t.default_day_rate + ' €' : '-'}">
                                ${t.photo_path ? `<img src="${t.photo_path}" style="width:30px;height:30px;border-radius:50%;margin-right:0.5rem;vertical-align:middle;">` : ''}
                                ${t.name || '-'}
                            </td>
                            <td>${t.email || '-'}</td>
                            <td>${allSpecs.slice(0, 3).join(', ') || '-'}${allSpecs.length > 3 ? '...' : ''}</td>
                            <td>
                                <button class="btn btn-sm btn-secondary" onclick="showEditModal('trainer', ${t.id})" style="margin-right:0.25rem;">Bearbeiten</button>
                                ${t.linkedin_url ? `<a href="${t.linkedin_url}" target="_blank" class="btn btn-sm btn-secondary" style="margin-right:0.25rem;">LinkedIn</a>` : ''}
                                <button class="btn btn-sm btn-danger" onclick="deleteItem('trainers', ${t.id})">Löschen</button>
                            </td>
                        </tr>
                    `;
                }).join('') || '<tr><td colspan="4">Keine Trainer</td></tr>';
            } catch (err) {
                console.error('Error loading trainers:', err);
                document.getElementById('trainersTable').innerHTML = '<tr><td colspan="4">Fehler beim Laden</td></tr>';
            }
        }

        async function loadBrands() {
            try {
                console.log('Loading brands...');
                const res = await apiCall('/brands');
                console.log('Brands response status:', res.status);
                if (!res.ok) {
                    console.error('Failed to load brands:', res.status);
                    document.getElementById('brandsTable').innerHTML = '<tr><td colspan="3">Fehler beim Laden</td></tr>';
                    return;
                }
                const brands = await res.json();
                console.log('Loaded brands:', brands);

                // Hide create button for trainers
                const createBrandBtn = document.querySelector('#section-brands .btn-success');
                if (createBrandBtn && currentUser && currentUser.role === 'trainer') {
                    createBrandBtn.style.display = 'none';
                }

                document.getElementById('brandsTable').innerHTML = brands.map(b => `
                    <tr>
                        <td>${b.name || '-'}</td>
                        <td>${b.description || '-'}</td>
                        <td>
                            ${currentUser && currentUser.role !== 'trainer' ? `
                                <button class="btn btn-sm btn-secondary" onclick="showEditModal('brand', ${b.id})" style="margin-right:0.25rem;">Bearbeiten</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteItem('brands', ${b.id})">Löschen</button>
                            ` : ''}
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="3">Keine Marken</td></tr>';
            } catch (err) {
                console.error('Error loading brands:', err);
                document.getElementById('brandsTable').innerHTML = '<tr><td colspan="3">Fehler beim Laden</td></tr>';
            }
        }

        async function loadLocations() {
            try {
                console.log('Loading locations...');
                const res = await apiCall('/locations');
                console.log('Locations response status:', res.status);
                if (!res.ok) {
                    console.error('Failed to load locations:', res.status);
                    document.getElementById('locationsTable').innerHTML = '<tr><td colspan="5">Fehler beim Laden</td></tr>';
                    return;
                }
                const locations = await res.json();
                console.log('Loaded locations:', locations);

                const cateringLabels = { yes: 'Ja', no: 'Nein', external: 'Extern' };

                document.getElementById('locationsTable').innerHTML = locations.map(loc => `
                    <tr>
                        <td>${loc.name || '-'}</td>
                        <td>${loc.city || '-'}</td>
                        <td>${loc.max_participants || '-'}</td>
                        <td>${cateringLabels[loc.catering_available] || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="showEditModal('location', ${loc.id})" style="margin-right:0.25rem;">Bearbeiten</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteItem('locations', ${loc.id})">Löschen</button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="5">Keine Locations</td></tr>';
            } catch (err) {
                console.error('Error loading locations:', err);
                document.getElementById('locationsTable').innerHTML = '<tr><td colspan="5">Fehler beim Laden</td></tr>';
            }
        }

        async function deleteItem(type, id) {
            if (!confirm('Wirklich löschen?')) return;
            const res = await apiCall(`/${type}/${id}`, { method: 'DELETE' });
            if (!res.ok) {
                const error = await res.json().catch(() => ({}));
                alert(error.error || 'Fehler beim Löschen');
                return;
            }
            showSection(type);
        }

        // Predefined specializations for trainers
        const TRAINER_SPECIALIZATIONS = [
            'Leadership', 'Agile/Scrum', 'Project Management', 'Communication',
            'Sales', 'Marketing', 'IT/Software', 'Data Science', 'Cloud/DevOps',
            'Security', 'Change Management', 'Team Building', 'Presentation Skills'
        ];

        const formFields = {
            training: 'custom', // Special handling for extended training form
            customer: 'custom', // Special handling for customer form
            trainer: 'custom', // Special handling for trainer form
            location: 'custom', // Special handling for location form
            brand: [
                { name: 'name', label: 'Name', type: 'text', required: true },
                { name: 'description', label: 'Beschreibung', type: 'textarea' }
            ],
            user: [
                { name: 'username', label: 'Benutzername', type: 'text', required: true },
                { name: 'email', label: 'Email', type: 'email', required: true },
                { name: 'password', label: 'Passwort', type: 'password', required: true },
                { name: 'role', label: 'Rolle', type: 'select', options: ['backoffice_user', 'trainer', 'admin'] },
                { name: 'is_active', label: 'Aktiv', type: 'checkbox' }
            ]
        };

        // Cache for dropdowns
        let cachedBrands = [];
        let cachedCustomers = [];
        let cachedTrainers = [];
        let cachedLocations = [];

        async function loadFormData() {
            const [brandsRes, customersRes, trainersRes, locationsRes] = await Promise.all([
                apiCall('/brands'),
                apiCall('/customers'),
                apiCall('/trainers'),
                apiCall('/locations')
            ]);
            if (brandsRes.ok) cachedBrands = await brandsRes.json();
            if (customersRes.ok) cachedCustomers = await customersRes.json();
            if (trainersRes.ok) cachedTrainers = await trainersRes.json();
            if (locationsRes.ok) cachedLocations = await locationsRes.json();
        }

        // Store form data for inline customer creation
        let savedTrainingFormData = null;

        function generateTrainingForm(data = {}) {
            const durationValue = data.duration_type === 'hours' ? (data.duration_hours || 8) : (data.duration_days || 1);
            return `
                <div class="form-group">
                    <label>Titel *</label>
                    <input type="text" name="title" value="${data.title || ''}" required style="width:100%;padding:0.5rem;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Marke</label>
                        <select name="brand_id" style="width:100%;padding:0.5rem;">
                            <option value="">-- Auswählen --</option>
                            ${cachedBrands.map(b => `<option value="${b.id}" ${data.brand_id == b.id ? 'selected' : ''}>${b.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Kunde</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <select name="customer_id" style="flex:1;padding:0.5rem;">
                                <option value="">-- Auswählen --</option>
                                ${cachedCustomers.map(c => `<option value="${c.id}" ${data.customer_id == c.id ? 'selected' : ''}>${c.company || c.name}</option>`).join('')}
                            </select>
                            <button type="button" onclick="openInlineCustomerCreate()" class="btn btn-sm btn-success" title="Neuen Kunden anlegen">+</button>
                        </div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Trainer</label>
                        <select name="trainer_id" style="width:100%;padding:0.5rem;">
                            <option value="">-- Kein Trainer --</option>
                            ${cachedTrainers.map(t => `<option value="${t.id}" ${data.trainer_id == t.id ? 'selected' : ''}>${t.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select name="status" style="width:100%;padding:0.5rem;">
                            ${['lead', 'appointment_scheduled', 'initial_contact', 'proposal_sent', 'trainer_outreach', 'trainer_confirmed', 'planning', 'delivered', 'invoiced'].map(s =>
                                `<option value="${s}" ${data.status === s ? 'selected' : ''}>${s}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Startdatum</label>
                        <input type="date" name="start_date" value="${data.start_date ? data.start_date.split('T')[0] : ''}" style="width:100%;padding:0.5rem;">
                    </div>
                    <div class="form-group">
                        <label>Enddatum</label>
                        <input type="date" name="end_date" value="${data.end_date ? data.end_date.split('T')[0] : ''}" style="width:100%;padding:0.5rem;">
                    </div>
                    <div class="form-group">
                        <label>Dauer</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="number" name="duration_value" value="${durationValue}" min="1" style="flex:1;padding:0.5rem;" onchange="calculateInternalPrice()">
                            <select name="duration_type" style="width:80px;padding:0.5rem;" onchange="calculateInternalPrice()">
                                <option value="days" ${data.duration_type !== 'hours' ? 'selected' : ''}>Tage</option>
                                <option value="hours" ${data.duration_type === 'hours' ? 'selected' : ''}>Std.</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Zeitraum (Wunschzeitraum des Kunden)</label>
                    <input type="text" name="zeitraum" value="${data.zeitraum || ''}" placeholder="z.B. Q1 2025, März-April, etc." style="width:100%;padding:0.5rem;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Trainingsart</label>
                        <select name="training_type" style="width:100%;padding:0.5rem;">
                            <option value="classroom" ${data.training_type === 'classroom' ? 'selected' : ''}>Präsenz</option>
                            <option value="online" ${data.training_type === 'online' ? 'selected' : ''}>Online</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Format</label>
                        <select name="training_format" style="width:100%;padding:0.5rem;">
                            <option value="inhouse" ${data.training_format === 'inhouse' ? 'selected' : ''}>Inhouse</option>
                            <option value="public" ${data.training_format === 'public' ? 'selected' : ''}>Öffentlich</option>
                        </select>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Location buchen</label>
                        <input type="text" name="location_booking" value="${data.location_booking || ''}" placeholder="z.B. Hotel, Konferenzraum..." style="width:100%;padding:0.5rem;">
                    </div>
                    <div class="form-group">
                        <label>Catering buchen</label>
                        <input type="text" name="catering_booking" value="${data.catering_booking || ''}" placeholder="z.B. Mittagessen, Getränke..." style="width:100%;padding:0.5rem;">
                    </div>
                </div>
                <div class="form-group">
                    <label>Ort</label>
                    <input type="text" name="location" value="${data.location || ''}" style="width:100%;padding:0.5rem;">
                </div>

                <fieldset style="border: 1px solid #ddd; padding: 1rem; margin: 1rem 0; border-radius: 4px;">
                    <legend style="font-weight: 600; padding: 0 0.5rem; color: var(--yb-hellblau);">Kosten & Preise</legend>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Tagessatz Trainer (€)</label>
                            <input type="number" name="tagessatz" id="tagessatz" value="${data.tagessatz || ''}" step="0.01" style="width:100%;padding:0.5rem;" onchange="calculateInternalPrice()">
                        </div>
                        <div class="form-group">
                            <label>Location-Kosten (€)</label>
                            <input type="number" name="location_cost" id="location_cost" value="${data.location_cost || ''}" step="0.01" style="width:100%;padding:0.5rem;" onchange="calculateInternalPrice()">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Catering-Kosten (€)</label>
                            <input type="number" name="catering_cost" id="catering_cost" value="${data.catering_cost || ''}" step="0.01" style="width:100%;padding:0.5rem;" onchange="calculateInternalPrice()">
                        </div>
                        <div class="form-group">
                            <label>Provision (€)</label>
                            <input type="number" name="provision" id="provision" value="${data.provision || ''}" step="0.01" style="width:100%;padding:0.5rem;" onchange="calculateInternalPrice()">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Sonstige Kosten (€)</label>
                        <input type="number" name="other_costs" id="other_costs" value="${data.other_costs || ''}" step="0.01" style="width:100%;padding:0.5rem;" onchange="calculateInternalPrice()">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #ddd;">
                        <div class="form-group">
                            <label><strong>Preis Intern (€)</strong> <small style="color: #666;">(berechnet)</small></label>
                            <input type="number" name="price_internal" id="price_internal" value="${data.price_internal || ''}" step="0.01" style="width:100%;padding:0.5rem;background:#f5f5f5;" readonly>
                        </div>
                        <div class="form-group">
                            <label><strong>Preis Extern (€)</strong></label>
                            <input type="number" name="price_external" id="price_external" value="${data.price_external || ''}" step="0.01" style="width:100%;padding:0.5rem;" onchange="calculatePricePerParticipant()">
                        </div>
                        <div class="form-group">
                            <label><strong>Preis/Teilnehmer (€)</strong></label>
                            <input type="number" name="price_per_participant" id="price_per_participant" value="${data.price_per_participant || ''}" step="0.01" style="width:100%;padding:0.5rem;background:#f5f5f5;" readonly>
                        </div>
                    </div>
                </fieldset>

                <div class="form-group">
                    <label>Max. Teilnehmer</label>
                    <input type="number" name="max_participants" id="max_participants" value="${data.max_participants || ''}" style="width:100%;padding:0.5rem;" onchange="calculatePricePerParticipant()">
                </div>
                <div class="form-group">
                    <label>Interne Notizen</label>
                    <textarea name="internal_notes" style="width:100%;padding:0.5rem;min-height:60px;">${data.internal_notes || ''}</textarea>
                </div>
            `;
        }

        function calculateInternalPrice() {
            const tagessatz = parseFloat(document.getElementById('tagessatz')?.value) || 0;
            const locationCost = parseFloat(document.getElementById('location_cost')?.value) || 0;
            const cateringCost = parseFloat(document.getElementById('catering_cost')?.value) || 0;
            const provision = parseFloat(document.getElementById('provision')?.value) || 0;
            const otherCosts = parseFloat(document.getElementById('other_costs')?.value) || 0;

            // Get duration
            const durationValue = parseFloat(document.querySelector('[name="duration_value"]')?.value) || 1;
            const durationType = document.querySelector('[name="duration_type"]')?.value || 'days';
            const days = durationType === 'hours' ? durationValue / 8 : durationValue;

            // Calculate trainer cost
            const trainerCost = tagessatz * days;

            // Calculate total
            const total = trainerCost + locationCost + cateringCost + provision + otherCosts;

            const priceInternalField = document.getElementById('price_internal');
            if (priceInternalField) {
                priceInternalField.value = total.toFixed(2);
            }
        }

        function calculatePricePerParticipant() {
            const priceExternal = parseFloat(document.getElementById('price_external')?.value) || 0;
            const maxParticipants = parseInt(document.getElementById('max_participants')?.value) || 0;

            const pricePerParticipantField = document.getElementById('price_per_participant');
            if (pricePerParticipantField) {
                if (maxParticipants > 0) {
                    pricePerParticipantField.value = (priceExternal / maxParticipants).toFixed(2);
                } else {
                    pricePerParticipantField.value = '';
                }
            }
        }

        function openInlineCustomerCreate() {
            // Save current training form data
            const form = document.getElementById('createForm');
            const formData = new FormData(form);
            savedTrainingFormData = {};
            for (let [key, value] of formData.entries()) {
                if (key.startsWith('spec_')) {
                    if (!savedTrainingFormData[key]) savedTrainingFormData[key] = [];
                    savedTrainingFormData[key].push(value);
                } else {
                    savedTrainingFormData[key] = value;
                }
            }

            // Show customer form
            document.getElementById('modalTitle').textContent = 'Neuen Kunden anlegen';
            document.getElementById('modalFields').innerHTML = generateCustomerForm() + `
                <input type="hidden" name="return_to_training" value="true">
            `;
            currentFormType = 'customer';
        }

        async function returnToTrainingForm(newCustomerId = null) {
            if (savedTrainingFormData) {
                await loadFormData(); // Reload to get new customer
                if (newCustomerId) {
                    savedTrainingFormData.customer_id = newCustomerId;
                }
                currentFormType = 'training';
                document.getElementById('modalTitle').textContent = 'Training erstellen';
                document.getElementById('modalFields').innerHTML = generateTrainingForm(savedTrainingFormData);
                savedTrainingFormData = null;
            }
        }

        function generateCustomerForm() {
            return `
                <div class="form-group">
                    <label>Firma *</label>
                    <input type="text" name="company_name" required style="width:100%;padding:0.5rem;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Anrede</label>
                        <select name="salutation" style="width:100%;padding:0.5rem;">
                            <option value="">---</option>
                            <option value="Frau">Frau</option>
                            <option value="Herr">Herr</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Vorname</label>
                        <input type="text" name="first_name" style="width:100%;padding:0.5rem;">
                    </div>
                    <div class="form-group">
                        <label>Nachname</label>
                        <input type="text" name="last_name" style="width:100%;padding:0.5rem;">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" name="contact_email" style="width:100%;padding:0.5rem;">
                    </div>
                    <div class="form-group">
                        <label>Telefon</label>
                        <input type="text" name="contact_phone" style="width:100%;padding:0.5rem;">
                    </div>
                </div>
                <div class="form-group">
                    <label>VAT/USt-ID</label>
                    <input type="text" name="vat_number" style="width:100%;padding:0.5rem;">
                </div>
                <fieldset style="border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                    <legend style="font-weight: 600; padding: 0 0.5rem;">Rechnungsadresse</legend>
                    <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Straße</label>
                            <input type="text" name="street" style="width:100%;padding:0.5rem;">
                        </div>
                        <div class="form-group">
                            <label>Nr.</label>
                            <input type="text" name="street_number" style="width:100%;padding:0.5rem;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem;">
                        <div class="form-group">
                            <label>PLZ</label>
                            <input type="text" name="postal_code" style="width:100%;padding:0.5rem;">
                        </div>
                        <div class="form-group">
                            <label>Ort</label>
                            <input type="text" name="city" style="width:100%;padding:0.5rem;">
                        </div>
                    </div>
                </fieldset>
                <div class="form-group">
                    <label>Konditionen</label>
                    <textarea name="conditions" style="width:100%;padding:0.5rem;min-height:60px;" placeholder="Zahlungsbedingungen, Rabatte, etc."></textarea>
                </div>
                <div class="form-group">
                    <label>Kommentar</label>
                    <textarea name="comment" style="width:100%;padding:0.5rem;min-height:80px;"></textarea>
                </div>
            `;
        }

        function generateTrainerForm() {
            return `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Vorname *</label>
                        <input type="text" name="first_name" required style="width:100%;padding:0.5rem;">
                    </div>
                    <div class="form-group">
                        <label>Nachname *</label>
                        <input type="text" name="last_name" required style="width:100%;padding:0.5rem;">
                    </div>
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" name="email" required style="width:100%;padding:0.5rem;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Telefon</label>
                        <input type="text" name="phone" style="width:100%;padding:0.5rem;">
                    </div>
                    <div class="form-group">
                        <label>VAT/USt-ID</label>
                        <input type="text" name="vat_number" style="width:100%;padding:0.5rem;">
                    </div>
                </div>
                <div class="form-group">
                    <label>Adresse</label>
                    <textarea name="address" style="width:100%;padding:0.5rem;min-height:60px;"></textarea>
                </div>
                <div class="form-group">
                    <label>LinkedIn URL</label>
                    <input type="url" name="linkedin_url" placeholder="https://linkedin.com/in/..." style="width:100%;padding:0.5rem;">
                </div>
                <div class="form-group">
                    <label>Webseite</label>
                    <input type="url" name="website" placeholder="https://www.beispiel.de" style="width:100%;padding:0.5rem;">
                </div>
                <div class="form-group">
                    <label>Spezialisierungen</label>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-bottom: 0.5rem;">
                        ${TRAINER_SPECIALIZATIONS.map(spec => `
                            <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal;">
                                <input type="checkbox" name="spec_selected" value="${spec}">
                                ${spec}
                            </label>
                        `).join('')}
                    </div>
                    <div id="customSpecsContainer">
                        <div class="custom-spec-row" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <input type="text" name="spec_custom" placeholder="Eigene Spezialisierung..." style="flex:1;padding:0.5rem;">
                        </div>
                    </div>
                    <button type="button" onclick="addCustomSpecField()" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;">+ Weitere</button>
                </div>
                <div class="form-group">
                    <label>Tagessatz (€)</label>
                    <input type="number" name="default_day_rate" step="0.01" style="width:100%;padding:0.5rem;">
                </div>
                <div class="form-group">
                    <label>Region</label>
                    <input type="text" name="region" style="width:100%;padding:0.5rem;">
                </div>
                <div class="form-group">
                    <label>Bio</label>
                    <textarea name="bio" style="width:100%;padding:0.5rem;min-height:80px;"></textarea>
                </div>
                <div class="form-group">
                    <label>Notizen</label>
                    <textarea name="notes" style="width:100%;padding:0.5rem;min-height:60px;"></textarea>
                </div>
            `;
        }

        function addCustomSpecField() {
            const container = document.getElementById('customSpecsContainer');
            const newRow = document.createElement('div');
            newRow.className = 'custom-spec-row';
            newRow.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem;';
            newRow.innerHTML = `<input type="text" name="spec_custom" placeholder="Eigene Spezialisierung..." style="flex:1;padding:0.5rem;">`;
            container.appendChild(newRow);
        }

        let currentFormType = '';
        let editingId = null;

        async function showCreateModal(type) {
            currentFormType = type;
            editingId = null;
            const titles = { training: 'Training', customer: 'Kunde', trainer: 'Trainer', brand: 'Marke', user: 'Benutzer', location: 'Location' };
            document.getElementById('modalTitle').textContent = `${titles[type]} erstellen`;

            const fields = formFields[type];

            if (fields === 'custom') {
                if (type === 'training') {
                    await loadFormData();
                    document.getElementById('modalFields').innerHTML = generateTrainingForm();
                } else if (type === 'trainer') {
                    document.getElementById('modalFields').innerHTML = generateTrainerForm();
                } else if (type === 'customer') {
                    document.getElementById('modalFields').innerHTML = generateCustomerForm();
                } else if (type === 'location') {
                    document.getElementById('modalFields').innerHTML = generateLocationForm();
                }
            } else {
                document.getElementById('modalFields').innerHTML = fields.map(f => `
                    <div class="form-group">
                        <label>${f.label}</label>
                        ${f.type === 'textarea'
                            ? `<textarea name="${f.name}" style="width:100%;padding:0.5rem;min-height:80px;"></textarea>`
                            : f.type === 'select'
                            ? `<select name="${f.name}" style="width:100%;padding:0.5rem;">
                                ${f.options.map(o => `<option value="${o}">${o}</option>`).join('')}
                               </select>`
                            : f.type === 'checkbox'
                            ? `<input type="checkbox" name="${f.name}" checked>`
                            : `<input type="${f.type}" name="${f.name}" ${f.required ? 'required' : ''} style="width:100%;padding:0.5rem;">`
                        }
                    </div>
                `).join('');
            }

            document.getElementById('createModal').style.display = 'flex';
        }

        async function showEditModal(type, id) {
            currentFormType = type;
            editingId = id;
            const titles = { training: 'Training', customer: 'Kunde', trainer: 'Trainer', brand: 'Marke', location: 'Location' };
            document.getElementById('modalTitle').textContent = `${titles[type]} bearbeiten`;

            // Load the item data
            const res = await apiCall(`/${type}s/${id}`);
            if (!res.ok) {
                alert('Fehler beim Laden');
                return;
            }
            const data = await res.json();

            const fields = formFields[type];

            if (fields === 'custom') {
                if (type === 'training') {
                    await loadFormData();
                    document.getElementById('modalFields').innerHTML = generateTrainingForm(data);
                } else if (type === 'trainer') {
                    document.getElementById('modalFields').innerHTML = generateTrainerFormWithData(data);
                } else if (type === 'customer') {
                    document.getElementById('modalFields').innerHTML = generateCustomerFormWithData(data);
                } else if (type === 'location') {
                    document.getElementById('modalFields').innerHTML = generateLocationFormWithData(data);
                }
            } else {
                document.getElementById('modalFields').innerHTML = fields.map(f => `
                    <div class="form-group">
                        <label>${f.label}</label>
                        ${f.type === 'textarea'
                            ? `<textarea name="${f.name}" style="width:100%;padding:0.5rem;min-height:80px;">${data[f.name] || ''}</textarea>`
                            : f.type === 'select'
                            ? `<select name="${f.name}" style="width:100%;padding:0.5rem;">
                                ${f.options.map(o => `<option value="${o}" ${data[f.name] === o ? 'selected' : ''}>${o}</option>`).join('')}
                               </select>`
                            : f.type === 'checkbox'
                            ? `<input type="checkbox" name="${f.name}" ${data[f.name] ? 'checked' : ''}>`
                            : `<input type="${f.type}" name="${f.name}" value="${data[f.name] || ''}" ${f.required ? 'required' : ''} style="width:100%;padding:0.5rem;">`
                        }
                    </div>
                `).join('');
            }

            document.getElementById('createModal').style.display = 'flex';
        }

        function generateCustomerFormWithData(data) {
            return `
                <div class="form-group">
                    <label>Firma *</label>
                    <input type="text" name="company_name" value="${data.company || ''}" required style="width:100%;padding:0.5rem;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Anrede</label>
                        <select name="salutation" style="width:100%;padding:0.5rem;">
                            <option value="" ${!data.salutation ? 'selected' : ''}>---</option>
                            <option value="Frau" ${data.salutation === 'Frau' ? 'selected' : ''}>Frau</option>
                            <option value="Herr" ${data.salutation === 'Herr' ? 'selected' : ''}>Herr</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Vorname</label>
                        <input type="text" name="first_name" value="${data.first_name || ''}" style="width:100%;padding:0.5rem;">
                    </div>
                    <div class="form-group">
                        <label>Nachname</label>
                        <input type="text" name="last_name" value="${data.last_name || ''}" style="width:100%;padding:0.5rem;">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" name="contact_email" value="${data.email || ''}" style="width:100%;padding:0.5rem;">
                    </div>
                    <div class="form-group">
                        <label>Telefon</label>
                        <input type="text" name="contact_phone" value="${data.phone || ''}" style="width:100%;padding:0.5rem;">
                    </div>
                </div>
                <div class="form-group">
                    <label>VAT/USt-ID</label>
                    <input type="text" name="vat_number" value="${data.vat_number || ''}" style="width:100%;padding:0.5rem;">
                </div>
                <fieldset style="border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                    <legend style="font-weight: 600; padding: 0 0.5rem;">Rechnungsadresse</legend>
                    <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Straße</label>
                            <input type="text" name="street" value="${data.street || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                        <div class="form-group">
                            <label>Nr.</label>
                            <input type="text" name="street_number" value="${data.street_number || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem;">
                        <div class="form-group">
                            <label>PLZ</label>
                            <input type="text" name="postal_code" value="${data.postal_code || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                        <div class="form-group">
                            <label>Ort</label>
                            <input type="text" name="city" value="${data.city || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                    </div>
                </fieldset>
                <div class="form-group">
                    <label>Konditionen</label>
                    <textarea name="conditions" style="width:100%;padding:0.5rem;min-height:60px;">${data.conditions || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Kommentar</label>
                    <textarea name="comment" style="width:100%;padding:0.5rem;min-height:80px;">${data.comment || ''}</textarea>
                </div>
            `;
        }

        function generateLocationForm() {
            return generateLocationFormWithData({});
        }

        function generateLocationFormWithData(data) {
            return `
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" name="name" value="${data.name || ''}" required style="width:100%;padding:0.5rem;">
                </div>

                <fieldset style="border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                    <legend style="font-weight: 600; padding: 0 0.5rem;">Adresse</legend>
                    <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Straße</label>
                            <input type="text" name="street" value="${data.street || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                        <div class="form-group">
                            <label>Nr.</label>
                            <input type="text" name="street_number" value="${data.street_number || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem;">
                        <div class="form-group">
                            <label>PLZ</label>
                            <input type="text" name="postal_code" value="${data.postal_code || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                        <div class="form-group">
                            <label>Ort</label>
                            <input type="text" name="city" value="${data.city || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                    </div>
                </fieldset>

                <fieldset style="border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                    <legend style="font-weight: 600; padding: 0 0.5rem;">Rechnungsadresse</legend>
                    <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Straße</label>
                            <input type="text" name="billing_street" value="${data.billing_street || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                        <div class="form-group">
                            <label>Nr.</label>
                            <input type="text" name="billing_street_number" value="${data.billing_street_number || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem;">
                        <div class="form-group">
                            <label>PLZ</label>
                            <input type="text" name="billing_postal_code" value="${data.billing_postal_code || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                        <div class="form-group">
                            <label>Ort</label>
                            <input type="text" name="billing_city" value="${data.billing_city || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>VAT/USt-ID</label>
                        <input type="text" name="billing_vat" value="${data.billing_vat || ''}" style="width:100%;padding:0.5rem;">
                    </div>
                </fieldset>

                <fieldset style="border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                    <legend style="font-weight: 600; padding: 0 0.5rem;">Ansprechpartner</legend>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Vorname</label>
                            <input type="text" name="contact_first_name" value="${data.contact_first_name || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                        <div class="form-group">
                            <label>Nachname</label>
                            <input type="text" name="contact_last_name" value="${data.contact_last_name || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" name="contact_email" value="${data.contact_email || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                        <div class="form-group">
                            <label>Telefon</label>
                            <input type="text" name="contact_phone" value="${data.contact_phone || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Hinweise</label>
                        <textarea name="contact_notes" style="width:100%;padding:0.5rem;min-height:60px;">${data.contact_notes || ''}</textarea>
                    </div>
                </fieldset>

                <fieldset style="border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                    <legend style="font-weight: 600; padding: 0 0.5rem;">Location Details</legend>
                    <div class="form-group">
                        <label>Location Beschreibung</label>
                        <textarea name="description" style="width:100%;padding:0.5rem;min-height:80px;">${data.description || ''}</textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Max Teilnehmer</label>
                            <input type="number" name="max_participants" value="${data.max_participants || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                        <div class="form-group">
                            <label>Catering vorhanden</label>
                            <select name="catering_available" style="width:100%;padding:0.5rem;">
                                <option value="no" ${data.catering_available === 'no' || !data.catering_available ? 'selected' : ''}>Nein</option>
                                <option value="yes" ${data.catering_available === 'yes' ? 'selected' : ''}>Ja</option>
                                <option value="external" ${data.catering_available === 'external' ? 'selected' : ''}>Extern</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Features</label>
                        <textarea name="features" style="width:100%;padding:0.5rem;min-height:60px;" placeholder="z.B. Beamer, Whiteboard, WLAN...">${data.features || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Link zur Location</label>
                        <input type="url" name="website_link" value="${data.website_link || ''}" style="width:100%;padding:0.5rem;" placeholder="https://...">
                    </div>
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Mietkosten (€)</label>
                            <input type="number" name="rental_cost" value="${data.rental_cost || ''}" step="0.01" style="width:100%;padding:0.5rem;">
                        </div>
                        <div class="form-group">
                            <label>Kosten pro</label>
                            <select name="rental_cost_type" style="width:100%;padding:0.5rem;">
                                <option value="day" ${data.rental_cost_type === 'day' || !data.rental_cost_type ? 'selected' : ''}>Tag</option>
                                <option value="hour" ${data.rental_cost_type === 'hour' ? 'selected' : ''}>Stunde</option>
                                <option value="total" ${data.rental_cost_type === 'total' ? 'selected' : ''}>Gesamt</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Parken</label>
                        <textarea name="parking" style="width:100%;padding:0.5rem;min-height:60px;">${data.parking || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Anreise</label>
                        <textarea name="directions" style="width:100%;padding:0.5rem;min-height:60px;">${data.directions || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Informationen für TN</label>
                        <textarea name="participant_info" style="width:100%;padding:0.5rem;min-height:80px;">${data.participant_info || ''}</textarea>
                    </div>
                </fieldset>
            `;
        }

        function generateTrainerFormWithData(data) {
            const specs = data.specializations || {selected: [], custom: []};
            return `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Vorname *</label>
                        <input type="text" name="first_name" value="${data.first_name || ''}" required style="width:100%;padding:0.5rem;">
                    </div>
                    <div class="form-group">
                        <label>Nachname *</label>
                        <input type="text" name="last_name" value="${data.last_name || ''}" required style="width:100%;padding:0.5rem;">
                    </div>
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" name="email" value="${data.email || ''}" required style="width:100%;padding:0.5rem;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Telefon</label>
                        <input type="text" name="phone" value="${data.phone || ''}" style="width:100%;padding:0.5rem;">
                    </div>
                    <div class="form-group">
                        <label>VAT/USt-ID</label>
                        <input type="text" name="vat_number" value="${data.vat_number || ''}" style="width:100%;padding:0.5rem;">
                    </div>
                </div>
                <div class="form-group">
                    <label>Adresse</label>
                    <textarea name="address" style="width:100%;padding:0.5rem;min-height:60px;">${data.address || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>LinkedIn URL</label>
                    <input type="url" name="linkedin_url" value="${data.linkedin_url || ''}" style="width:100%;padding:0.5rem;">
                </div>
                <div class="form-group">
                    <label>Webseite</label>
                    <input type="url" name="website" value="${data.website || ''}" style="width:100%;padding:0.5rem;">
                </div>
                <div class="form-group">
                    <label>Spezialisierungen</label>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-bottom: 0.5rem;">
                        ${TRAINER_SPECIALIZATIONS.map(spec => `
                            <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal;">
                                <input type="checkbox" name="spec_selected" value="${spec}" ${specs.selected && specs.selected.includes(spec) ? 'checked' : ''}>
                                ${spec}
                            </label>
                        `).join('')}
                    </div>
                    <div id="customSpecsContainer">
                        ${(specs.custom || []).map(c => `
                            <div class="custom-spec-row" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <input type="text" name="spec_custom" value="${c}" style="flex:1;padding:0.5rem;">
                            </div>
                        `).join('')}
                        <div class="custom-spec-row" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <input type="text" name="spec_custom" placeholder="Eigene Spezialisierung..." style="flex:1;padding:0.5rem;">
                        </div>
                    </div>
                    <button type="button" onclick="addCustomSpecField()" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;">+ Weitere</button>
                </div>
                <div class="form-group">
                    <label>Tagessatz (€)</label>
                    <input type="number" name="default_day_rate" value="${data.default_day_rate || ''}" step="0.01" style="width:100%;padding:0.5rem;">
                </div>
                <div class="form-group">
                    <label>Region</label>
                    <input type="text" name="region" value="${data.region || ''}" style="width:100%;padding:0.5rem;">
                </div>
                <div class="form-group">
                    <label>Bio</label>
                    <textarea name="bio" style="width:100%;padding:0.5rem;min-height:80px;">${data.bio || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Notizen</label>
                    <textarea name="notes" style="width:100%;padding:0.5rem;min-height:60px;">${data.notes || ''}</textarea>
                </div>
            `;
        }

        function closeModal() {
            document.getElementById('createModal').style.display = 'none';
        }

        document.getElementById('createForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            let data = {};

            const endpoints = { training: 'trainings', customer: 'customers', trainer: 'trainers', brand: 'brands', user: 'auth/register', location: 'locations' };

            if (currentFormType === 'training') {
                // Handle training form with all extended fields
                const durationValue = parseFloat(formData.get('duration_value')) || 1;
                const durationType = formData.get('duration_type') || 'days';

                data = {
                    title: formData.get('title'),
                    brand_id: formData.get('brand_id') ? parseInt(formData.get('brand_id')) : null,
                    customer_id: formData.get('customer_id') ? parseInt(formData.get('customer_id')) : null,
                    trainer_id: formData.get('trainer_id') ? parseInt(formData.get('trainer_id')) : null,
                    status: formData.get('status'),
                    start_date: formData.get('start_date') || null,
                    end_date: formData.get('end_date') || null,
                    duration_days: durationType === 'days' ? durationValue : Math.ceil(durationValue / 8),
                    duration_hours: durationType === 'hours' ? durationValue : durationValue * 8,
                    duration_type: durationType,
                    zeitraum: formData.get('zeitraum') || null,
                    training_type: formData.get('training_type'),
                    training_format: formData.get('training_format'),
                    location: formData.get('location'),
                    location_booking: formData.get('location_booking') || null,
                    catering_booking: formData.get('catering_booking') || null,
                    tagessatz: formData.get('tagessatz') ? parseFloat(formData.get('tagessatz')) : null,
                    location_cost: formData.get('location_cost') ? parseFloat(formData.get('location_cost')) : null,
                    catering_cost: formData.get('catering_cost') ? parseFloat(formData.get('catering_cost')) : null,
                    provision: formData.get('provision') ? parseFloat(formData.get('provision')) : null,
                    other_costs: formData.get('other_costs') ? parseFloat(formData.get('other_costs')) : null,
                    price_external: formData.get('price_external') ? parseFloat(formData.get('price_external')) : null,
                    price_internal: formData.get('price_internal') ? parseFloat(formData.get('price_internal')) : null,
                    price_per_participant: formData.get('price_per_participant') ? parseFloat(formData.get('price_per_participant')) : null,
                    max_participants: formData.get('max_participants') ? parseInt(formData.get('max_participants')) : null,
                    language: formData.get('language') || null,
                    online_link: formData.get('online_link') || null,
                    internal_notes: formData.get('internal_notes')
                };
            } else if (currentFormType === 'trainer') {
                // Handle trainer form specially
                data = {
                    first_name: formData.get('first_name'),
                    last_name: formData.get('last_name'),
                    email: formData.get('email'),
                    phone: formData.get('phone'),
                    address: formData.get('address'),
                    vat_number: formData.get('vat_number'),
                    linkedin_url: formData.get('linkedin_url'),
                    website: formData.get('website'),
                    default_day_rate: formData.get('default_day_rate') ? parseFloat(formData.get('default_day_rate')) : null,
                    region: formData.get('region'),
                    bio: formData.get('bio'),
                    notes: formData.get('notes'),
                    specializations: {
                        selected: formData.getAll('spec_selected'),
                        custom: formData.getAll('spec_custom').filter(s => s.trim() !== '')
                    }
                };
            } else if (currentFormType === 'customer') {
                // Handle customer form specially
                data = {
                    company_name: formData.get('company_name'),
                    first_name: formData.get('first_name'),
                    last_name: formData.get('last_name'),
                    salutation: formData.get('salutation'),
                    contact_email: formData.get('contact_email'),
                    contact_phone: formData.get('contact_phone'),
                    vat_number: formData.get('vat_number'),
                    street: formData.get('street'),
                    street_number: formData.get('street_number'),
                    postal_code: formData.get('postal_code'),
                    city: formData.get('city'),
                    conditions: formData.get('conditions'),
                    comment: formData.get('comment')
                };
            } else if (currentFormType === 'location') {
                // Handle location form
                data = {
                    name: formData.get('name'),
                    city: formData.get('city'),
                    street: formData.get('street'),
                    street_number: formData.get('street_number'),
                    postal_code: formData.get('postal_code'),
                    billing_street: formData.get('billing_street'),
                    billing_street_number: formData.get('billing_street_number'),
                    billing_postal_code: formData.get('billing_postal_code'),
                    billing_city: formData.get('billing_city'),
                    billing_vat: formData.get('billing_vat'),
                    contact_first_name: formData.get('contact_first_name'),
                    contact_last_name: formData.get('contact_last_name'),
                    contact_email: formData.get('contact_email'),
                    contact_phone: formData.get('contact_phone'),
                    contact_notes: formData.get('contact_notes'),
                    description: formData.get('description'),
                    max_participants: formData.get('max_participants') ? parseInt(formData.get('max_participants')) : null,
                    features: formData.get('features'),
                    website_link: formData.get('website_link'),
                    catering_available: formData.get('catering_available'),
                    rental_cost: formData.get('rental_cost') ? parseFloat(formData.get('rental_cost')) : null,
                    rental_cost_type: formData.get('rental_cost_type'),
                    parking: formData.get('parking'),
                    directions: formData.get('directions'),
                    participant_info: formData.get('participant_info')
                };
            } else if (currentFormType === 'user') {
                // Handle user form - checkbox needs special handling
                data = {
                    username: formData.get('username'),
                    email: formData.get('email'),
                    password: formData.get('password'),
                    role: formData.get('role'),
                    is_active: formData.get('is_active') === 'on'
                };
            } else {
                data = Object.fromEntries(formData);
            }

            // Determine if this is create or update
            const isUpdate = editingId !== null;
            let url = `/${endpoints[currentFormType]}`;
            let method = 'POST';

            if (isUpdate) {
                url = `/${endpoints[currentFormType]}/${editingId}`;
                method = 'PUT';
            }

            const res = await apiCall(url, {
                method: method,
                body: JSON.stringify(data)
            });

            console.log(`${isUpdate ? 'Update' : 'Create'} response status:`, res.status);

            if (!res.ok) {
                const error = await res.json().catch(() => ({}));
                console.error(`${isUpdate ? 'Update' : 'Create'} error:`, error);
                alert(error.error || 'Fehler beim Speichern');
                return;
            }

            const result = await res.json();
            console.log(`${isUpdate ? 'Updated' : 'Created'} item:`, result);

            // Check if we need to return to training form after creating customer
            if (currentFormType === 'customer' && formData.get('return_to_training') === 'true') {
                await returnToTrainingForm(result.id);
                return;
            }

            closeModal();
            // Special handling for users section name
            const sectionName = currentFormType === 'user' ? 'users' : endpoints[currentFormType];
            console.log('Refreshing section:', sectionName);
            showSection(sectionName);
        });
    </script>
</body>
</html>
