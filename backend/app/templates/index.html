<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yellow-Boat Academy</title>
    <style>
        :root {
            --yb-hellblau: #488BCB;
            --yb-gelb: #FDD850;
            --yb-grau: #939597;
            --yb-grau-light: #A4B1BA;
            --yb-hellblau-light: #6ba3d6;
            --yb-hellblau-dark: #3a7ab8;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #e8f1f8; }

        /* Login */
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, var(--yb-hellblau) 0%, var(--yb-hellblau-light) 100%); }
        .login-box { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); width: 100%; max-width: 400px; }
        .login-box h1 { margin-bottom: 1.5rem; color: var(--yb-hellblau); text-align: center; }
        .login-logo { display: block; margin: 0 auto 1rem; max-width: 120px; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--yb-grau); }
        .form-group input { width: 100%; padding: 0.75rem; border: 1px solid var(--yb-grau-light); border-radius: 4px; font-size: 1rem; }
        .form-group input:focus { outline: none; border-color: var(--yb-hellblau); box-shadow: 0 0 0 2px rgba(72, 139, 203, 0.2); }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; transition: all 0.2s; }
        .btn-primary { background: var(--yb-gelb); color: #333; width: 100%; font-weight: 600; }
        .btn-primary:hover { background: #f5cc3a; transform: translateY(-1px); }
        .error { color: #dc3545; margin-top: 1rem; }

        /* Dashboard */
        .app-container { display: none; }
        .header { background: var(--yb-hellblau); color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.5rem; display: flex; align-items: center; gap: 0.75rem; }
        .header-logo { height: 36px; }
        .user-info { display: flex; align-items: center; gap: 1rem; }
        .btn-logout { background: rgba(255,255,255,0.2); color: white; padding: 0.5rem 1rem; border: 1px solid rgba(255,255,255,0.3); }
        .btn-logout:hover { background: rgba(255,255,255,0.3); }

        .main-content { display: flex; min-height: calc(100vh - 60px); }
        .sidebar { width: 250px; background: white; border-right: 1px solid #ddd; padding: 1rem 0; }
        .sidebar a { display: block; padding: 0.75rem 1.5rem; color: var(--yb-grau); text-decoration: none; transition: all 0.2s; }
        .sidebar a:hover, .sidebar a.active { background: #e8f1f8; border-left: 3px solid var(--yb-gelb); color: var(--yb-hellblau); }

        .content { flex: 1; padding: 2rem; background: #e8f1f8; }
        .card { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 1rem; }
        .card-header { padding: 1rem 1.5rem; border-bottom: 1px solid #ddd; font-weight: 600; display: flex; justify-content: space-between; align-items: center; color: var(--yb-hellblau); }
        .card-body { padding: 1.5rem; }

        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #ddd; }
        th { font-weight: 600; background: #f8f9fa; color: var(--yb-grau); }

        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
        .btn-success { background: var(--yb-gelb); color: #333; font-weight: 500; }
        .btn-success:hover { background: #f5cc3a; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: var(--yb-grau-light); color: white; }

        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-top: 3px solid var(--yb-gelb); }
        .stat-card h3 { font-size: 2rem; color: var(--yb-hellblau); }
        .stat-card p { color: var(--yb-grau); margin-top: 0.5rem; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(72, 139, 203, 0.5); justify-content: center; align-items: center; overflow-y: auto; padding: 2rem 0; }
        .modal-content { background: white; padding: 2rem; border-radius: 8px; width: 100%; max-width: 700px; max-height: 90vh; overflow-y: auto; margin: auto; }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 1rem; color: var(--yb-hellblau); }
        .close { cursor: pointer; font-size: 1.5rem; color: var(--yb-grau); }
        .close:hover { color: var(--yb-hellblau); }

        /* Additional Yellow-Boat styling */
        h2 { color: var(--yb-hellblau); }
        .badge { background: var(--yb-hellblau) !important; }

        /* Notification Bell and Messages */
        .notification-bell {
            position: relative;
            cursor: pointer;
            font-size: 1.25rem;
            color: white;
            padding: 0.5rem;
        }
        .notification-bell:hover {
            color: var(--yb-gelb);
        }
        .notification-badge {
            position: absolute;
            top: 0;
            right: 0;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .btn-error-report {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 0.4rem 0.8rem;
            border: 1px solid rgba(255,255,255,0.3);
            font-size: 0.85rem;
        }
        .btn-error-report:hover {
            background: rgba(255,255,255,0.3);
        }
        .message-unread {
            font-weight: bold;
            background: #f0f7ff;
        }
        .message-item {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }
        .message-item:hover {
            background: #f5f5f5;
        }
        .message-item:last-child {
            border-bottom: none;
        }
        .message-meta {
            font-size: 0.85rem;
            color: var(--yb-grau);
            margin-top: 0.5rem;
        }
        .message-status {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }
        .status-open { background: #ffc107; color: #333; }
        .status-solved { background: #28a745; color: white; }
        .status-not_solvable { background: #6c757d; color: white; }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-box" id="loginBox">
            <img src="https://www.yellow-boat.com/wp-content/uploads/2016/10/yellowBoatLogoico.png" alt="Yellow-Boat Academy" class="login-logo">
            <h1>Yellow-Boat Academy</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Benutzername / E-Mail</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Passwort</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn btn-primary">Anmelden</button>
                <div class="error" id="loginError"></div>
            </form>
            <div style="margin-top: 1.5rem; text-align: center; border-top: 1px solid #ddd; padding-top: 1rem;">
                <a href="#" onclick="showTrainerApplicationForm()" style="color: var(--yb-hellblau); text-decoration: none;">Als Trainer bewerben</a>
            </div>
        </div>

        <!-- Trainer Application Form - Step 1 -->
        <div class="login-box" id="applicationStep1" style="display: none; max-width: 500px;">
            <img src="https://www.yellow-boat.com/wp-content/uploads/2016/10/yellowBoatLogoico.png" alt="Yellow-Boat Academy" class="login-logo">
            <h1 style="font-size: 1.3rem;">Trainer-Bewerbung</h1>
            <p style="text-align: center; color: #666; margin-bottom: 1rem;">Schritt 1 von 2</p>
            <form id="applicationFormStep1">
                <fieldset style="border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                    <legend style="font-weight: 600; padding: 0 0.5rem; color: var(--yb-hellblau);">Login-Daten</legend>
                    <div class="form-group">
                        <label>E-Mail-Adresse * (wird auch als Benutzername verwendet)</label>
                        <input type="email" name="email" id="appEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Passwort *</label>
                        <input type="password" name="password" id="appPassword" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label>Passwort best√§tigen *</label>
                        <input type="password" name="password_confirm" id="appPasswordConfirm" required minlength="6">
                    </div>
                </fieldset>

                <fieldset style="border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                    <legend style="font-weight: 600; padding: 0 0.5rem; color: var(--yb-hellblau);">Pers√∂nliche Daten</legend>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Vorname *</label>
                            <input type="text" name="first_name" id="appFirstName" required>
                        </div>
                        <div class="form-group">
                            <label>Nachname *</label>
                            <input type="text" name="last_name" id="appLastName" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Telefon *</label>
                        <input type="tel" name="phone" id="appPhone" required>
                    </div>
                </fieldset>

                <button type="submit" class="btn btn-primary">Weiter zu Schritt 2</button>
                <div class="error" id="applicationError1"></div>
            </form>
            <div style="margin-top: 1rem; text-align: center;">
                <a href="#" onclick="showLoginForm()" style="color: var(--yb-hellblau); text-decoration: none;">Zur√ºck zum Login</a>
            </div>
        </div>

        <!-- Trainer Application Form - Step 2 -->
        <div class="login-box" id="applicationStep2" style="display: none; max-width: 700px;">
            <img src="https://www.yellow-boat.com/wp-content/uploads/2016/10/yellowBoatLogoico.png" alt="Yellow-Boat Academy" class="login-logo">
            <h1 style="font-size: 1.3rem;">Trainer-Bewerbung</h1>
            <p style="text-align: center; color: #666; margin-bottom: 1rem;">Schritt 2 von 2</p>
            <form id="applicationFormStep2">
                <fieldset style="border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                    <legend style="font-weight: 600; padding: 0 0.5rem; color: var(--yb-hellblau);">Adresse</legend>
                    <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Stra√üe</label>
                            <input type="text" name="street">
                        </div>
                        <div class="form-group">
                            <label>Hausnr.</label>
                            <input type="text" name="house_number">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem;">
                        <div class="form-group">
                            <label>PLZ</label>
                            <input type="text" name="postal_code">
                        </div>
                        <div class="form-group">
                            <label>Ort</label>
                            <input type="text" name="city">
                        </div>
                    </div>
                </fieldset>

                <fieldset style="border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                    <legend style="font-weight: 600; padding: 0 0.5rem; color: var(--yb-hellblau);">Berufliche Informationen</legend>
                    <div class="form-group">
                        <label>Region</label>
                        <input type="text" name="region" placeholder="z.B. Bayern, NRW">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>USt-IdNr.</label>
                            <input type="text" name="vat_number">
                        </div>
                        <div class="form-group">
                            <label>Kontonummer / IBAN</label>
                            <input type="text" name="bank_account" placeholder="DE...">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Weitere Informationen</label>
                        <textarea name="additional_info" style="width:100%; min-height: 100px;" placeholder="Beschreiben Sie Ihre Erfahrung und Qualifikationen..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Spezialisierungen (kommagetrennt)</label>
                        <input type="text" name="specializations" placeholder="z.B. Agile, Scrum, Leadership">
                    </div>
                    <div class="form-group">
                        <label>LinkedIn Profil</label>
                        <div style="display: flex; align-items: center;">
                            <span style="background: #e9ecef; padding: 0.5rem; border: 1px solid #ced4da; border-right: none; border-radius: 4px 0 0 4px; font-size: 0.85rem; white-space: nowrap;">linkedin.com/in/</span>
                            <input type="text" name="linkedin_url" placeholder="ihr-profil" style="border-radius: 0 4px 4px 0; flex: 1;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Website</label>
                        <div style="display: flex; align-items: center;">
                            <span style="background: #e9ecef; padding: 0.5rem; border: 1px solid #ced4da; border-right: none; border-radius: 4px 0 0 4px; font-size: 0.85rem; white-space: nowrap;">https://</span>
                            <input type="text" name="website" placeholder="www.ihre-website.de" style="border-radius: 0 4px 4px 0; flex: 1;">
                        </div>
                    </div>
                </fieldset>

                <fieldset style="border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                    <legend style="font-weight: 600; padding: 0 0.5rem; color: var(--yb-hellblau);">Meine Trainings die ich zus√§tzlich anbiete</legend>
                    <p style="font-size: 0.85rem; color: #666; margin-bottom: 1rem;">
                        Sie k√∂nnen, sofern gew√ºnscht, bis zu 10 EIGENE Trainings eintragen, die Yellow-Boat und die Submarken in eigenem Namen anbieten werden. Sie erhalten bevorzugt den Zuschlag bei Anfragen. In Einzelf√§llen kann, davon abweichend, ein anderer Trainer beauftragt werden, sofern hierf√ºr triftige Gr√ºnde vorliegen. Das stellt jedoch eine seltene Ausnahme dar. Der angeforderte Angebotspreis ist rein informativ und kann nicht zugesichert werden. Dies erfolgt in direkter Absprache sobald ein Lead f√ºr das entsprechende Training vorliegt.
                    </p>
                    <div id="trainingsContainer">
                        <!-- Training entries will be added here dynamically -->
                    </div>
                    <button type="button" class="btn btn-success" id="addTrainingBtn" onclick="addNewTraining()" style="margin-top: 0.5rem;">
                        + Training hinzuf√ºgen
                    </button>
                </fieldset>

                <div style="display: flex; gap: 1rem;">
                    <button type="button" class="btn" style="background: #6c757d; color: white;" onclick="goBackToStep1()">Zur√ºck</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Bewerbung absenden</button>
                </div>
                <div class="error" id="applicationError2"></div>
            </form>
            <div style="margin-top: 1rem; text-align: center;">
                <a href="#" onclick="showLoginForm()" style="color: var(--yb-hellblau); text-decoration: none;">Abbrechen</a>
            </div>
        </div>
    </div>

    <!-- App -->
    <div class="app-container" id="appContainer">
        <header class="header">
            <h1>
                <img src="https://www.yellow-boat.com/wp-content/uploads/2016/10/yellowBoatLogoico.png" alt="Yellow-Boat" class="header-logo">
                Yellow-Boat Academy
            </h1>
            <div class="user-info">
                <button class="btn btn-error-report" onclick="showErrorReportModal()">‚ö† Fehler melden</button>
                <div class="notification-bell" onclick="showSection('messages')" title="Nachrichten">
                    üîî
                    <span class="notification-badge" id="unreadBadge" style="display:none;">0</span>
                </div>
                <span id="currentUser"></span>
                <button class="btn btn-logout" onclick="logout()">Abmelden</button>
            </div>
        </header>

        <div class="main-content">
            <nav class="sidebar">
                <a href="#" onclick="showSection('dashboard')" class="active" data-section="dashboard">Dashboard</a>
                <a href="#" onclick="showSection('trainings')" data-section="trainings">Trainings</a>
                <a href="#" onclick="showSection('customers')" data-section="customers">Kunden</a>
                <a href="#" onclick="showSection('trainers')" data-section="trainers">Trainer</a>
                <a href="#" onclick="showSection('brands')" data-section="brands">Marken</a>
                <a href="#" onclick="showSection('locations')" data-section="locations">Locations</a>
                <a href="#" onclick="showSection('messages')" data-section="messages">Nachrichten</a>
                <div id="adminNav" style="display:none; border-top: 1px solid #ddd; margin-top: 1rem; padding-top: 1rem;">
                    <small style="padding: 0 1.5rem; color: #6c757d;">Admin</small>
                    <a href="#" onclick="showSection('users')" data-section="users">Benutzer</a>
                    <a href="#" onclick="showSection('training-applications')" data-section="training-applications">Trainer-Bewerbungen</a>
                </div>
                <div id="trainerNav" style="display:none; border-top: 1px solid #ddd; margin-top: 1rem; padding-top: 1rem;">
                    <small style="padding: 0 1.5rem; color: #6c757d;">Trainer Portal</small>
                    <a href="#" onclick="showSection('trainer-dashboard')" data-section="trainer-dashboard">Mein Dashboard</a>
                    <a href="#" onclick="showSection('my-profile')" data-section="my-profile">Mein Profil</a>
                    <a href="#" onclick="showSection('open-trainings')" data-section="open-trainings">Offene Trainings</a>
                </div>
            </nav>

            <main class="content">
                <!-- Dashboard -->
                <div id="section-dashboard" class="section">
                    <h2>Dashboard</h2>
                    <div class="stats" id="dashboardStats">
                        <div class="stat-card">
                            <h3 id="statTrainings">-</h3>
                            <p>Trainings</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="statCustomers">-</h3>
                            <p>Kunden</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="statTrainers">-</h3>
                            <p>Trainer</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="statBrands">-</h3>
                            <p>Marken</p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">Letzte Trainings</div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr><th>Titel</th><th>Status</th><th>Datum</th></tr>
                                </thead>
                                <tbody id="recentTrainings"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Trainings -->
                <div id="section-trainings" class="section" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            Trainings
                            <button class="btn btn-sm btn-success" onclick="showCreateModal('training')">+ Neu</button>
                        </div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr><th>Titel</th><th>Status</th><th>Datum</th><th>Aktionen</th></tr>
                                </thead>
                                <tbody id="trainingsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Customers -->
                <div id="section-customers" class="section" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            Kunden
                            <button class="btn btn-sm btn-success" onclick="showCreateModal('customer')">+ Neu</button>
                        </div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr><th>Name</th><th>Email</th><th>Firma</th><th>Aktionen</th></tr>
                                </thead>
                                <tbody id="customersTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Trainers -->
                <div id="section-trainers" class="section" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            Trainer
                            <button class="btn btn-sm btn-success" onclick="showCreateModal('trainer')">+ Neu</button>
                        </div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr><th>Name</th><th>Email</th><th>Spezialisierung</th><th>Aktionen</th></tr>
                                </thead>
                                <tbody id="trainersTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Brands -->
                <div id="section-brands" class="section" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            Marken
                            <button class="btn btn-sm btn-success" onclick="showCreateModal('brand')">+ Neu</button>
                        </div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr><th>Name</th><th>Beschreibung</th><th>Aktionen</th></tr>
                                </thead>
                                <tbody id="brandsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Locations -->
                <div id="section-locations" class="section" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            Locations
                            <button class="btn btn-sm btn-success" onclick="showCreateModal('location')">+ Neu</button>
                        </div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Ort</th>
                                        <th>Max TN</th>
                                        <th>Catering</th>
                                        <th>Aktionen</th>
                                    </tr>
                                </thead>
                                <tbody id="locationsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Users (Admin only) -->
                <div id="section-users" class="section" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            Benutzer verwalten
                            <button class="btn btn-sm btn-success" onclick="showCreateModal('user')">+ Neuer Benutzer</button>
                        </div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr><th>Benutzername</th><th>Email</th><th>Rolle</th><th>Status</th><th>Trainer-Profil</th><th>Aktionen</th></tr>
                                </thead>
                                <tbody id="usersTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Training Applications (Admin only) -->
                <div id="section-training-applications" class="section" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            Trainer-Bewerbungen f√ºr Trainings
                        </div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Trainer</th>
                                        <th>Training</th>
                                        <th>Tagessatz</th>
                                        <th>Nachricht</th>
                                        <th>Status</th>
                                        <th>Datum</th>
                                        <th>Aktionen</th>
                                    </tr>
                                </thead>
                                <tbody id="trainingApplicationsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Trainer Dashboard -->
                <div id="section-trainer-dashboard" class="section" style="display:none;">
                    <h2>Mein Trainer Dashboard</h2>
                    <div class="stats" id="trainerStats">
                        <div class="stat-card">
                            <h3 id="statMyTrainings">-</h3>
                            <p>Meine Trainings</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="statCompleted">-</h3>
                            <p>Abgeschlossen</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="statEarnings">-</h3>
                            <p>Verdienst (‚Ç¨)</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="statPendingApps">-</h3>
                            <p>Offene Bewerbungen</p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">Meine letzten Trainings</div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr><th>Titel / Ort</th><th>Datum</th><th>Status</th><th>Aktionen</th></tr>
                                </thead>
                                <tbody id="myTrainingsTable"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card" style="margin-top: 1rem;">
                        <div class="card-header">Meine Bewerbungen</div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr><th>Training</th><th>Tagessatz</th><th>Nachricht</th><th>Status</th><th>Datum</th><th>Aktionen</th></tr>
                                </thead>
                                <tbody id="myApplicationsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Open Trainings for Application -->
                <div id="section-open-trainings" class="section" style="display:none;">
                    <h2>Offene Trainings</h2>
                    <p style="color: #6c757d; margin-bottom: 1rem;">Hier findest du Trainings, auf die du dich bewerben kannst.</p>
                    <div id="openTrainingsList"></div>
                </div>

                <!-- My Profile (Trainer) -->
                <div id="section-my-profile" class="section" style="display:none;">
                    <h2>Mein Profil</h2>
                    <div class="card">
                        <div class="card-body">
                            <form id="myProfileForm">
                                <div style="display: flex; gap: 2rem; margin-bottom: 1.5rem;">
                                    <div style="flex-shrink: 0;">
                                        <div id="profilePhotoPreview" style="width: 150px; height: 150px; border-radius: 50%; background: #e9ecef; display: flex; align-items: center; justify-content: center; overflow: hidden; margin-bottom: 0.5rem;">
                                            <span style="color: #6c757d;">Kein Foto</span>
                                        </div>
                                        <input type="file" id="profilePhotoInput" accept="image/*" style="display: none;" onchange="previewProfilePhoto(this)">
                                        <button type="button" class="btn btn-sm btn-secondary" onclick="document.getElementById('profilePhotoInput').click()" style="width: 100%;">Foto √§ndern</button>
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                            <div class="form-group">
                                                <label>Vorname *</label>
                                                <input type="text" name="first_name" id="profile_first_name" required style="width:100%;padding:0.5rem;">
                                            </div>
                                            <div class="form-group">
                                                <label>Nachname *</label>
                                                <input type="text" name="last_name" id="profile_last_name" required style="width:100%;padding:0.5rem;">
                                            </div>
                                        </div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                            <div class="form-group">
                                                <label>Email *</label>
                                                <input type="email" name="email" id="profile_email" required style="width:100%;padding:0.5rem;">
                                            </div>
                                            <div class="form-group">
                                                <label>Telefon</label>
                                                <input type="text" name="phone" id="profile_phone" style="width:100%;padding:0.5rem;">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label>Stra√üe</label>
                                        <input type="text" name="street" id="profile_street" style="width:100%;padding:0.5rem;">
                                    </div>
                                    <div class="form-group">
                                        <label>Hausnr.</label>
                                        <input type="text" name="house_number" id="profile_house_number" style="width:100%;padding:0.5rem;">
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label>PLZ</label>
                                        <input type="text" name="postal_code" id="profile_postal_code" style="width:100%;padding:0.5rem;">
                                    </div>
                                    <div class="form-group">
                                        <label>Ort</label>
                                        <input type="text" name="city" id="profile_city" style="width:100%;padding:0.5rem;">
                                    </div>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label>USt-ID</label>
                                        <input type="text" name="vat_number" id="profile_vat_number" style="width:100%;padding:0.5rem;">
                                    </div>
                                    <div class="form-group">
                                        <label>Kontonummer / IBAN</label>
                                        <input type="text" name="bank_account" id="profile_bank_account" style="width:100%;padding:0.5rem;" placeholder="DE...">
                                    </div>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label>LinkedIn Profil</label>
                                        <div style="display: flex; align-items: center;">
                                            <span style="background: #e9ecef; padding: 0.5rem; border: 1px solid #ced4da; border-right: none; border-radius: 4px 0 0 4px; font-size: 0.85rem; white-space: nowrap;">linkedin.com/in/</span>
                                            <input type="text" name="linkedin_url" id="profile_linkedin_url" placeholder="ihr-profil" style="padding:0.5rem; border-radius: 0 4px 4px 0; flex: 1;">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Website</label>
                                        <div style="display: flex; align-items: center;">
                                            <span style="background: #e9ecef; padding: 0.5rem; border: 1px solid #ced4da; border-right: none; border-radius: 4px 0 0 4px; font-size: 0.85rem; white-space: nowrap;">https://</span>
                                            <input type="text" name="website" id="profile_website" placeholder="www.ihre-website.de" style="padding:0.5rem; border-radius: 0 4px 4px 0; flex: 1;">
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>Region</label>
                                    <input type="text" name="region" id="profile_region" style="width:100%;padding:0.5rem;">
                                </div>

                                <div class="form-group">
                                    <label>Weitere Informationen</label>
                                    <textarea name="additional_info" id="profile_additional_info" style="width:100%;padding:0.5rem;min-height:100px;"></textarea>
                                </div>

                                <fieldset style="border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                                    <legend style="font-weight: 600; padding: 0 0.5rem;">Spezialisierungen</legend>
                                    <div id="profileSpecializations" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem;"></div>
                                    <div style="margin-top: 1rem;">
                                        <label>Weitere Spezialisierungen (kommagetrennt)</label>
                                        <input type="text" id="profile_custom_specs" style="width:100%;padding:0.5rem;" placeholder="z.B. AI, Machine Learning">
                                    </div>
                                </fieldset>

                                <div class="form-group">
                                    <label>Notizen</label>
                                    <textarea name="notes" id="profile_notes" style="width:100%;padding:0.5rem;min-height:80px;"></textarea>
                                </div>

                                <fieldset style="border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                                    <legend style="font-weight: 600; padding: 0 0.5rem;">Meine Trainings die ich zus√§tzlich anbiete</legend>
                                    <p style="font-size: 0.85rem; color: #666; margin-bottom: 1rem;">
                                        Sie k√∂nnen, sofern gew√ºnscht, bis zu 10 EIGENE Trainings eintragen, die Yellow-Boat und die Submarken in eigenem Namen anbieten werden.
                                    </p>
                                    <div id="profileTrainingsContainer">
                                        <!-- Profile training entries will be added here dynamically -->
                                    </div>
                                    <button type="button" class="btn btn-success" id="addProfileTrainingBtn" onclick="addProfileTrainingEntry()" style="margin-top: 0.5rem;">
                                        + Training hinzuf√ºgen
                                    </button>
                                </fieldset>

                                <button type="submit" class="btn btn-primary">Profil speichern</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Messages / Nachrichten -->
                <div id="section-messages" class="section" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            Nachrichten
                            <button class="btn btn-sm btn-success" onclick="showNewMessageModal()">+ Neue Nachricht</button>
                        </div>
                        <div class="card-body">
                            <div id="messagesList">
                                <p style="color: #6c757d;">Laden...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Create Modal -->
    <div class="modal" id="createModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Neu erstellen</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <form id="createForm">
                <div id="modalFields"></div>
                <button type="submit" class="btn btn-primary" style="margin-top: 1rem;">Speichern</button>
            </form>
        </div>
    </div>

    <!-- Error Report Modal -->
    <div class="modal" id="errorReportModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Fehler melden</h3>
                <span class="close" onclick="closeErrorReportModal()">&times;</span>
            </div>
            <form id="errorReportForm">
                <div class="form-group">
                    <label>Betreff</label>
                    <input type="text" name="subject" required style="width:100%;padding:0.5rem;">
                </div>
                <div class="form-group">
                    <label>Beschreibung des Problems</label>
                    <textarea name="content" required style="width:100%;padding:0.5rem;min-height:150px;" placeholder="Beschreiben Sie das Problem so genau wie m√∂glich..."></textarea>
                </div>
                <input type="hidden" name="page_url" id="errorPageUrl">
                <button type="submit" class="btn btn-primary" style="margin-top: 1rem;">Fehler melden</button>
            </form>
        </div>
    </div>

    <!-- Message View Modal -->
    <div class="modal" id="messageViewModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="messageViewTitle">Nachricht</h3>
                <span class="close" onclick="closeMessageViewModal()">&times;</span>
            </div>
            <div id="messageViewContent">
                <div class="message-detail">
                    <p><strong>Von:</strong> <span id="messageFrom"></span></p>
                    <p><strong>An:</strong> <span id="messageTo"></span></p>
                    <p><strong>Datum:</strong> <span id="messageDate"></span></p>
                    <p id="messageStatusRow" style="display:none;"><strong>Status:</strong> <span id="messageStatusDisplay"></span></p>
                </div>
                <hr style="margin: 1rem 0;">
                <div id="messageBody" style="white-space: pre-wrap; margin-bottom: 1rem;"></div>

                <!-- Admin status controls for error reports -->
                <div id="adminStatusControls" style="display:none; margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
                    <label><strong>Status √§ndern:</strong></label>
                    <select id="messageStatusSelect" style="margin-left: 0.5rem; padding: 0.3rem;">
                        <option value="open">Offen</option>
                        <option value="solved">Gel√∂st</option>
                        <option value="not_solvable">Nicht l√∂sbar</option>
                    </select>
                    <button class="btn btn-sm btn-primary" onclick="updateMessageStatus()" style="margin-left: 0.5rem;">Speichern</button>
                </div>

                <!-- Trainer application approval controls -->
                <div id="trainerApprovalControls" style="display:none; margin-bottom: 1rem; padding: 1rem; background: #e8f5e9; border-radius: 4px;">
                    <button class="btn btn-success" onclick="approveTrainerApplication()" style="margin-right: 0.5rem;">
                        ‚úì Trainer anlegen
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="rejectTrainerApplication()">
                        ‚úó Ablehnen
                    </button>
                </div>

                <!-- Reply form -->
                <div id="replySection" style="margin-top: 1rem;">
                    <h4>Antworten</h4>
                    <textarea id="replyContent" style="width:100%;padding:0.5rem;min-height:100px;" placeholder="Ihre Antwort..."></textarea>
                    <button class="btn btn-primary" onclick="sendReply()" style="margin-top: 0.5rem;">Antwort senden</button>
                </div>
            </div>
            <div style="margin-top: 1rem; text-align: right;">
                <button class="btn btn-danger btn-sm" onclick="deleteCurrentMessage()">L√∂schen</button>
            </div>
        </div>
    </div>

    <!-- New Message Modal -->
    <div class="modal" id="newMessageModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Neue Nachricht</h3>
                <span class="close" onclick="closeNewMessageModal()">&times;</span>
            </div>
            <form id="newMessageForm">
                <div class="form-group">
                    <label>Empf√§nger</label>
                    <select name="recipient_id" id="messageRecipient" style="width:100%;padding:0.5rem;">
                        <option value="">Laden...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Betreff</label>
                    <input type="text" name="subject" required style="width:100%;padding:0.5rem;">
                </div>
                <div class="form-group">
                    <label>Nachricht</label>
                    <textarea name="content" required style="width:100%;padding:0.5rem;min-height:150px;"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="margin-top: 1rem;">Senden</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = '';
        let token = localStorage.getItem('token');
        let currentUser = null;

        // URL formatting helpers
        function formatLinkedInUrl(value) {
            if (!value) return '';
            // Remove any existing prefix
            value = value.replace(/^(https?:\/\/)?(www\.)?linkedin\.com\/in\//i, '');
            return value ? 'https://linkedin.com/in/' + value : '';
        }

        function formatWebsiteUrl(value) {
            if (!value) return '';
            // Remove any existing prefix
            value = value.replace(/^https?:\/\//i, '');
            return value ? 'https://' + value : '';
        }

        function stripLinkedInPrefix(url) {
            if (!url) return '';
            return url.replace(/^(https?:\/\/)?(www\.)?linkedin\.com\/in\//i, '');
        }

        function stripWebsitePrefix(url) {
            if (!url) return '';
            return url.replace(/^https?:\/\//i, '');
        }

        // Check if logged in
        if (token) {
            checkAuth();
        }

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const formData = new URLSearchParams();
                formData.append('username', username);
                formData.append('password', password);

                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });

                const data = await res.json();

                if (res.ok) {
                    token = data.access_token;
                    localStorage.setItem('token', token);
                    checkAuth();
                } else {
                    document.getElementById('loginError').textContent = data.error || 'Login fehlgeschlagen';
                }
            } catch (err) {
                document.getElementById('loginError').textContent = 'Verbindungsfehler';
            }
        });

        // Trainer Application Functions - Two Step Form
        let applicationStep1Data = {};
        let trainingsCount = 0;
        const MAX_TRAININGS = 10;

        function showTrainerApplicationForm() {
            document.getElementById('loginBox').style.display = 'none';
            document.getElementById('applicationStep1').style.display = 'block';
            document.getElementById('applicationStep2').style.display = 'none';
            document.getElementById('applicationError1').textContent = '';
            document.getElementById('applicationError2').textContent = '';
            applicationStep1Data = {};
            trainingsCount = 0;
            initTrainingsContainer();
        }

        function showLoginForm() {
            document.getElementById('applicationStep1').style.display = 'none';
            document.getElementById('applicationStep2').style.display = 'none';
            document.getElementById('loginBox').style.display = 'block';
            document.getElementById('loginError').textContent = '';
        }

        function goBackToStep1() {
            document.getElementById('applicationStep2').style.display = 'none';
            document.getElementById('applicationStep1').style.display = 'block';
            // Restore saved data
            document.getElementById('appEmail').value = applicationStep1Data.email || '';
            document.getElementById('appPassword').value = applicationStep1Data.password || '';
            document.getElementById('appPasswordConfirm').value = applicationStep1Data.password || '';
            document.getElementById('appFirstName').value = applicationStep1Data.first_name || '';
            document.getElementById('appLastName').value = applicationStep1Data.last_name || '';
            document.getElementById('appPhone').value = applicationStep1Data.phone || '';
        }

        function initTrainingsContainer() {
            document.getElementById('trainingsContainer').innerHTML = '';
            trainingsCount = 0;
            addTrainingEntry();
        }

        function addTrainingEntry() {
            if (trainingsCount >= MAX_TRAININGS) {
                alert('Maximal 10 Trainings k√∂nnen eingetragen werden.');
                return;
            }

            const container = document.getElementById('trainingsContainer');
            const index = trainingsCount;
            trainingsCount++;

            const entryHtml = `
                <div class="training-entry" id="training-${index}" style="border: 1px solid #e0e0e0; padding: 1rem; margin-bottom: 1rem; border-radius: 4px; background: #fafafa;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <strong style="color: var(--yb-hellblau);">Training ${index + 1}</strong>
                        <button type="button" onclick="removeTrainingEntry(${index})" style="background: none; border: none; color: #dc3545; cursor: pointer; font-size: 1.2rem;" title="Training l√∂schen">&times;</button>
                    </div>
                    <div class="form-group">
                        <label>Titel</label>
                        <input type="text" name="training_title_${index}">
                    </div>
                    <div class="form-group">
                        <label>Kurzbeschreibung</label>
                        <textarea name="training_description_${index}" style="width:100%; min-height: 60px;"></textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Dauer</label>
                            <input type="number" name="training_duration_${index}" min="1" max="999" style="height: 38px;">
                        </div>
                        <div class="form-group">
                            <label>Einheit</label>
                            <select name="training_duration_unit_${index}" style="height: 38px;">
                                <option value="">Bitte w√§hlen</option>
                                <option value="Stunden">Stunden</option>
                                <option value="Tage">Tage</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" name="training_materials_${index}" style="width: auto;">
                            Trainingsmaterialien vorhanden
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Zielgruppe</label>
                        <input type="text" name="training_target_${index}">
                    </div>
                    <div class="form-group">
                        <label>Mein Angebotspreis netto komplett an Yellow-Boat (EUR)</label>
                        <input type="number" name="training_price_${index}" step="0.01" min="0">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">
                            Hinweis: F√ºr die Abwicklung und Vermarktung kommt seitens Yellow-Boat ein Aufschlag zum Verkaufspreis vor Kunden.
                        </small>
                    </div>
                    <button type="button" class="btn btn-sm btn-primary" onclick="saveTrainingEntry(${index})" style="margin-top: 0.5rem;">
                        Training speichern
                    </button>
                    <span id="training-saved-${index}" style="display: none; color: #28a745; margin-left: 0.5rem;">‚úì Gespeichert</span>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', entryHtml);
            updateAddTrainingButton();
        }

        function removeTrainingEntry(index) {
            const entry = document.getElementById(`training-${index}`);
            if (entry) {
                entry.remove();
                updateAddTrainingButton();
            }
        }

        function saveTrainingEntry(index) {
            const form = document.getElementById('applicationFormStep2');
            const title = form.querySelector(`[name="training_title_${index}"]`)?.value;

            if (!title) {
                alert('Bitte geben Sie mindestens einen Titel ein.');
                return;
            }

            // Show saved indicator
            const savedIndicator = document.getElementById(`training-saved-${index}`);
            if (savedIndicator) {
                savedIndicator.style.display = 'inline';
                setTimeout(() => {
                    savedIndicator.style.display = 'none';
                }, 3000);
            }
        }

        function addNewTraining() {
            addTrainingEntry();
        }

        function updateAddTrainingButton() {
            const btn = document.getElementById('addTrainingBtn');
            const currentCount = document.querySelectorAll('.training-entry').length;
            if (btn) {
                if (currentCount >= MAX_TRAININGS) {
                    btn.style.display = 'none';
                } else {
                    btn.style.display = 'inline-block';
                }
            }
        }

        function collectTrainings() {
            const form = document.getElementById('applicationFormStep2');
            const trainings = [];

            for (let i = 0; i < trainingsCount; i++) {
                const title = form.querySelector(`[name="training_title_${i}"]`)?.value;
                if (!title) continue; // Skip empty entries

                trainings.push({
                    title: title,
                    description: form.querySelector(`[name="training_description_${i}"]`)?.value || '',
                    duration: parseInt(form.querySelector(`[name="training_duration_${i}"]`)?.value) || 0,
                    duration_unit: form.querySelector(`[name="training_duration_unit_${i}"]`)?.value || '',
                    materials_available: form.querySelector(`[name="training_materials_${i}"]`)?.checked || false,
                    target_audience: form.querySelector(`[name="training_target_${i}"]`)?.value || '',
                    price: parseFloat(form.querySelector(`[name="training_price_${i}"]`)?.value) || 0
                });
            }

            return trainings;
        }

        // Step 1 form submission
        document.getElementById('applicationFormStep1').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);

            // Validate passwords match
            if (formData.get('password') !== formData.get('password_confirm')) {
                document.getElementById('applicationError1').textContent = 'Passw√∂rter stimmen nicht √ºberein';
                return;
            }

            // Validate password length
            if (formData.get('password').length < 6) {
                document.getElementById('applicationError1').textContent = 'Passwort muss mindestens 6 Zeichen lang sein';
                return;
            }

            // Save step 1 data
            applicationStep1Data = {
                email: formData.get('email'),
                password: formData.get('password'),
                first_name: formData.get('first_name'),
                last_name: formData.get('last_name'),
                phone: formData.get('phone')
            };

            // Go to step 2
            document.getElementById('applicationStep1').style.display = 'none';
            document.getElementById('applicationStep2').style.display = 'block';
            initTrainingsContainer();
        });

        // Step 2 form submission
        document.getElementById('applicationFormStep2').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);

            const data = {
                email: applicationStep1Data.email,
                password: applicationStep1Data.password,
                first_name: applicationStep1Data.first_name,
                last_name: applicationStep1Data.last_name,
                phone: applicationStep1Data.phone,
                street: formData.get('street'),
                house_number: formData.get('house_number'),
                postal_code: formData.get('postal_code'),
                city: formData.get('city'),
                vat_number: formData.get('vat_number'),
                bank_account: formData.get('bank_account'),
                linkedin_url: formatLinkedInUrl(formData.get('linkedin_url')),
                website: formatWebsiteUrl(formData.get('website')),
                region: formData.get('region'),
                additional_info: formData.get('additional_info'),
                specializations: formData.get('specializations'),
                proposed_trainings: collectTrainings()
            };

            try {
                const res = await fetch(`${API_URL}/trainer/apply`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await res.json();

                if (res.ok) {
                    alert('Ihre Bewerbung wurde erfolgreich eingereicht! Sie erhalten eine Benachrichtigung, sobald Ihre Bewerbung gepr√ºft wurde.');
                    document.getElementById('applicationFormStep1').reset();
                    document.getElementById('applicationFormStep2').reset();
                    applicationStep1Data = {};
                    showLoginForm();
                } else {
                    document.getElementById('applicationError2').textContent = result.error || 'Fehler beim Einreichen der Bewerbung';
                }
            } catch (err) {
                document.getElementById('applicationError2').textContent = 'Verbindungsfehler';
            }
        });

        async function checkAuth() {
            try {
                const res = await fetch(`${API_URL}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    currentUser = await res.json();
                    document.getElementById('currentUser').textContent = currentUser.username;
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('appContainer').style.display = 'block';

                    // Show role-specific navigation
                    if (currentUser.role === 'admin') {
                        document.getElementById('adminNav').style.display = 'block';
                    }
                    if (currentUser.role === 'trainer') {
                        document.getElementById('trainerNav').style.display = 'block';
                        // Hide sections trainers shouldn't see
                        document.querySelector('[data-section="dashboard"]').style.display = 'none';
                        document.querySelector('[data-section="customers"]').style.display = 'none';
                        document.querySelector('[data-section="trainers"]').style.display = 'none';
                        // Trainers can view brands but not create
                        const brandsLink = document.querySelector('[data-section="brands"]');
                        if (brandsLink) brandsLink.textContent = 'Marken (Ansicht)';
                        // Start on trainer dashboard instead
                        showSection('trainer-dashboard');
                        updateUnreadCount();
                        return;
                    }

                    loadDashboard();
                    updateUnreadCount();
                } else {
                    logout();
                }
            } catch (err) {
                logout();
            }
        }

        function logout() {
            token = null;
            currentUser = null;
            localStorage.removeItem('token');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('currentUser').textContent = '';
            document.getElementById('adminNav').style.display = 'none';
            document.getElementById('trainerNav').style.display = 'none';
        }

        function showSection(name) {
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
            document.getElementById(`section-${name}`).style.display = 'block';
            document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
            const navItem = document.querySelector(`[data-section="${name}"]`);
            if (navItem) navItem.classList.add('active');

            if (name === 'dashboard') loadDashboard();
            else if (name === 'trainings') loadTrainings();
            else if (name === 'customers') loadCustomers();
            else if (name === 'trainers') loadTrainers();
            else if (name === 'brands') loadBrands();
            else if (name === 'locations') loadLocations();
            else if (name === 'users') loadUsers();
            else if (name === 'training-applications') loadTrainingApplications();
            else if (name === 'trainer-dashboard') loadTrainerDashboard();
            else if (name === 'my-profile') loadMyProfile();
            else if (name === 'open-trainings') loadOpenTrainings();
            else if (name === 'messages') loadMessages();
        }

        async function loadTrainerDashboard() {
            try {
                // Load dashboard stats and detailed trainings
                const [dashboardRes, trainingsRes] = await Promise.all([
                    apiCall('/trainer/dashboard'),
                    apiCall('/trainer/my-trainings')
                ]);

                const data = await dashboardRes.json();
                const detailedTrainings = trainingsRes.ok ? await trainingsRes.json() : [];

                if (data.error) {
                    document.getElementById('trainerStats').innerHTML = `<p style="color: #dc3545;">${data.error}</p>`;
                    return;
                }

                // Update stats
                document.getElementById('statMyTrainings').textContent = data.stats.total_trainings;
                document.getElementById('statCompleted').textContent = data.stats.completed_trainings;
                document.getElementById('statEarnings').textContent = data.stats.total_earnings.toFixed(2);
                document.getElementById('statPendingApps').textContent = data.stats.pending_applications;

                // Update my trainings table with detailed info
                document.getElementById('myTrainingsTable').innerHTML = detailedTrainings.map(t => `
                    <tr>
                        <td>
                            <strong>${t.title || '-'}</strong>
                            ${t.location ? `<br><small style="color:#6c757d;">${t.location}</small>` : ''}
                        </td>
                        <td>
                            ${t.start_date ? new Date(t.start_date).toLocaleDateString('de') : '-'}
                            ${t.duration_days ? `<br><small>(${t.duration_days} Tag/e)</small>` : ''}
                        </td>
                        <td><span class="status-badge" style="padding:0.25rem 0.5rem;border-radius:4px;background:${
                            t.status === 'delivered' ? '#28a745' :
                            t.status === 'invoiced' ? '#17a2b8' :
                            t.status === 'planning' ? '#ffc107' : '#6c757d'
                        };color:white;font-size:0.75rem;">${t.status || '-'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="showTrainingDetails(${t.id})" title="Details anzeigen">Details</button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="4">Keine Trainings</td></tr>';

                // Store detailed trainings for modal
                window.trainerDetailedTrainings = detailedTrainings;

                // Update applications table
                document.getElementById('myApplicationsTable').innerHTML = data.applications.map(a => `
                    <tr>
                        <td>Training #${a.training_id}</td>
                        <td>${a.proposed_rate ? a.proposed_rate.toFixed(2) + ' ‚Ç¨' : '-'}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${a.message || ''}">${a.message || '-'}</td>
                        <td><span style="color: ${a.status === 'accepted' ? '#28a745' : a.status === 'rejected' ? '#dc3545' : '#ffc107'};">${a.status}</span></td>
                        <td>${a.created_at ? new Date(a.created_at).toLocaleDateString('de') : '-'}</td>
                        <td>
                            ${a.status === 'pending' ? `<button class="btn btn-sm btn-danger" onclick="withdrawApplication(${a.id})">Zur√ºckziehen</button>` : ''}
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="6">Keine Bewerbungen</td></tr>';
            } catch (err) {
                console.error('Error loading trainer dashboard:', err);
            }
        }

        function showTrainingDetails(trainingId) {
            const training = window.trainerDetailedTrainings?.find(t => t.id === trainingId);
            if (!training) {
                alert('Training nicht gefunden');
                return;
            }

            let detailsHtml = `
                <h3 style="margin-bottom: 1rem;">${training.title}</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <p><strong>Status:</strong> ${training.status || '-'}</p>
                        <p><strong>Datum:</strong> ${training.start_date ? new Date(training.start_date).toLocaleDateString('de') : '-'} ${training.end_date ? '- ' + new Date(training.end_date).toLocaleDateString('de') : ''}</p>
                        <p><strong>Dauer:</strong> ${training.duration_days || '-'} Tag(e)</p>
                        <p><strong>Format:</strong> ${training.training_format || '-'} / ${training.training_type || '-'}</p>
                        <p><strong>Max TN:</strong> ${training.max_participants || '-'}</p>
                        <p><strong>Sprache:</strong> ${training.language || '-'}</p>
                    </div>
                    <div>
                        <p><strong>Ort:</strong> ${training.location || '-'}</p>
                        ${training.location_booking ? `<p><strong>Location Buchung:</strong> ${training.location_booking}</p>` : ''}
                        ${training.catering_booking ? `<p><strong>Catering:</strong> ${training.catering_booking}</p>` : ''}
                        ${training.online_link ? `<p><strong>Online-Link:</strong> <a href="${training.online_link}" target="_blank">${training.online_link}</a></p>` : ''}
                    </div>
                </div>
            `;

            if (training.location_details) {
                detailsHtml += `<p style="margin-top:1rem;"><strong>Location Details:</strong><br>${training.location_details}</p>`;
            }

            if (training.logistics_notes) {
                detailsHtml += `<p style="margin-top:1rem;"><strong>Logistik:</strong><br>${training.logistics_notes}</p>`;
            }

            if (training.communication_notes) {
                detailsHtml += `<p style="margin-top:1rem;"><strong>Kommunikation:</strong><br>${training.communication_notes}</p>`;
            }

            if (training.internal_notes) {
                detailsHtml += `<p style="margin-top:1rem;"><strong>Notizen:</strong><br>${training.internal_notes}</p>`;
            }

            // Show in modal
            document.getElementById('modalTitle').textContent = 'Training Details';
            document.getElementById('modalFields').innerHTML = detailsHtml;
            document.querySelector('#createForm button[type="submit"]').style.display = 'none';
            document.getElementById('createModal').style.display = 'flex';
        }

        async function loadOpenTrainings() {
            try {
                const trainings = await apiCall('/trainer/open-trainings').then(r => r.json());

                if (trainings.error) {
                    document.getElementById('openTrainingsList').innerHTML = `<p style="color: #dc3545;">${trainings.error}</p>`;
                    return;
                }

                document.getElementById('openTrainingsList').innerHTML = trainings.map(t => `
                    <div class="card" style="margin-bottom: 1rem;">
                        <div class="card-header">
                            ${t.title}
                            ${t.already_applied
                                ? '<span style="color: #28a745; float: right;">‚úì Beworben</span>'
                                : `<button class="btn btn-sm btn-success" style="float: right;" onclick="applyForTraining(${t.id})">Bewerben</button>`
                            }
                        </div>
                        <div class="card-body">
                            <p><strong>Datum:</strong> ${t.start_date ? new Date(t.start_date).toLocaleDateString('de') : 'TBD'} ${t.end_date ? '- ' + new Date(t.end_date).toLocaleDateString('de') : ''}</p>
                            <p><strong>Dauer:</strong> ${t.duration_days || '?'} Tag(e)</p>
                            <p><strong>Ort:</strong> ${t.location || 'TBD'}</p>
                            ${t.description ? `<p><strong>Details:</strong> ${t.description}</p>` : ''}
                        </div>
                    </div>
                `).join('') || '<p>Keine offenen Trainings verf√ºgbar.</p>';
            } catch (err) {
                console.error('Error loading open trainings:', err);
            }
        }

        async function applyForTraining(trainingId) {
            const rate = prompt('Dein Tagessatz (‚Ç¨):', '');
            if (rate === null) return;

            const message = prompt('Nachricht (optional):', '');

            try {
                const res = await apiCall(`/trainer/apply/${trainingId}`, {
                    method: 'POST',
                    body: JSON.stringify({
                        proposed_rate: rate ? parseFloat(rate) : null,
                        message: message || null
                    })
                });

                const data = await res.json();
                if (res.ok) {
                    alert('Bewerbung erfolgreich eingereicht!');
                    loadOpenTrainings();
                } else {
                    alert(data.error || 'Fehler bei der Bewerbung');
                }
            } catch (err) {
                alert('Fehler bei der Bewerbung');
            }
        }

        async function withdrawApplication(applicationId) {
            if (!confirm('Bewerbung wirklich zur√ºckziehen?')) return;

            try {
                await apiCall(`/trainer/applications/${applicationId}`, { method: 'DELETE' });
                loadTrainerDashboard();
            } catch (err) {
                alert('Fehler beim Zur√ºckziehen');
            }
        }

        // My Profile functions
        let myTrainerId = null;

        async function loadMyProfile() {
            try {
                const data = await apiCall('/trainer/dashboard').then(r => r.json());
                if (data.error) {
                    alert(data.error);
                    return;
                }

                const trainer = data.trainer;
                myTrainerId = trainer.id;

                // Fill form fields
                document.getElementById('profile_first_name').value = trainer.first_name || '';
                document.getElementById('profile_last_name').value = trainer.last_name || '';
                document.getElementById('profile_email').value = trainer.email || '';
                document.getElementById('profile_phone').value = trainer.phone || '';
                document.getElementById('profile_street').value = trainer.street || '';
                document.getElementById('profile_house_number').value = trainer.house_number || '';
                document.getElementById('profile_postal_code').value = trainer.postal_code || '';
                document.getElementById('profile_city').value = trainer.city || '';
                document.getElementById('profile_vat_number').value = trainer.vat_number || '';
                document.getElementById('profile_bank_account').value = trainer.bank_account || '';
                document.getElementById('profile_linkedin_url').value = stripLinkedInPrefix(trainer.linkedin_url || '');
                document.getElementById('profile_website').value = stripWebsitePrefix(trainer.website || '');
                document.getElementById('profile_region').value = trainer.region || '';
                document.getElementById('profile_additional_info').value = trainer.additional_info || '';
                document.getElementById('profile_notes').value = trainer.notes || '';

                // Photo
                const photoPreview = document.getElementById('profilePhotoPreview');
                if (trainer.photo_path) {
                    photoPreview.innerHTML = `<img src="${trainer.photo_path}" style="width: 100%; height: 100%; object-fit: cover;">`;
                } else {
                    photoPreview.innerHTML = '<span style="color: #6c757d;">Kein Foto</span>';
                }

                // Specializations
                const specs = trainer.specializations || { selected: [], custom: [] };
                const specsContainer = document.getElementById('profileSpecializations');
                specsContainer.innerHTML = TRAINER_SPECIALIZATIONS.map(spec => `
                    <label style="display: flex; align-items: center; gap: 0.25rem;">
                        <input type="checkbox" name="profile_spec" value="${spec}" ${specs.selected && specs.selected.includes(spec) ? 'checked' : ''}>
                        ${spec}
                    </label>
                `).join('');
                document.getElementById('profile_custom_specs').value = specs.custom ? specs.custom.join(', ') : '';

                // Load trainings
                loadProfileTrainings(trainer.proposed_trainings || []);

            } catch (err) {
                console.error('Error loading profile:', err);
                alert('Fehler beim Laden des Profils');
            }
        }

        // Profile Trainings Functions
        let profileTrainingsCount = 0;
        const MAX_PROFILE_TRAININGS = 10;

        function loadProfileTrainings(trainings) {
            const container = document.getElementById('profileTrainingsContainer');
            container.innerHTML = '';
            profileTrainingsCount = 0;

            if (trainings && trainings.length > 0) {
                trainings.forEach((training, index) => {
                    addProfileTrainingEntry(training);
                });
            }
            updateAddProfileTrainingButton();
        }

        function addProfileTrainingEntry(existingData = null) {
            if (profileTrainingsCount >= MAX_PROFILE_TRAININGS) {
                alert('Maximal 10 Trainings k√∂nnen eingetragen werden.');
                return;
            }

            const container = document.getElementById('profileTrainingsContainer');
            const index = profileTrainingsCount;
            profileTrainingsCount++;

            const entryHtml = `
                <div class="profile-training-entry" id="profile-training-${index}" style="border: 1px solid #e0e0e0; padding: 1rem; margin-bottom: 1rem; border-radius: 4px; background: #fafafa;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <strong style="color: var(--yb-hellblau);">Training ${index + 1}</strong>
                        <button type="button" onclick="removeProfileTrainingEntry(${index})" style="background: none; border: none; color: #dc3545; cursor: pointer; font-size: 1.2rem;" title="Training l√∂schen">&times;</button>
                    </div>
                    <div class="form-group">
                        <label>Titel</label>
                        <input type="text" id="profile_training_title_${index}" value="${existingData?.title || ''}" style="width:100%;padding:0.5rem;">
                    </div>
                    <div class="form-group">
                        <label>Kurzbeschreibung</label>
                        <textarea id="profile_training_description_${index}" style="width:100%;padding:0.5rem;min-height:60px;">${existingData?.description || ''}</textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Dauer</label>
                            <input type="number" id="profile_training_duration_${index}" min="1" max="999" value="${existingData?.duration || ''}" style="width:100%;padding:0.5rem;height:38px;">
                        </div>
                        <div class="form-group">
                            <label>Einheit</label>
                            <select id="profile_training_duration_unit_${index}" style="width:100%;padding:0.5rem;height:38px;">
                                <option value="">Bitte w√§hlen</option>
                                <option value="Stunden" ${existingData?.duration_unit === 'Stunden' ? 'selected' : ''}>Stunden</option>
                                <option value="Tage" ${existingData?.duration_unit === 'Tage' ? 'selected' : ''}>Tage</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="profile_training_materials_${index}" ${existingData?.materials_available ? 'checked' : ''} style="width: auto;">
                            Trainingsmaterialien vorhanden
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Zielgruppe</label>
                        <input type="text" id="profile_training_target_${index}" value="${existingData?.target_audience || ''}" style="width:100%;padding:0.5rem;">
                    </div>
                    <div class="form-group">
                        <label>Mein Angebotspreis netto komplett an Yellow-Boat (EUR)</label>
                        <input type="number" id="profile_training_price_${index}" step="0.01" min="0" value="${existingData?.price || ''}" style="width:100%;padding:0.5rem;">
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', entryHtml);
            updateAddProfileTrainingButton();
        }

        function removeProfileTrainingEntry(index) {
            const entry = document.getElementById(`profile-training-${index}`);
            if (entry) {
                entry.remove();
                updateAddProfileTrainingButton();
            }
        }

        function updateAddProfileTrainingButton() {
            const btn = document.getElementById('addProfileTrainingBtn');
            const currentCount = document.querySelectorAll('.profile-training-entry').length;
            if (btn) {
                if (currentCount >= MAX_PROFILE_TRAININGS) {
                    btn.style.display = 'none';
                } else {
                    btn.style.display = 'inline-block';
                }
            }
        }

        function collectProfileTrainings() {
            const trainings = [];
            const entries = document.querySelectorAll('.profile-training-entry');

            entries.forEach(entry => {
                const index = entry.id.replace('profile-training-', '');
                const title = document.getElementById(`profile_training_title_${index}`)?.value;
                if (!title) return; // Skip empty entries

                trainings.push({
                    title: title,
                    description: document.getElementById(`profile_training_description_${index}`)?.value || '',
                    duration: parseInt(document.getElementById(`profile_training_duration_${index}`)?.value) || 0,
                    duration_unit: document.getElementById(`profile_training_duration_unit_${index}`)?.value || '',
                    materials_available: document.getElementById(`profile_training_materials_${index}`)?.checked || false,
                    target_audience: document.getElementById(`profile_training_target_${index}`)?.value || '',
                    price: parseFloat(document.getElementById(`profile_training_price_${index}`)?.value) || 0
                });
            });

            return trainings;
        }

        function previewProfilePhoto(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('profilePhotoPreview').innerHTML =
                        `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;">`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Profile form submit
        document.addEventListener('DOMContentLoaded', function() {
            const profileForm = document.getElementById('myProfileForm');
            if (profileForm) {
                profileForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    if (!myTrainerId) {
                        alert('Trainer-Profil nicht geladen');
                        return;
                    }

                    // Collect specializations
                    const selectedSpecs = Array.from(document.querySelectorAll('input[name="profile_spec"]:checked')).map(cb => cb.value);
                    const customSpecs = document.getElementById('profile_custom_specs').value
                        .split(',')
                        .map(s => s.trim())
                        .filter(s => s);

                    const profileData = {
                        first_name: document.getElementById('profile_first_name').value,
                        last_name: document.getElementById('profile_last_name').value,
                        email: document.getElementById('profile_email').value,
                        phone: document.getElementById('profile_phone').value,
                        street: document.getElementById('profile_street').value,
                        house_number: document.getElementById('profile_house_number').value,
                        postal_code: document.getElementById('profile_postal_code').value,
                        city: document.getElementById('profile_city').value,
                        vat_number: document.getElementById('profile_vat_number').value,
                        bank_account: document.getElementById('profile_bank_account').value,
                        linkedin_url: formatLinkedInUrl(document.getElementById('profile_linkedin_url').value),
                        website: formatWebsiteUrl(document.getElementById('profile_website').value),
                        region: document.getElementById('profile_region').value,
                        additional_info: document.getElementById('profile_additional_info').value,
                        notes: document.getElementById('profile_notes').value,
                        specializations: {
                            selected: selectedSpecs,
                            custom: customSpecs
                        },
                        proposed_trainings: collectProfileTrainings()
                    };

                    try {
                        const res = await apiCall(`/trainer/profile`, {
                            method: 'PUT',
                            body: JSON.stringify(profileData)
                        });

                        if (!res.ok) {
                            const error = await res.json();
                            alert(error.error || 'Fehler beim Speichern');
                            return;
                        }

                        // Upload photo if selected
                        const photoInput = document.getElementById('profilePhotoInput');
                        if (photoInput.files && photoInput.files[0]) {
                            const formData = new FormData();
                            formData.append('photo', photoInput.files[0]);

                            const photoRes = await fetch(`/trainers/${myTrainerId}/photo`, {
                                method: 'POST',
                                headers: { 'Authorization': `Bearer ${token}` },
                                body: formData
                            });

                            if (!photoRes.ok) {
                                alert('Profil gespeichert, aber Foto-Upload fehlgeschlagen');
                                return;
                            }
                        }

                        alert('Profil erfolgreich gespeichert!');
                        loadMyProfile();
                    } catch (err) {
                        console.error('Error saving profile:', err);
                        alert('Fehler beim Speichern des Profils');
                    }
                });
            }
        });

        async function loadUsers() {
            if (currentUser.role !== 'admin') {
                document.getElementById('usersTable').innerHTML = '<tr><td colspan="6">Keine Berechtigung</td></tr>';
                return;
            }

            const users = await apiCall('/auth/users').then(r => r.json());
            document.getElementById('usersTable').innerHTML = users.map(u => `
                <tr>
                    <td>${u.username}</td>
                    <td>${u.email}</td>
                    <td><span class="badge" style="background: ${u.role === 'admin' ? '#dc3545' : u.role === 'trainer' ? '#28a745' : '#007bff'}; color: white; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.75rem;">${u.role}</span></td>
                    <td>${u.is_active ? '<span style="color: #28a745;">Aktiv</span>' : '<span style="color: #dc3545;">Inaktiv</span>'}</td>
                    <td>
                        ${u.role === 'trainer' ? `
                            ${u.trainer_id
                                ? `<span style="color: #28a745;">${u.trainer_name}</span>`
                                : `<span style="color: #6c757d;" title="Wird automatisch per E-Mail verkn√ºpft">Keine Verkn√ºpfung</span>`
                            }
                        ` : '-'}
                    </td>
                    <td>
                        ${u.id !== currentUser.id ? `<button class="btn btn-sm btn-danger" onclick="deleteUser(${u.id})">L√∂schen</button>` : '<em>Aktueller User</em>'}
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="6">Keine Benutzer</td></tr>';
        }

        async function deleteUser(id) {
            if (!confirm('Benutzer wirklich l√∂schen?')) return;
            const res = await apiCall(`/auth/users/${id}`, { method: 'DELETE' });
            if (!res.ok) {
                const error = await res.json().catch(() => ({}));
                alert(error.error || 'Fehler beim L√∂schen');
                return;
            }
            loadUsers();
        }

        async function loadTrainingApplications() {
            if (currentUser.role !== 'admin' && currentUser.role !== 'backoffice_user') {
                document.getElementById('trainingApplicationsTable').innerHTML = '<tr><td colspan="7">Keine Berechtigung</td></tr>';
                return;
            }

            try {
                const res = await apiCall('/admin/training-applications');
                if (!res.ok) {
                    document.getElementById('trainingApplicationsTable').innerHTML = '<tr><td colspan="7">Fehler beim Laden</td></tr>';
                    return;
                }
                const applications = await res.json();

                if (applications.length === 0) {
                    document.getElementById('trainingApplicationsTable').innerHTML = '<tr><td colspan="7">Keine Bewerbungen vorhanden</td></tr>';
                    return;
                }

                document.getElementById('trainingApplicationsTable').innerHTML = applications.map(app => `
                    <tr>
                        <td>
                            <strong>${app.trainer_name}</strong><br>
                            <small style="color: #6c757d;">${app.trainer_email || ''}</small>
                        </td>
                        <td>${app.training_title}</td>
                        <td>${app.proposed_rate ? app.proposed_rate + ' ‚Ç¨' : '-'}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${app.message || '-'}</td>
                        <td>
                            <span class="badge" style="background: ${app.status === 'pending' ? '#ffc107' : app.status === 'accepted' ? '#28a745' : '#dc3545'}; color: ${app.status === 'pending' ? '#000' : '#fff'}; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.75rem;">
                                ${app.status === 'pending' ? 'Offen' : app.status === 'accepted' ? 'Akzeptiert' : 'Abgelehnt'}
                            </span>
                        </td>
                        <td>${app.created_at ? new Date(app.created_at).toLocaleDateString('de') : '-'}</td>
                        <td>
                            ${app.status === 'pending' ? `
                                <button class="btn btn-sm btn-success" onclick="acceptTrainingApplication(${app.id})" style="margin-right: 0.25rem;">Akzeptieren</button>
                                <button class="btn btn-sm btn-danger" onclick="rejectTrainingApplication(${app.id})">Ablehnen</button>
                            ` : '-'}
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading training applications:', error);
                document.getElementById('trainingApplicationsTable').innerHTML = '<tr><td colspan="7">Fehler beim Laden</td></tr>';
            }
        }

        async function acceptTrainingApplication(appId) {
            if (!confirm('Bewerbung akzeptieren und Trainer dem Training zuweisen?')) return;

            const res = await apiCall(`/admin/training-applications/${appId}/accept`, {
                method: 'POST'
            });

            if (!res.ok) {
                const error = await res.json().catch(() => ({}));
                alert(error.error || 'Fehler beim Akzeptieren');
                return;
            }

            const result = await res.json();
            alert(result.message || 'Bewerbung akzeptiert');
            loadTrainingApplications();
        }

        async function rejectTrainingApplication(appId) {
            if (!confirm('Bewerbung wirklich ablehnen?')) return;

            const res = await apiCall(`/admin/training-applications/${appId}/reject`, {
                method: 'POST'
            });

            if (!res.ok) {
                const error = await res.json().catch(() => ({}));
                alert(error.error || 'Fehler beim Ablehnen');
                return;
            }

            loadTrainingApplications();
        }

        async function apiCall(endpoint, options = {}) {
            const res = await fetch(`${API_URL}${endpoint}`, {
                ...options,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });
            if (res.status === 401) logout();
            return res;
        }

        async function loadDashboard() {
            const [trainingsData, customersData, trainersData, brandsData] = await Promise.all([
                apiCall('/trainings').then(r => r.json()),
                apiCall('/customers').then(r => r.json()),
                apiCall('/trainers').then(r => r.json()),
                apiCall('/brands').then(r => r.json())
            ]);

            // Handle both paginated and non-paginated responses
            const trainings = trainingsData.items || trainingsData;
            const customers = customersData.items || customersData;
            const trainers = trainersData.items || trainersData;
            const brands = brandsData.items || brandsData;

            document.getElementById('statTrainings').textContent = trainingsData.total || trainings.length;
            document.getElementById('statCustomers').textContent = customersData.total || customers.length;
            document.getElementById('statTrainers').textContent = trainersData.total || trainers.length;
            document.getElementById('statBrands').textContent = brandsData.total || brands.length;

            const recent = trainings.slice(0, 5);
            document.getElementById('recentTrainings').innerHTML = recent.map(t => `
                <tr>
                    <td>${t.title || '-'}</td>
                    <td>${t.status || '-'}</td>
                    <td>${t.date ? new Date(t.date).toLocaleDateString('de') : '-'}</td>
                </tr>
            `).join('') || '<tr><td colspan="3">Keine Trainings</td></tr>';
        }

        async function loadTrainings() {
            try {
                const res = await apiCall('/trainings');
                if (!res.ok) {
                    console.error('Failed to load trainings:', res.status);
                    document.getElementById('trainingsTable').innerHTML = '<tr><td colspan="4">Fehler beim Laden</td></tr>';
                    return;
                }
                const data = await res.json();
                const trainings = data.items || data;
                document.getElementById('trainingsTable').innerHTML = trainings.map(t => `
                    <tr>
                        <td>${t.title || '-'}</td>
                        <td>${t.status || '-'}</td>
                        <td>${t.date ? new Date(t.date).toLocaleDateString('de') : '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="showEditModal('training', ${t.id})" style="margin-right:0.25rem;">Bearbeiten</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteItem('trainings', ${t.id})">L√∂schen</button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="4">Keine Trainings</td></tr>';
            } catch (err) {
                console.error('Error loading trainings:', err);
                document.getElementById('trainingsTable').innerHTML = '<tr><td colspan="4">Fehler beim Laden</td></tr>';
            }
        }

        async function loadCustomers() {
            try {
                const res = await apiCall('/customers');
                if (!res.ok) {
                    console.error('Failed to load customers:', res.status);
                    document.getElementById('customersTable').innerHTML = '<tr><td colspan="4">Fehler beim Laden</td></tr>';
                    return;
                }
                const data = await res.json();
                const customers = data.items || data;
                document.getElementById('customersTable').innerHTML = customers.map(c => `
                    <tr>
                        <td title="Tel: ${c.phone || '-'}\nAdresse: ${c.street || ''} ${c.street_number || ''}, ${c.postal_code || ''} ${c.city || ''}">${c.name || c.company || '-'}</td>
                        <td>${c.email || '-'}</td>
                        <td>${c.company || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="showEditModal('customer', ${c.id})" style="margin-right:0.25rem;">Bearbeiten</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteItem('customers', ${c.id})">L√∂schen</button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="4">Keine Kunden</td></tr>';
            } catch (err) {
                console.error('Error loading customers:', err);
                document.getElementById('customersTable').innerHTML = '<tr><td colspan="4">Fehler beim Laden</td></tr>';
            }
        }

        async function loadTrainers() {
            try {
                const res = await apiCall('/trainers');
                if (!res.ok) {
                    console.error('Failed to load trainers:', res.status);
                    document.getElementById('trainersTable').innerHTML = '<tr><td colspan="4">Fehler beim Laden</td></tr>';
                    return;
                }
                const data = await res.json();
                const trainers = data.items || data;
                document.getElementById('trainersTable').innerHTML = trainers.map(t => {
                    const specs = t.specializations || {selected: [], custom: []};
                    const allSpecs = [...(specs.selected || []), ...(specs.custom || [])];
                    return `
                        <tr>
                            <td title="Tel: ${t.phone || '-'}\nRegion: ${t.region || '-'}\nTagessatz: ${t.default_day_rate ? t.default_day_rate + ' ‚Ç¨' : '-'}">
                                ${t.photo_path ? `<img src="${t.photo_path}" style="width:30px;height:30px;border-radius:50%;margin-right:0.5rem;vertical-align:middle;">` : ''}
                                ${t.name || '-'}
                            </td>
                            <td>${t.email || '-'}</td>
                            <td>${allSpecs.slice(0, 3).join(', ') || '-'}${allSpecs.length > 3 ? '...' : ''}</td>
                            <td>
                                <button class="btn btn-sm btn-secondary" onclick="showEditModal('trainer', ${t.id})" style="margin-right:0.25rem;">Bearbeiten</button>
                                ${t.linkedin_url ? `<a href="${t.linkedin_url}" target="_blank" class="btn btn-sm btn-secondary" style="margin-right:0.25rem;">LinkedIn</a>` : ''}
                                <button class="btn btn-sm btn-danger" onclick="deleteItem('trainers', ${t.id})">L√∂schen</button>
                            </td>
                        </tr>
                    `;
                }).join('') || '<tr><td colspan="4">Keine Trainer</td></tr>';
            } catch (err) {
                console.error('Error loading trainers:', err);
                document.getElementById('trainersTable').innerHTML = '<tr><td colspan="4">Fehler beim Laden</td></tr>';
            }
        }

        async function loadBrands() {
            try {
                console.log('Loading brands...');
                const res = await apiCall('/brands');
                console.log('Brands response status:', res.status);
                if (!res.ok) {
                    console.error('Failed to load brands:', res.status);
                    document.getElementById('brandsTable').innerHTML = '<tr><td colspan="3">Fehler beim Laden</td></tr>';
                    return;
                }
                const data = await res.json();
                const brands = data.items || data;
                console.log('Loaded brands:', brands);

                // Hide create button for trainers
                const createBrandBtn = document.querySelector('#section-brands .btn-success');
                if (createBrandBtn && currentUser && currentUser.role === 'trainer') {
                    createBrandBtn.style.display = 'none';
                }

                document.getElementById('brandsTable').innerHTML = brands.map(b => `
                    <tr>
                        <td>${b.name || '-'}</td>
                        <td>${b.description || '-'}</td>
                        <td>
                            ${currentUser && currentUser.role !== 'trainer' ? `
                                <button class="btn btn-sm btn-secondary" onclick="showEditModal('brand', ${b.id})" style="margin-right:0.25rem;">Bearbeiten</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteItem('brands', ${b.id})">L√∂schen</button>
                            ` : ''}
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="3">Keine Marken</td></tr>';
            } catch (err) {
                console.error('Error loading brands:', err);
                document.getElementById('brandsTable').innerHTML = '<tr><td colspan="3">Fehler beim Laden</td></tr>';
            }
        }

        async function loadLocations() {
            try {
                console.log('Loading locations...');
                const res = await apiCall('/locations');
                console.log('Locations response status:', res.status);
                if (!res.ok) {
                    console.error('Failed to load locations:', res.status);
                    document.getElementById('locationsTable').innerHTML = '<tr><td colspan="5">Fehler beim Laden</td></tr>';
                    return;
                }
                const data = await res.json();
                const locations = data.items || data;
                console.log('Loaded locations:', locations);

                const cateringLabels = { yes: 'Ja', no: 'Nein', external: 'Extern' };

                document.getElementById('locationsTable').innerHTML = locations.map(loc => `
                    <tr>
                        <td>${loc.name || '-'}</td>
                        <td>${loc.city || '-'}</td>
                        <td>${loc.max_participants || '-'}</td>
                        <td>${cateringLabels[loc.catering_available] || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="showEditModal('location', ${loc.id})" style="margin-right:0.25rem;">Bearbeiten</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteItem('locations', ${loc.id})">L√∂schen</button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="5">Keine Locations</td></tr>';
            } catch (err) {
                console.error('Error loading locations:', err);
                document.getElementById('locationsTable').innerHTML = '<tr><td colspan="5">Fehler beim Laden</td></tr>';
            }
        }

        async function deleteItem(type, id) {
            if (!confirm('Wirklich l√∂schen?')) return;
            const res = await apiCall(`/${type}/${id}`, { method: 'DELETE' });
            if (!res.ok) {
                const error = await res.json().catch(() => ({}));
                alert(error.error || 'Fehler beim L√∂schen');
                return;
            }
            showSection(type);
        }

        // Predefined specializations for trainers
        const TRAINER_SPECIALIZATIONS = [
            'Leadership', 'Agile/Scrum', 'Project Management', 'Communication',
            'Sales', 'Marketing', 'IT/Software', 'Data Science', 'Cloud/DevOps',
            'Security', 'Change Management', 'Team Building', 'Presentation Skills'
        ];

        const formFields = {
            training: 'custom', // Special handling for extended training form
            customer: 'custom', // Special handling for customer form
            trainer: 'custom', // Special handling for trainer form
            location: 'custom', // Special handling for location form
            brand: [
                { name: 'name', label: 'Name', type: 'text', required: true },
                { name: 'description', label: 'Beschreibung', type: 'textarea' }
            ],
            user: [
                { name: 'username', label: 'Benutzername', type: 'text', required: true },
                { name: 'email', label: 'Email', type: 'email', required: true },
                { name: 'password', label: 'Passwort', type: 'password', required: true },
                { name: 'role', label: 'Rolle', type: 'select', options: ['backoffice_user', 'trainer', 'admin'] },
                { name: 'is_active', label: 'Aktiv', type: 'checkbox' }
            ]
        };

        // Cache for dropdowns
        let cachedBrands = [];
        let cachedCustomers = [];
        let cachedTrainers = [];
        let cachedLocations = [];

        async function loadFormData() {
            const [brandsRes, customersRes, trainersRes, locationsRes] = await Promise.all([
                apiCall('/brands'),
                apiCall('/customers'),
                apiCall('/trainers'),
                apiCall('/locations')
            ]);
            if (brandsRes.ok) cachedBrands = await brandsRes.json();
            if (customersRes.ok) cachedCustomers = await customersRes.json();
            if (trainersRes.ok) cachedTrainers = await trainersRes.json();
            if (locationsRes.ok) cachedLocations = await locationsRes.json();
        }

        // Store form data for inline customer creation
        let savedTrainingFormData = null;

        function generateTrainingForm(data = {}) {
            const durationValue = data.duration_type === 'hours' ? (data.duration_hours || 8) : (data.duration_days || 1);
            return `
                <div class="form-group">
                    <label>Titel *</label>
                    <input type="text" name="title" value="${data.title || ''}" required style="width:100%;padding:0.5rem;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Marke</label>
                        <select name="brand_id" style="width:100%;padding:0.5rem;">
                            <option value="">-- Ausw√§hlen --</option>
                            ${cachedBrands.map(b => `<option value="${b.id}" ${data.brand_id == b.id ? 'selected' : ''}>${b.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Kunde</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <select name="customer_id" style="flex:1;padding:0.5rem;">
                                <option value="">-- Ausw√§hlen --</option>
                                ${cachedCustomers.map(c => `<option value="${c.id}" ${data.customer_id == c.id ? 'selected' : ''}>${c.company || c.name}</option>`).join('')}
                            </select>
                            <button type="button" onclick="openInlineCustomerCreate()" class="btn btn-sm btn-success" title="Neuen Kunden anlegen">+</button>
                        </div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Trainer</label>
                        <select name="trainer_id" style="width:100%;padding:0.5rem;">
                            <option value="">-- Kein Trainer --</option>
                            ${cachedTrainers.map(t => `<option value="${t.id}" ${data.trainer_id == t.id ? 'selected' : ''}>${t.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select name="status" style="width:100%;padding:0.5rem;">
                            ${['lead', 'appointment_scheduled', 'initial_contact', 'proposal_sent', 'trainer_outreach', 'trainer_confirmed', 'planning', 'delivered', 'invoiced'].map(s =>
                                `<option value="${s}" ${data.status === s ? 'selected' : ''}>${s}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Startdatum</label>
                        <input type="date" name="start_date" value="${data.start_date ? data.start_date.split('T')[0] : ''}" style="width:100%;padding:0.5rem;">
                    </div>
                    <div class="form-group">
                        <label>Enddatum</label>
                        <input type="date" name="end_date" value="${data.end_date ? data.end_date.split('T')[0] : ''}" style="width:100%;padding:0.5rem;">
                    </div>
                    <div class="form-group">
                        <label>Dauer</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="number" name="duration_value" value="${durationValue}" min="1" style="flex:1;padding:0.5rem;" onchange="calculateInternalPrice()">
                            <select name="duration_type" style="width:80px;padding:0.5rem;" onchange="calculateInternalPrice()">
                                <option value="days" ${data.duration_type !== 'hours' ? 'selected' : ''}>Tage</option>
                                <option value="hours" ${data.duration_type === 'hours' ? 'selected' : ''}>Std.</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Zeitraum (Wunschzeitraum des Kunden)</label>
                    <input type="text" name="zeitraum" value="${data.zeitraum || ''}" placeholder="z.B. Q1 2025, M√§rz-April, etc." style="width:100%;padding:0.5rem;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Trainingsart</label>
                        <select name="training_type" style="width:100%;padding:0.5rem;">
                            <option value="classroom" ${data.training_type === 'classroom' ? 'selected' : ''}>Pr√§senz</option>
                            <option value="online" ${data.training_type === 'online' ? 'selected' : ''}>Online</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Format</label>
                        <select name="training_format" style="width:100%;padding:0.5rem;">
                            <option value="inhouse" ${data.training_format === 'inhouse' ? 'selected' : ''}>Inhouse</option>
                            <option value="public" ${data.training_format === 'public' ? 'selected' : ''}>√ñffentlich</option>
                        </select>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Location buchen</label>
                        <input type="text" name="location_booking" value="${data.location_booking || ''}" placeholder="z.B. Hotel, Konferenzraum..." style="width:100%;padding:0.5rem;">
                    </div>
                    <div class="form-group">
                        <label>Catering buchen</label>
                        <input type="text" name="catering_booking" value="${data.catering_booking || ''}" placeholder="z.B. Mittagessen, Getr√§nke..." style="width:100%;padding:0.5rem;">
                    </div>
                </div>
                <div class="form-group">
                    <label>Ort</label>
                    <input type="text" name="location" value="${data.location || ''}" style="width:100%;padding:0.5rem;">
                </div>

                <fieldset style="border: 1px solid #ddd; padding: 1rem; margin: 1rem 0; border-radius: 4px;">
                    <legend style="font-weight: 600; padding: 0 0.5rem; color: var(--yb-hellblau);">Kosten & Preise</legend>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Tagessatz Trainer (‚Ç¨)</label>
                            <input type="number" name="tagessatz" id="tagessatz" value="${data.tagessatz || ''}" step="0.01" style="width:100%;padding:0.5rem;" onchange="calculateInternalPrice()">
                        </div>
                        <div class="form-group">
                            <label>Location-Kosten (‚Ç¨)</label>
                            <input type="number" name="location_cost" id="location_cost" value="${data.location_cost || ''}" step="0.01" style="width:100%;padding:0.5rem;" onchange="calculateInternalPrice()">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Catering-Kosten (‚Ç¨)</label>
                            <input type="number" name="catering_cost" id="catering_cost" value="${data.catering_cost || ''}" step="0.01" style="width:100%;padding:0.5rem;" onchange="calculateInternalPrice()">
                        </div>
                        <div class="form-group">
                            <label>Provision (‚Ç¨)</label>
                            <input type="number" name="provision" id="provision" value="${data.provision || ''}" step="0.01" style="width:100%;padding:0.5rem;" onchange="calculateInternalPrice()">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Sonstige Kosten (‚Ç¨)</label>
                        <input type="number" name="other_costs" id="other_costs" value="${data.other_costs || ''}" step="0.01" style="width:100%;padding:0.5rem;" onchange="calculateInternalPrice()">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #ddd;">
                        <div class="form-group">
                            <label><strong>Preis Intern (‚Ç¨)</strong> <small style="color: #666;">(berechnet)</small></label>
                            <input type="number" name="price_internal" id="price_internal" value="${data.price_internal || ''}" step="0.01" style="width:100%;padding:0.5rem;background:#f5f5f5;" readonly>
                        </div>
                        <div class="form-group">
                            <label><strong>Preis Extern (‚Ç¨)</strong></label>
                            <input type="number" name="price_external" id="price_external" value="${data.price_external || ''}" step="0.01" style="width:100%;padding:0.5rem;" onchange="calculatePricePerParticipant()">
                        </div>
                        <div class="form-group">
                            <label><strong>Preis/Teilnehmer (‚Ç¨)</strong></label>
                            <input type="number" name="price_per_participant" id="price_per_participant" value="${data.price_per_participant || ''}" step="0.01" style="width:100%;padding:0.5rem;background:#f5f5f5;" readonly>
                        </div>
                    </div>
                </fieldset>

                <div class="form-group">
                    <label>Max. Teilnehmer</label>
                    <input type="number" name="max_participants" id="max_participants" value="${data.max_participants || ''}" style="width:100%;padding:0.5rem;" onchange="calculatePricePerParticipant()">
                </div>
                <div class="form-group">
                    <label>Interne Notizen</label>
                    <textarea name="internal_notes" style="width:100%;padding:0.5rem;min-height:60px;">${data.internal_notes || ''}</textarea>
                </div>
            `;
        }

        function calculateInternalPrice() {
            const tagessatz = parseFloat(document.getElementById('tagessatz')?.value) || 0;
            const locationCost = parseFloat(document.getElementById('location_cost')?.value) || 0;
            const cateringCost = parseFloat(document.getElementById('catering_cost')?.value) || 0;
            const provision = parseFloat(document.getElementById('provision')?.value) || 0;
            const otherCosts = parseFloat(document.getElementById('other_costs')?.value) || 0;

            // Get duration
            const durationValue = parseFloat(document.querySelector('[name="duration_value"]')?.value) || 1;
            const durationType = document.querySelector('[name="duration_type"]')?.value || 'days';
            const days = durationType === 'hours' ? durationValue / 8 : durationValue;

            // Calculate trainer cost
            const trainerCost = tagessatz * days;

            // Calculate total
            const total = trainerCost + locationCost + cateringCost + provision + otherCosts;

            const priceInternalField = document.getElementById('price_internal');
            if (priceInternalField) {
                priceInternalField.value = total.toFixed(2);
            }
        }

        function calculatePricePerParticipant() {
            const priceExternal = parseFloat(document.getElementById('price_external')?.value) || 0;
            const maxParticipants = parseInt(document.getElementById('max_participants')?.value) || 0;

            const pricePerParticipantField = document.getElementById('price_per_participant');
            if (pricePerParticipantField) {
                if (maxParticipants > 0) {
                    pricePerParticipantField.value = (priceExternal / maxParticipants).toFixed(2);
                } else {
                    pricePerParticipantField.value = '';
                }
            }
        }

        function openInlineCustomerCreate() {
            // Save current training form data
            const form = document.getElementById('createForm');
            const formData = new FormData(form);
            savedTrainingFormData = {};
            for (let [key, value] of formData.entries()) {
                if (key.startsWith('spec_')) {
                    if (!savedTrainingFormData[key]) savedTrainingFormData[key] = [];
                    savedTrainingFormData[key].push(value);
                } else {
                    savedTrainingFormData[key] = value;
                }
            }

            // Show customer form
            document.getElementById('modalTitle').textContent = 'Neuen Kunden anlegen';
            document.getElementById('modalFields').innerHTML = generateCustomerForm() + `
                <input type="hidden" name="return_to_training" value="true">
            `;
            currentFormType = 'customer';
        }

        async function returnToTrainingForm(newCustomerId = null) {
            if (savedTrainingFormData) {
                await loadFormData(); // Reload to get new customer
                if (newCustomerId) {
                    savedTrainingFormData.customer_id = newCustomerId;
                }
                currentFormType = 'training';
                document.getElementById('modalTitle').textContent = 'Training erstellen';
                document.getElementById('modalFields').innerHTML = generateTrainingForm(savedTrainingFormData);
                savedTrainingFormData = null;
            }
        }

        function generateCustomerForm() {
            return `
                <div class="form-group">
                    <label>Firma *</label>
                    <input type="text" name="company_name" required style="width:100%;padding:0.5rem;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Anrede</label>
                        <select name="salutation" style="width:100%;padding:0.5rem;">
                            <option value="">---</option>
                            <option value="Frau">Frau</option>
                            <option value="Herr">Herr</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Vorname</label>
                        <input type="text" name="first_name" style="width:100%;padding:0.5rem;">
                    </div>
                    <div class="form-group">
                        <label>Nachname</label>
                        <input type="text" name="last_name" style="width:100%;padding:0.5rem;">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" name="contact_email" style="width:100%;padding:0.5rem;">
                    </div>
                    <div class="form-group">
                        <label>Telefon</label>
                        <input type="text" name="contact_phone" style="width:100%;padding:0.5rem;">
                    </div>
                </div>
                <div class="form-group">
                    <label>VAT/USt-ID</label>
                    <input type="text" name="vat_number" style="width:100%;padding:0.5rem;">
                </div>
                <fieldset style="border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                    <legend style="font-weight: 600; padding: 0 0.5rem;">Rechnungsadresse</legend>
                    <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Stra√üe</label>
                            <input type="text" name="street" style="width:100%;padding:0.5rem;">
                        </div>
                        <div class="form-group">
                            <label>Nr.</label>
                            <input type="text" name="street_number" style="width:100%;padding:0.5rem;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem;">
                        <div class="form-group">
                            <label>PLZ</label>
                            <input type="text" name="postal_code" style="width:100%;padding:0.5rem;">
                        </div>
                        <div class="form-group">
                            <label>Ort</label>
                            <input type="text" name="city" style="width:100%;padding:0.5rem;">
                        </div>
                    </div>
                </fieldset>
                <div class="form-group">
                    <label>Konditionen</label>
                    <textarea name="conditions" style="width:100%;padding:0.5rem;min-height:60px;" placeholder="Zahlungsbedingungen, Rabatte, etc."></textarea>
                </div>
                <div class="form-group">
                    <label>Kommentar</label>
                    <textarea name="comment" style="width:100%;padding:0.5rem;min-height:80px;"></textarea>
                </div>
            `;
        }

        function generateTrainerForm() {
            return `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Vorname *</label>
                        <input type="text" name="first_name" required style="width:100%;padding:0.5rem;">
                    </div>
                    <div class="form-group">
                        <label>Nachname *</label>
                        <input type="text" name="last_name" required style="width:100%;padding:0.5rem;">
                    </div>
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" name="email" required style="width:100%;padding:0.5rem;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Telefon</label>
                        <input type="text" name="phone" style="width:100%;padding:0.5rem;">
                    </div>
                    <div class="form-group">
                        <label>VAT/USt-ID</label>
                        <input type="text" name="vat_number" style="width:100%;padding:0.5rem;">
                    </div>
                </div>
                <div class="form-group">
                    <label>Adresse</label>
                    <textarea name="address" style="width:100%;padding:0.5rem;min-height:60px;"></textarea>
                </div>
                <div class="form-group">
                    <label>LinkedIn URL</label>
                    <input type="url" name="linkedin_url" placeholder="https://linkedin.com/in/..." style="width:100%;padding:0.5rem;">
                </div>
                <div class="form-group">
                    <label>Webseite</label>
                    <input type="url" name="website" placeholder="https://www.beispiel.de" style="width:100%;padding:0.5rem;">
                </div>
                <div class="form-group">
                    <label>Spezialisierungen</label>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-bottom: 0.5rem;">
                        ${TRAINER_SPECIALIZATIONS.map(spec => `
                            <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal;">
                                <input type="checkbox" name="spec_selected" value="${spec}">
                                ${spec}
                            </label>
                        `).join('')}
                    </div>
                    <div id="customSpecsContainer">
                        <div class="custom-spec-row" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <input type="text" name="spec_custom" placeholder="Eigene Spezialisierung..." style="flex:1;padding:0.5rem;">
                        </div>
                    </div>
                    <button type="button" onclick="addCustomSpecField()" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;">+ Weitere</button>
                </div>
                <div class="form-group">
                    <label>Tagessatz (‚Ç¨)</label>
                    <input type="number" name="default_day_rate" step="0.01" style="width:100%;padding:0.5rem;">
                </div>
                <div class="form-group">
                    <label>Region</label>
                    <input type="text" name="region" style="width:100%;padding:0.5rem;">
                </div>
                <div class="form-group">
                    <label>Bio</label>
                    <textarea name="bio" style="width:100%;padding:0.5rem;min-height:80px;"></textarea>
                </div>
                <div class="form-group">
                    <label>Notizen</label>
                    <textarea name="notes" style="width:100%;padding:0.5rem;min-height:60px;"></textarea>
                </div>
            `;
        }

        function addCustomSpecField() {
            const container = document.getElementById('customSpecsContainer');
            const newRow = document.createElement('div');
            newRow.className = 'custom-spec-row';
            newRow.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem;';
            newRow.innerHTML = `<input type="text" name="spec_custom" placeholder="Eigene Spezialisierung..." style="flex:1;padding:0.5rem;">`;
            container.appendChild(newRow);
        }

        let currentFormType = '';
        let editingId = null;

        async function showCreateModal(type) {
            currentFormType = type;
            editingId = null;
            const titles = { training: 'Training', customer: 'Kunde', trainer: 'Trainer', brand: 'Marke', user: 'Benutzer', location: 'Location' };
            document.getElementById('modalTitle').textContent = `${titles[type]} erstellen`;

            // Ensure submit button is visible (may have been hidden for view-only modals)
            const submitBtn = document.querySelector('#createForm button[type="submit"]');
            if (submitBtn) submitBtn.style.display = 'block';

            const fields = formFields[type];

            if (fields === 'custom') {
                if (type === 'training') {
                    await loadFormData();
                    document.getElementById('modalFields').innerHTML = generateTrainingForm();
                } else if (type === 'trainer') {
                    document.getElementById('modalFields').innerHTML = generateTrainerForm();
                } else if (type === 'customer') {
                    document.getElementById('modalFields').innerHTML = generateCustomerForm();
                } else if (type === 'location') {
                    document.getElementById('modalFields').innerHTML = generateLocationForm();
                }
            } else {
                document.getElementById('modalFields').innerHTML = fields.map(f => `
                    <div class="form-group">
                        <label>${f.label}</label>
                        ${f.type === 'textarea'
                            ? `<textarea name="${f.name}" style="width:100%;padding:0.5rem;min-height:80px;"></textarea>`
                            : f.type === 'select'
                            ? `<select name="${f.name}" style="width:100%;padding:0.5rem;">
                                ${f.options.map(o => `<option value="${o}">${o}</option>`).join('')}
                               </select>`
                            : f.type === 'checkbox'
                            ? `<input type="checkbox" name="${f.name}" checked>`
                            : `<input type="${f.type}" name="${f.name}" ${f.required ? 'required' : ''} style="width:100%;padding:0.5rem;">`
                        }
                    </div>
                `).join('');
            }

            document.getElementById('createModal').style.display = 'flex';
        }

        async function showEditModal(type, id) {
            currentFormType = type;
            editingId = id;
            const titles = { training: 'Training', customer: 'Kunde', trainer: 'Trainer', brand: 'Marke', user: 'Benutzer', location: 'Location' };
            document.getElementById('modalTitle').textContent = `${titles[type]} bearbeiten`;

            // Ensure submit button is visible (may have been hidden for view-only modals)
            const submitBtn = document.querySelector('#createForm button[type="submit"]');
            if (submitBtn) submitBtn.style.display = 'block';

            // Load the item data
            const res = await apiCall(`/${type}s/${id}`);
            if (!res.ok) {
                alert('Fehler beim Laden');
                return;
            }
            const data = await res.json();

            const fields = formFields[type];

            if (fields === 'custom') {
                if (type === 'training') {
                    await loadFormData();
                    document.getElementById('modalFields').innerHTML = generateTrainingForm(data);
                } else if (type === 'trainer') {
                    document.getElementById('modalFields').innerHTML = generateTrainerFormWithData(data);
                } else if (type === 'customer') {
                    document.getElementById('modalFields').innerHTML = generateCustomerFormWithData(data);
                } else if (type === 'location') {
                    document.getElementById('modalFields').innerHTML = generateLocationFormWithData(data);
                }
            } else {
                document.getElementById('modalFields').innerHTML = fields.map(f => `
                    <div class="form-group">
                        <label>${f.label}</label>
                        ${f.type === 'textarea'
                            ? `<textarea name="${f.name}" style="width:100%;padding:0.5rem;min-height:80px;">${data[f.name] || ''}</textarea>`
                            : f.type === 'select'
                            ? `<select name="${f.name}" style="width:100%;padding:0.5rem;">
                                ${f.options.map(o => `<option value="${o}" ${data[f.name] === o ? 'selected' : ''}>${o}</option>`).join('')}
                               </select>`
                            : f.type === 'checkbox'
                            ? `<input type="checkbox" name="${f.name}" ${data[f.name] ? 'checked' : ''}>`
                            : `<input type="${f.type}" name="${f.name}" value="${data[f.name] || ''}" ${f.required ? 'required' : ''} style="width:100%;padding:0.5rem;">`
                        }
                    </div>
                `).join('');
            }

            document.getElementById('createModal').style.display = 'flex';
        }

        function generateCustomerFormWithData(data) {
            return `
                <div class="form-group">
                    <label>Firma *</label>
                    <input type="text" name="company_name" value="${data.company || ''}" required style="width:100%;padding:0.5rem;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Anrede</label>
                        <select name="salutation" style="width:100%;padding:0.5rem;">
                            <option value="" ${!data.salutation ? 'selected' : ''}>---</option>
                            <option value="Frau" ${data.salutation === 'Frau' ? 'selected' : ''}>Frau</option>
                            <option value="Herr" ${data.salutation === 'Herr' ? 'selected' : ''}>Herr</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Vorname</label>
                        <input type="text" name="first_name" value="${data.first_name || ''}" style="width:100%;padding:0.5rem;">
                    </div>
                    <div class="form-group">
                        <label>Nachname</label>
                        <input type="text" name="last_name" value="${data.last_name || ''}" style="width:100%;padding:0.5rem;">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" name="contact_email" value="${data.email || ''}" style="width:100%;padding:0.5rem;">
                    </div>
                    <div class="form-group">
                        <label>Telefon</label>
                        <input type="text" name="contact_phone" value="${data.phone || ''}" style="width:100%;padding:0.5rem;">
                    </div>
                </div>
                <div class="form-group">
                    <label>VAT/USt-ID</label>
                    <input type="text" name="vat_number" value="${data.vat_number || ''}" style="width:100%;padding:0.5rem;">
                </div>
                <fieldset style="border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                    <legend style="font-weight: 600; padding: 0 0.5rem;">Rechnungsadresse</legend>
                    <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Stra√üe</label>
                            <input type="text" name="street" value="${data.street || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                        <div class="form-group">
                            <label>Nr.</label>
                            <input type="text" name="street_number" value="${data.street_number || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem;">
                        <div class="form-group">
                            <label>PLZ</label>
                            <input type="text" name="postal_code" value="${data.postal_code || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                        <div class="form-group">
                            <label>Ort</label>
                            <input type="text" name="city" value="${data.city || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                    </div>
                </fieldset>
                <div class="form-group">
                    <label>Konditionen</label>
                    <textarea name="conditions" style="width:100%;padding:0.5rem;min-height:60px;">${data.conditions || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Kommentar</label>
                    <textarea name="comment" style="width:100%;padding:0.5rem;min-height:80px;">${data.comment || ''}</textarea>
                </div>
            `;
        }

        function generateLocationForm() {
            return generateLocationFormWithData({});
        }

        function generateLocationFormWithData(data) {
            return `
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" name="name" value="${data.name || ''}" required style="width:100%;padding:0.5rem;">
                </div>

                <fieldset style="border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                    <legend style="font-weight: 600; padding: 0 0.5rem;">Adresse</legend>
                    <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Stra√üe</label>
                            <input type="text" name="street" value="${data.street || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                        <div class="form-group">
                            <label>Nr.</label>
                            <input type="text" name="street_number" value="${data.street_number || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem;">
                        <div class="form-group">
                            <label>PLZ</label>
                            <input type="text" name="postal_code" value="${data.postal_code || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                        <div class="form-group">
                            <label>Ort</label>
                            <input type="text" name="city" value="${data.city || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                    </div>
                </fieldset>

                <fieldset style="border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                    <legend style="font-weight: 600; padding: 0 0.5rem;">Rechnungsadresse</legend>
                    <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Stra√üe</label>
                            <input type="text" name="billing_street" value="${data.billing_street || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                        <div class="form-group">
                            <label>Nr.</label>
                            <input type="text" name="billing_street_number" value="${data.billing_street_number || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem;">
                        <div class="form-group">
                            <label>PLZ</label>
                            <input type="text" name="billing_postal_code" value="${data.billing_postal_code || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                        <div class="form-group">
                            <label>Ort</label>
                            <input type="text" name="billing_city" value="${data.billing_city || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>VAT/USt-ID</label>
                        <input type="text" name="billing_vat" value="${data.billing_vat || ''}" style="width:100%;padding:0.5rem;">
                    </div>
                </fieldset>

                <fieldset style="border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                    <legend style="font-weight: 600; padding: 0 0.5rem;">Ansprechpartner</legend>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Vorname</label>
                            <input type="text" name="contact_first_name" value="${data.contact_first_name || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                        <div class="form-group">
                            <label>Nachname</label>
                            <input type="text" name="contact_last_name" value="${data.contact_last_name || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" name="contact_email" value="${data.contact_email || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                        <div class="form-group">
                            <label>Telefon</label>
                            <input type="text" name="contact_phone" value="${data.contact_phone || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Hinweise</label>
                        <textarea name="contact_notes" style="width:100%;padding:0.5rem;min-height:60px;">${data.contact_notes || ''}</textarea>
                    </div>
                </fieldset>

                <fieldset style="border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                    <legend style="font-weight: 600; padding: 0 0.5rem;">Location Details</legend>
                    <div class="form-group">
                        <label>Location Beschreibung</label>
                        <textarea name="description" style="width:100%;padding:0.5rem;min-height:80px;">${data.description || ''}</textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Max Teilnehmer</label>
                            <input type="number" name="max_participants" value="${data.max_participants || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                        <div class="form-group">
                            <label>Catering vorhanden</label>
                            <select name="catering_available" style="width:100%;padding:0.5rem;">
                                <option value="no" ${data.catering_available === 'no' || !data.catering_available ? 'selected' : ''}>Nein</option>
                                <option value="yes" ${data.catering_available === 'yes' ? 'selected' : ''}>Ja</option>
                                <option value="external" ${data.catering_available === 'external' ? 'selected' : ''}>Extern</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Features</label>
                        <textarea name="features" style="width:100%;padding:0.5rem;min-height:60px;" placeholder="z.B. Beamer, Whiteboard, WLAN...">${data.features || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Link zur Location</label>
                        <input type="url" name="website_link" value="${data.website_link || ''}" style="width:100%;padding:0.5rem;" placeholder="https://...">
                    </div>
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Mietkosten (‚Ç¨)</label>
                            <input type="number" name="rental_cost" value="${data.rental_cost || ''}" step="0.01" style="width:100%;padding:0.5rem;">
                        </div>
                        <div class="form-group">
                            <label>Kosten pro</label>
                            <select name="rental_cost_type" style="width:100%;padding:0.5rem;">
                                <option value="day" ${data.rental_cost_type === 'day' || !data.rental_cost_type ? 'selected' : ''}>Tag</option>
                                <option value="hour" ${data.rental_cost_type === 'hour' ? 'selected' : ''}>Stunde</option>
                                <option value="total" ${data.rental_cost_type === 'total' ? 'selected' : ''}>Gesamt</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Parken</label>
                        <textarea name="parking" style="width:100%;padding:0.5rem;min-height:60px;">${data.parking || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Anreise</label>
                        <textarea name="directions" style="width:100%;padding:0.5rem;min-height:60px;">${data.directions || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Informationen f√ºr TN</label>
                        <textarea name="participant_info" style="width:100%;padding:0.5rem;min-height:80px;">${data.participant_info || ''}</textarea>
                    </div>
                </fieldset>
            `;
        }

        function generateTrainerFormWithData(data) {
            const specs = data.specializations || {selected: [], custom: []};
            return `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Vorname *</label>
                        <input type="text" name="first_name" value="${data.first_name || ''}" required style="width:100%;padding:0.5rem;">
                    </div>
                    <div class="form-group">
                        <label>Nachname *</label>
                        <input type="text" name="last_name" value="${data.last_name || ''}" required style="width:100%;padding:0.5rem;">
                    </div>
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" name="email" value="${data.email || ''}" required style="width:100%;padding:0.5rem;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Telefon</label>
                        <input type="text" name="phone" value="${data.phone || ''}" style="width:100%;padding:0.5rem;">
                    </div>
                    <div class="form-group">
                        <label>VAT/USt-ID</label>
                        <input type="text" name="vat_number" value="${data.vat_number || ''}" style="width:100%;padding:0.5rem;">
                    </div>
                </div>
                <div class="form-group">
                    <label>Adresse</label>
                    <textarea name="address" style="width:100%;padding:0.5rem;min-height:60px;">${data.address || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>LinkedIn URL</label>
                    <input type="url" name="linkedin_url" value="${data.linkedin_url || ''}" style="width:100%;padding:0.5rem;">
                </div>
                <div class="form-group">
                    <label>Webseite</label>
                    <input type="url" name="website" value="${data.website || ''}" style="width:100%;padding:0.5rem;">
                </div>
                <div class="form-group">
                    <label>Spezialisierungen</label>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-bottom: 0.5rem;">
                        ${TRAINER_SPECIALIZATIONS.map(spec => `
                            <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal;">
                                <input type="checkbox" name="spec_selected" value="${spec}" ${specs.selected && specs.selected.includes(spec) ? 'checked' : ''}>
                                ${spec}
                            </label>
                        `).join('')}
                    </div>
                    <div id="customSpecsContainer">
                        ${(specs.custom || []).map(c => `
                            <div class="custom-spec-row" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <input type="text" name="spec_custom" value="${c}" style="flex:1;padding:0.5rem;">
                            </div>
                        `).join('')}
                        <div class="custom-spec-row" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <input type="text" name="spec_custom" placeholder="Eigene Spezialisierung..." style="flex:1;padding:0.5rem;">
                        </div>
                    </div>
                    <button type="button" onclick="addCustomSpecField()" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;">+ Weitere</button>
                </div>
                <div class="form-group">
                    <label>Tagessatz (‚Ç¨)</label>
                    <input type="number" name="default_day_rate" value="${data.default_day_rate || ''}" step="0.01" style="width:100%;padding:0.5rem;">
                </div>
                <div class="form-group">
                    <label>Region</label>
                    <input type="text" name="region" value="${data.region || ''}" style="width:100%;padding:0.5rem;">
                </div>
                <div class="form-group">
                    <label>Bio</label>
                    <textarea name="bio" style="width:100%;padding:0.5rem;min-height:80px;">${data.bio || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Notizen</label>
                    <textarea name="notes" style="width:100%;padding:0.5rem;min-height:60px;">${data.notes || ''}</textarea>
                </div>
            `;
        }

        function closeModal() {
            document.getElementById('createModal').style.display = 'none';
            // Reset submit button visibility (may have been hidden for view-only modals)
            const submitBtn = document.querySelector('#createForm button[type="submit"]');
            if (submitBtn) submitBtn.style.display = 'block';
        }

        document.getElementById('createForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            let data = {};

            const endpoints = { training: 'trainings', customer: 'customers', trainer: 'trainers', brand: 'brands', user: 'auth/register', location: 'locations' };

            if (currentFormType === 'training') {
                // Handle training form with all extended fields
                const durationValue = parseFloat(formData.get('duration_value')) || 1;
                const durationType = formData.get('duration_type') || 'days';

                data = {
                    title: formData.get('title'),
                    brand_id: formData.get('brand_id') ? parseInt(formData.get('brand_id')) : null,
                    customer_id: formData.get('customer_id') ? parseInt(formData.get('customer_id')) : null,
                    trainer_id: formData.get('trainer_id') ? parseInt(formData.get('trainer_id')) : null,
                    status: formData.get('status'),
                    start_date: formData.get('start_date') || null,
                    end_date: formData.get('end_date') || null,
                    duration_days: durationType === 'days' ? durationValue : Math.ceil(durationValue / 8),
                    duration_hours: durationType === 'hours' ? durationValue : durationValue * 8,
                    duration_type: durationType,
                    zeitraum: formData.get('zeitraum') || null,
                    training_type: formData.get('training_type'),
                    training_format: formData.get('training_format'),
                    location: formData.get('location'),
                    location_booking: formData.get('location_booking') || null,
                    catering_booking: formData.get('catering_booking') || null,
                    tagessatz: formData.get('tagessatz') ? parseFloat(formData.get('tagessatz')) : null,
                    location_cost: formData.get('location_cost') ? parseFloat(formData.get('location_cost')) : null,
                    catering_cost: formData.get('catering_cost') ? parseFloat(formData.get('catering_cost')) : null,
                    provision: formData.get('provision') ? parseFloat(formData.get('provision')) : null,
                    other_costs: formData.get('other_costs') ? parseFloat(formData.get('other_costs')) : null,
                    price_external: formData.get('price_external') ? parseFloat(formData.get('price_external')) : null,
                    price_internal: formData.get('price_internal') ? parseFloat(formData.get('price_internal')) : null,
                    price_per_participant: formData.get('price_per_participant') ? parseFloat(formData.get('price_per_participant')) : null,
                    max_participants: formData.get('max_participants') ? parseInt(formData.get('max_participants')) : null,
                    language: formData.get('language') || null,
                    online_link: formData.get('online_link') || null,
                    internal_notes: formData.get('internal_notes')
                };
            } else if (currentFormType === 'trainer') {
                // Handle trainer form specially
                data = {
                    first_name: formData.get('first_name'),
                    last_name: formData.get('last_name'),
                    email: formData.get('email'),
                    phone: formData.get('phone'),
                    address: formData.get('address'),
                    vat_number: formData.get('vat_number'),
                    linkedin_url: formData.get('linkedin_url'),
                    website: formData.get('website'),
                    default_day_rate: formData.get('default_day_rate') ? parseFloat(formData.get('default_day_rate')) : null,
                    region: formData.get('region'),
                    bio: formData.get('bio'),
                    notes: formData.get('notes'),
                    specializations: {
                        selected: formData.getAll('spec_selected'),
                        custom: formData.getAll('spec_custom').filter(s => s.trim() !== '')
                    }
                };
            } else if (currentFormType === 'customer') {
                // Handle customer form specially
                data = {
                    company_name: formData.get('company_name'),
                    first_name: formData.get('first_name'),
                    last_name: formData.get('last_name'),
                    salutation: formData.get('salutation'),
                    contact_email: formData.get('contact_email'),
                    contact_phone: formData.get('contact_phone'),
                    vat_number: formData.get('vat_number'),
                    street: formData.get('street'),
                    street_number: formData.get('street_number'),
                    postal_code: formData.get('postal_code'),
                    city: formData.get('city'),
                    conditions: formData.get('conditions'),
                    comment: formData.get('comment')
                };
            } else if (currentFormType === 'location') {
                // Handle location form
                data = {
                    name: formData.get('name'),
                    city: formData.get('city'),
                    street: formData.get('street'),
                    street_number: formData.get('street_number'),
                    postal_code: formData.get('postal_code'),
                    billing_street: formData.get('billing_street'),
                    billing_street_number: formData.get('billing_street_number'),
                    billing_postal_code: formData.get('billing_postal_code'),
                    billing_city: formData.get('billing_city'),
                    billing_vat: formData.get('billing_vat'),
                    contact_first_name: formData.get('contact_first_name'),
                    contact_last_name: formData.get('contact_last_name'),
                    contact_email: formData.get('contact_email'),
                    contact_phone: formData.get('contact_phone'),
                    contact_notes: formData.get('contact_notes'),
                    description: formData.get('description'),
                    max_participants: formData.get('max_participants') ? parseInt(formData.get('max_participants')) : null,
                    features: formData.get('features'),
                    website_link: formData.get('website_link'),
                    catering_available: formData.get('catering_available'),
                    rental_cost: formData.get('rental_cost') ? parseFloat(formData.get('rental_cost')) : null,
                    rental_cost_type: formData.get('rental_cost_type'),
                    parking: formData.get('parking'),
                    directions: formData.get('directions'),
                    participant_info: formData.get('participant_info')
                };
            } else if (currentFormType === 'user') {
                // Handle user form - checkbox needs special handling
                data = {
                    username: formData.get('username'),
                    email: formData.get('email'),
                    password: formData.get('password'),
                    role: formData.get('role'),
                    is_active: formData.get('is_active') === 'on'
                };
            } else {
                data = Object.fromEntries(formData);
            }

            // Determine if this is create or update
            const isUpdate = editingId !== null;
            let url = `/${endpoints[currentFormType]}`;
            let method = 'POST';

            if (isUpdate) {
                url = `/${endpoints[currentFormType]}/${editingId}`;
                method = 'PUT';
            }

            const res = await apiCall(url, {
                method: method,
                body: JSON.stringify(data)
            });

            console.log(`${isUpdate ? 'Update' : 'Create'} response status:`, res.status);

            if (!res.ok) {
                const error = await res.json().catch(() => ({}));
                console.error(`${isUpdate ? 'Update' : 'Create'} error:`, error);
                alert(error.error || 'Fehler beim Speichern');
                return;
            }

            const result = await res.json();
            console.log(`${isUpdate ? 'Updated' : 'Created'} item:`, result);

            // Check if we need to return to training form after creating customer
            if (currentFormType === 'customer' && formData.get('return_to_training') === 'true') {
                await returnToTrainingForm(result.id);
                return;
            }

            closeModal();
            // Special handling for users section name
            const sectionName = currentFormType === 'user' ? 'users' : endpoints[currentFormType];
            console.log('Refreshing section:', sectionName);
            showSection(sectionName);
        });

        // ========== MESSAGING FUNCTIONS ==========

        let currentMessageId = null;
        let availableUsers = [];

        async function updateUnreadCount() {
            try {
                const res = await apiCall('/messages/unread-count');
                if (res.ok) {
                    const data = await res.json();
                    const badge = document.getElementById('unreadBadge');
                    if (data.count > 0) {
                        badge.textContent = data.count > 99 ? '99+' : data.count;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            } catch (err) {
                console.error('Error updating unread count:', err);
            }
        }

        async function loadMessages() {
            try {
                const res = await apiCall('/messages');
                if (!res.ok) throw new Error('Failed to load messages');
                const messages = await res.json();

                const container = document.getElementById('messagesList');
                if (messages.length === 0) {
                    container.innerHTML = '<p style="color: #6c757d; text-align: center; padding: 2rem;">Keine Nachrichten vorhanden.</p>';
                    return;
                }

                container.innerHTML = messages.map(m => {
                    const isUnread = !m.is_read;
                    const statusBadge = (m.message_type === 'error_report' || m.message_type === 'trainer_application')
                        ? `<span class="message-status status-${m.status}">${getStatusLabel(m.status)}</span>`
                        : '';
                    let typeIcon = '‚úâÔ∏è';
                    if (m.message_type === 'error_report') typeIcon = '‚ö†Ô∏è';
                    if (m.message_type === 'trainer_application') typeIcon = 'üë§';

                    return `
                        <div class="message-item ${isUnread ? 'message-unread' : ''}" onclick="viewMessage(${m.id})">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <strong>${typeIcon} ${m.subject || '(Kein Betreff)'}</strong>
                                    ${statusBadge}
                                </div>
                            </div>
                            <div class="message-meta">
                                Von: ${m.sender_name} | ${new Date(m.created_at).toLocaleString('de-DE')}
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (err) {
                console.error('Error loading messages:', err);
                document.getElementById('messagesList').innerHTML =
                    '<p style="color: #dc3545; text-align: center;">Fehler beim Laden der Nachrichten.</p>';
            }
        }

        function getStatusLabel(status) {
            const labels = {
                'open': 'Offen',
                'solved': 'Gel√∂st',
                'not_solvable': 'Nicht l√∂sbar'
            };
            return labels[status] || status;
        }

        let currentApplicationId = null;

        async function viewMessage(id) {
            try {
                const res = await apiCall(`/messages/${id}`);
                if (!res.ok) throw new Error('Failed to load message');
                const message = await res.json();

                currentMessageId = id;
                currentApplicationId = null;

                document.getElementById('messageViewTitle').textContent = message.subject || 'Nachricht';
                document.getElementById('messageFrom').textContent = message.sender_name;
                document.getElementById('messageTo').textContent = message.recipient_name || 'Alle Admins';
                document.getElementById('messageDate').textContent = new Date(message.created_at).toLocaleString('de-DE');
                document.getElementById('messageBody').textContent = message.content;

                // Reset all special controls
                document.getElementById('messageStatusRow').style.display = 'none';
                document.getElementById('adminStatusControls').style.display = 'none';
                document.getElementById('trainerApprovalControls').style.display = 'none';

                // Show controls based on message type
                if (message.message_type === 'error_report') {
                    document.getElementById('messageStatusRow').style.display = 'block';
                    document.getElementById('messageStatusDisplay').innerHTML =
                        `<span class="message-status status-${message.status}">${getStatusLabel(message.status)}</span>`;

                    // Show admin controls for error reports
                    if (currentUser.role === 'admin' || currentUser.role === 'backoffice_user') {
                        document.getElementById('adminStatusControls').style.display = 'block';
                        document.getElementById('messageStatusSelect').value = message.status;
                    }

                    // Show page URL if available
                    if (message.page_url) {
                        document.getElementById('messageBody').textContent =
                            `Seite: ${message.page_url}\n\n${message.content}`;
                    }
                } else if (message.message_type === 'trainer_application') {
                    // Extract application ID from message content
                    const appIdMatch = message.content.match(/Application ID: (\d+)/);
                    if (appIdMatch) {
                        currentApplicationId = parseInt(appIdMatch[1]);
                    }

                    document.getElementById('messageStatusRow').style.display = 'block';
                    document.getElementById('messageStatusDisplay').innerHTML =
                        `<span class="message-status status-${message.status}">${getStatusLabel(message.status)}</span>`;

                    // Show trainer approval controls for admins/backoffice if application is pending
                    if ((currentUser.role === 'admin' || currentUser.role === 'backoffice_user') && message.status === 'open') {
                        document.getElementById('trainerApprovalControls').style.display = 'block';
                    }
                }

                document.getElementById('replyContent').value = '';
                document.getElementById('messageViewModal').style.display = 'flex';

                // Update unread count and refresh list
                updateUnreadCount();
                loadMessages();

            } catch (err) {
                console.error('Error viewing message:', err);
                alert('Fehler beim Laden der Nachricht');
            }
        }

        async function approveTrainerApplication() {
            if (!currentApplicationId) {
                alert('Keine Bewerbungs-ID gefunden');
                return;
            }

            if (!confirm('M√∂chten Sie diese Trainerbewerbung genehmigen und den Trainer anlegen?')) {
                return;
            }

            try {
                const res = await fetch(`${API_URL}/trainer/applications/${currentApplicationId}/approve`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await res.json();

                if (res.ok) {
                    alert('Trainer wurde erfolgreich angelegt!');
                    // Mark message as solved
                    await fetch(`${API_URL}/messages/${currentMessageId}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ status: 'solved' })
                    });
                    closeMessageViewModal();
                    loadMessages();
                } else {
                    alert(result.error || 'Fehler beim Anlegen des Trainers');
                }
            } catch (err) {
                console.error('Error approving application:', err);
                alert('Fehler beim Genehmigen der Bewerbung');
            }
        }

        async function rejectTrainerApplication() {
            if (!currentApplicationId) {
                alert('Keine Bewerbungs-ID gefunden');
                return;
            }

            if (!confirm('M√∂chten Sie diese Trainerbewerbung ablehnen?')) {
                return;
            }

            try {
                const res = await fetch(`${API_URL}/trainer/applications/${currentApplicationId}/reject`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await res.json();

                if (res.ok) {
                    alert('Bewerbung wurde abgelehnt');
                    // Mark message as not solvable
                    await fetch(`${API_URL}/messages/${currentMessageId}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ status: 'not_solvable' })
                    });
                    closeMessageViewModal();
                    loadMessages();
                } else {
                    alert(result.error || 'Fehler beim Ablehnen der Bewerbung');
                }
            } catch (err) {
                console.error('Error rejecting application:', err);
                alert('Fehler beim Ablehnen der Bewerbung');
            }
        }

        async function updateMessageStatus() {
            if (!currentMessageId) return;

            const status = document.getElementById('messageStatusSelect').value;
            try {
                const res = await fetch(`${API_URL}/messages/${currentMessageId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status })
                });

                if (res.ok) {
                    alert('Status aktualisiert');
                    document.getElementById('messageStatusDisplay').innerHTML =
                        `<span class="message-status status-${status}">${getStatusLabel(status)}</span>`;
                    loadMessages();
                } else {
                    const error = await res.json();
                    alert(error.error || 'Fehler beim Aktualisieren');
                }
            } catch (err) {
                console.error('Error updating status:', err);
                alert('Fehler beim Aktualisieren');
            }
        }

        async function sendReply() {
            if (!currentMessageId) return;

            const content = document.getElementById('replyContent').value.trim();
            if (!content) {
                alert('Bitte geben Sie eine Antwort ein');
                return;
            }

            try {
                // Get the original message to reply to the sender
                const res = await apiCall(`/messages/${currentMessageId}`);
                const originalMessage = await res.json();

                const replyRes = await fetch(`${API_URL}/messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        recipient_id: originalMessage.sender_id,
                        subject: `Re: ${originalMessage.subject || '(Kein Betreff)'}`,
                        content: content,
                        parent_id: currentMessageId,
                        message_type: 'message'
                    })
                });

                if (replyRes.ok) {
                    alert('Antwort gesendet');
                    document.getElementById('replyContent').value = '';
                    closeMessageViewModal();
                    loadMessages();
                } else {
                    const error = await replyRes.json();
                    alert(error.error || 'Fehler beim Senden');
                }
            } catch (err) {
                console.error('Error sending reply:', err);
                alert('Fehler beim Senden der Antwort');
            }
        }

        async function deleteCurrentMessage() {
            if (!currentMessageId) return;

            if (!confirm('M√∂chten Sie diese Nachricht wirklich l√∂schen?')) return;

            try {
                const res = await fetch(`${API_URL}/messages/${currentMessageId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (res.ok) {
                    closeMessageViewModal();
                    loadMessages();
                    updateUnreadCount();
                } else {
                    const error = await res.json();
                    alert(error.error || 'Fehler beim L√∂schen');
                }
            } catch (err) {
                console.error('Error deleting message:', err);
                alert('Fehler beim L√∂schen');
            }
        }

        function closeMessageViewModal() {
            document.getElementById('messageViewModal').style.display = 'none';
            currentMessageId = null;
        }

        // Error Report Modal
        function showErrorReportModal() {
            document.getElementById('errorPageUrl').value = window.location.href;
            document.getElementById('errorReportForm').reset();
            document.getElementById('errorReportModal').style.display = 'flex';
        }

        function closeErrorReportModal() {
            document.getElementById('errorReportModal').style.display = 'none';
        }

        document.getElementById('errorReportForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const data = {
                message_type: 'error_report',
                subject: formData.get('subject'),
                content: formData.get('content'),
                page_url: formData.get('page_url'),
                recipient_id: null  // Send to all admins
            };

            try {
                const res = await fetch(`${API_URL}/messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    alert('Fehlermeldung wurde gesendet. Vielen Dank!');
                    closeErrorReportModal();
                } else {
                    const error = await res.json();
                    alert(error.error || 'Fehler beim Senden');
                }
            } catch (err) {
                console.error('Error sending error report:', err);
                alert('Fehler beim Senden der Meldung');
            }
        });

        // New Message Modal
        async function showNewMessageModal() {
            // Load available users
            try {
                const res = await apiCall('/users/list');
                if (res.ok) {
                    availableUsers = await res.json();
                    const select = document.getElementById('messageRecipient');
                    select.innerHTML = '<option value="">Bitte w√§hlen...</option>';

                    // Group by role
                    const admins = availableUsers.filter(u => u.role === 'admin');
                    const trainers = availableUsers.filter(u => u.role === 'trainer');

                    if (admins.length > 0) {
                        select.innerHTML += '<optgroup label="Admins">' +
                            admins.map(u => `<option value="${u.id}">${u.username}</option>`).join('') +
                            '</optgroup>';
                    }
                    if (trainers.length > 0) {
                        select.innerHTML += '<optgroup label="Trainer">' +
                            trainers.map(u => `<option value="${u.id}">${u.username}</option>`).join('') +
                            '</optgroup>';
                    }
                }
            } catch (err) {
                console.error('Error loading users:', err);
            }

            document.getElementById('newMessageForm').reset();
            document.getElementById('newMessageModal').style.display = 'flex';
        }

        function closeNewMessageModal() {
            document.getElementById('newMessageModal').style.display = 'none';
        }

        document.getElementById('newMessageForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const recipientId = formData.get('recipient_id');

            if (!recipientId) {
                alert('Bitte w√§hlen Sie einen Empf√§nger');
                return;
            }

            const data = {
                message_type: 'message',
                recipient_id: parseInt(recipientId),
                subject: formData.get('subject'),
                content: formData.get('content')
            };

            try {
                const res = await fetch(`${API_URL}/messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    alert('Nachricht gesendet');
                    closeNewMessageModal();
                    loadMessages();
                } else {
                    const error = await res.json();
                    alert(error.error || 'Fehler beim Senden');
                }
            } catch (err) {
                console.error('Error sending message:', err);
                alert('Fehler beim Senden');
            }
        });
    </script>
</body>
</html>
