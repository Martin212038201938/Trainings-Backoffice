<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yellow-Boat Academy</title>
    <!-- Modern 2025 Design with Micro-Animations and 3D Effects -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* ===== CSS CUSTOM PROPERTIES - Modern 2025 Design System ===== */
        :root {
            /* Primary Colors */
            --yb-hellblau: #488BCB;
            --yb-gelb: #FDD850;
            --yb-grau: #939597;
            --yb-grau-light: #A4B1BA;
            --yb-hellblau-light: #6ba3d6;
            --yb-hellblau-dark: #3a7ab8;

            /* Extended Palette */
            --yb-hellblau-50: #e8f4fc;
            --yb-hellblau-100: #c5e0f5;
            --yb-hellblau-200: #9ecbee;
            --yb-hellblau-900: #1a3a5c;
            --yb-gelb-light: #fff0b3;
            --yb-gelb-dark: #e6b800;

            /* Neutral Colors */
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;

            /* Semantic Colors */
            --success: #10b981;
            --success-light: #d1fae5;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --danger: #ef4444;
            --danger-light: #fee2e2;
            --info: #3b82f6;
            --info-light: #dbeafe;

            /* 3D & Shadow System */
            --shadow-color: 220 60% 50%;
            --shadow-xs: 0 1px 2px hsl(var(--shadow-color) / 0.05);
            --shadow-sm: 0 1px 3px hsl(var(--shadow-color) / 0.1), 0 1px 2px hsl(var(--shadow-color) / 0.06);
            --shadow-md: 0 4px 6px -1px hsl(var(--shadow-color) / 0.1), 0 2px 4px -2px hsl(var(--shadow-color) / 0.1);
            --shadow-lg: 0 10px 15px -3px hsl(var(--shadow-color) / 0.1), 0 4px 6px -4px hsl(var(--shadow-color) / 0.1);
            --shadow-xl: 0 20px 25px -5px hsl(var(--shadow-color) / 0.1), 0 8px 10px -6px hsl(var(--shadow-color) / 0.1);
            --shadow-2xl: 0 25px 50px -12px hsl(var(--shadow-color) / 0.25);
            --shadow-inner: inset 0 2px 4px 0 hsl(var(--shadow-color) / 0.05);
            --shadow-glow: 0 0 20px hsl(var(--shadow-color) / 0.15);
            --shadow-3d: 0 20px 40px -15px rgba(72, 139, 203, 0.3), 0 10px 20px -10px rgba(0, 0, 0, 0.1);

            /* Animation Timing */
            --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
            --ease-out-back: cubic-bezier(0.34, 1.56, 0.64, 1);
            --ease-in-out-circ: cubic-bezier(0.85, 0, 0.15, 1);
            --ease-spring: cubic-bezier(0.175, 0.885, 0.32, 1.275);

            /* Durations */
            --duration-fast: 150ms;
            --duration-normal: 250ms;
            --duration-slow: 400ms;
            --duration-slower: 600ms;

            /* Border Radius */
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-2xl: 32px;
            --radius-full: 9999px;

            /* Glassmorphism */
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.5);
            --glass-blur: 20px;
        }

        /* ===== KEYFRAME ANIMATIONS ===== */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.8;
            }
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes glow {
            0%, 100% {
                box-shadow: 0 0 5px var(--yb-gelb), 0 0 10px var(--yb-gelb), 0 0 15px var(--yb-gelb);
            }
            50% {
                box-shadow: 0 0 10px var(--yb-gelb), 0 0 20px var(--yb-gelb), 0 0 30px var(--yb-gelb);
            }
        }

        @keyframes cardEntrance {
            from {
                opacity: 0;
                transform: translateY(30px) rotateX(-10deg);
            }
            to {
                opacity: 1;
                transform: translateY(0) rotateX(0);
            }
        }

        /* ===== BASE STYLES ===== */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--gray-100) 0%, var(--yb-hellblau-50) 100%);
            min-height: 100vh;
            color: var(--gray-800);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ===== LOGIN SCREEN ===== */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--yb-hellblau-900) 0%, var(--yb-hellblau) 50%, var(--yb-hellblau-light) 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            position: relative;
            overflow: hidden;
        }

        /* Animated background shapes */
        .login-container::before,
        .login-container::after {
            content: '';
            position: absolute;
            border-radius: 50%;
            background: rgba(253, 216, 80, 0.1);
            animation: float 6s ease-in-out infinite;
        }

        .login-container::before {
            width: 400px;
            height: 400px;
            top: -100px;
            right: -100px;
            animation-delay: 0s;
        }

        .login-container::after {
            width: 300px;
            height: 300px;
            bottom: -50px;
            left: -50px;
            animation-delay: 3s;
        }

        .login-box {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            padding: 2.5rem;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-2xl), 0 0 0 1px var(--glass-border);
            width: 100%;
            max-width: 420px;
            position: relative;
            z-index: 1;
            animation: scaleIn 0.6s var(--ease-out-expo);
            transform-style: preserve-3d;
            transition: transform var(--duration-normal) var(--ease-out-expo),
                        box-shadow var(--duration-normal) var(--ease-out-expo);
        }

        .login-box:hover {
            transform: translateY(-5px) rotateX(2deg);
            box-shadow: var(--shadow-2xl), 0 30px 60px -20px rgba(72, 139, 203, 0.3);
        }

        .login-box h1 {
            margin-bottom: 1.5rem;
            color: var(--yb-hellblau-dark);
            text-align: center;
            font-weight: 700;
            font-size: 1.75rem;
            letter-spacing: -0.025em;
        }

        .login-logo {
            display: block;
            margin: 0 auto 1.5rem;
            max-width: 100px;
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
            animation: float 4s ease-in-out infinite;
            transition: transform var(--duration-normal) var(--ease-out-expo);
        }

        .login-logo:hover {
            transform: scale(1.1) rotate(5deg);
        }

        /* ===== FORM STYLES ===== */
        .form-group {
            margin-bottom: 1.25rem;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--gray-600);
            font-size: 0.875rem;
            transition: color var(--duration-fast) ease;
        }

        .form-group:focus-within label {
            color: var(--yb-hellblau);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-family: inherit;
            background: white;
            transition: all var(--duration-normal) var(--ease-out-expo);
            box-shadow: var(--shadow-xs);
        }

        .form-group input:hover,
        .form-group select:hover,
        .form-group textarea:hover {
            border-color: var(--gray-300);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--yb-hellblau);
            box-shadow: 0 0 0 4px rgba(72, 139, 203, 0.15), var(--shadow-sm);
            transform: translateY(-1px);
        }

        .form-group input::placeholder {
            color: var(--gray-400);
        }

        /* ===== BUTTONS ===== */
        .btn {
            padding: 0.875rem 1.75rem;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
            transition: all var(--duration-normal) var(--ease-out-expo);
            transform-style: preserve-3d;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--yb-gelb) 0%, var(--yb-gelb-dark) 100%);
            color: var(--gray-800);
            width: 100%;
            box-shadow: 0 4px 14px rgba(253, 216, 80, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 25px rgba(253, 216, 80, 0.5);
        }

        .btn-primary:active {
            transform: translateY(-1px) scale(0.98);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--yb-gelb) 0%, var(--yb-gelb-dark) 100%);
            color: var(--gray-800);
            box-shadow: 0 4px 14px rgba(253, 216, 80, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(253, 216, 80, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--gray-400) 0%, var(--gray-500) 100%);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            border-radius: var(--radius-sm);
        }

        .error {
            color: var(--danger);
            margin-top: 1rem;
            padding: 0.75rem 1rem;
            background: var(--danger-light);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            animation: fadeInUp 0.3s var(--ease-out-expo);
        }

        /* ===== APP CONTAINER & HEADER ===== */
        .app-container {
            display: none;
            animation: fadeIn 0.5s var(--ease-out-expo);
        }

        .header {
            background: linear-gradient(135deg, var(--yb-hellblau-dark) 0%, var(--yb-hellblau) 50%, var(--yb-hellblau-light) 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(72, 139, 203, 0.3);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 700;
            letter-spacing: -0.025em;
        }

        .header-logo {
            height: 40px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
            transition: transform var(--duration-normal) var(--ease-out-expo);
        }

        .header-logo:hover {
            transform: scale(1.1) rotate(-5deg);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn-logout {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            color: white;
            padding: 0.625rem 1.25rem;
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: var(--radius-full);
            font-weight: 500;
        }

        .btn-logout:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        /* ===== MAIN LAYOUT ===== */
        .main-content {
            display: flex;
            min-height: calc(100vh - 68px);
        }

        .sidebar {
            width: 260px;
            background: white;
            border-right: 1px solid var(--gray-200);
            padding: 1.5rem 0;
            box-shadow: var(--shadow-lg);
            position: sticky;
            top: 68px;
            height: calc(100vh - 68px);
            overflow-y: auto;
            transition: transform var(--duration-normal) var(--ease-out-expo);
        }

        .sidebar a {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1.5rem;
            color: var(--gray-600);
            text-decoration: none;
            transition: all var(--duration-normal) var(--ease-out-expo);
            font-weight: 500;
            border-left: 3px solid transparent;
            margin: 0.25rem 0;
            position: relative;
        }

        .sidebar a::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%) scaleY(0);
            width: 3px;
            height: 60%;
            background: var(--yb-gelb);
            border-radius: var(--radius-full);
            transition: transform var(--duration-normal) var(--ease-out-expo);
        }

        .sidebar a:hover {
            background: linear-gradient(90deg, var(--yb-hellblau-50) 0%, transparent 100%);
            color: var(--yb-hellblau);
            transform: translateX(5px);
        }

        .sidebar a:hover::after {
            transform: translateY(-50%) scaleY(1);
        }

        .sidebar a.active {
            background: linear-gradient(90deg, var(--yb-hellblau-100) 0%, var(--yb-hellblau-50) 100%);
            border-left-color: var(--yb-gelb);
            color: var(--yb-hellblau-dark);
            font-weight: 600;
        }

        .sidebar a.active::after {
            transform: translateY(-50%) scaleY(1);
            background: var(--yb-hellblau);
        }

        /* ===== CONTENT AREA ===== */
        .content {
            flex: 1;
            padding: 2rem;
            background: linear-gradient(180deg, var(--gray-50) 0%, var(--yb-hellblau-50) 100%);
            min-height: calc(100vh - 68px);
        }

        .section {
            animation: fadeInUp 0.5s var(--ease-out-expo);
        }

        /* ===== CARDS ===== */
        .card {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            margin-bottom: 1.5rem;
            border: 1px solid var(--gray-100);
            overflow: hidden;
            transition: all var(--duration-normal) var(--ease-out-expo);
            animation: cardEntrance 0.6s var(--ease-out-expo);
            transform-style: preserve-3d;
        }

        .card:hover {
            box-shadow: var(--shadow-xl);
            transform: translateY(-4px);
        }

        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--gray-100);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--yb-hellblau-dark);
            background: linear-gradient(90deg, var(--gray-50) 0%, white 100%);
            font-size: 1.1rem;
        }

        .card-body {
            padding: 1.5rem;
        }

        /* ===== TABLES ===== */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-100);
            transition: background var(--duration-fast) ease;
        }

        th {
            font-weight: 600;
            background: var(--gray-50);
            color: var(--gray-600);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        tr {
            transition: all var(--duration-fast) ease;
        }

        tbody tr:hover {
            background: var(--yb-hellblau-50);
            transform: scale(1.005);
        }

        tbody tr:hover td {
            color: var(--yb-hellblau-dark);
        }

        /* ===== STATS CARDS ===== */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
            perspective: 1000px;
        }

        .stat-card {
            background: white;
            padding: 1.75rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border-top: 4px solid var(--yb-gelb);
            position: relative;
            overflow: hidden;
            transition: all var(--duration-normal) var(--ease-out-expo);
            animation: cardEntrance 0.6s var(--ease-out-expo) backwards;
            transform-style: preserve-3d;
        }

        .stat-card:nth-child(1) { animation-delay: 0.1s; }
        .stat-card:nth-child(2) { animation-delay: 0.2s; }
        .stat-card:nth-child(3) { animation-delay: 0.3s; }
        .stat-card:nth-child(4) { animation-delay: 0.4s; }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, var(--yb-gelb-light) 0%, transparent 70%);
            opacity: 0;
            transition: opacity var(--duration-normal) ease;
        }

        .stat-card:hover {
            transform: translateY(-8px) rotateX(5deg) rotateY(-5deg);
            box-shadow: var(--shadow-3d);
        }

        .stat-card:hover::before {
            opacity: 0.3;
        }

        .stat-card h3 {
            font-size: 2.5rem;
            color: var(--yb-hellblau);
            font-weight: 800;
            line-height: 1;
            position: relative;
            display: inline-block;
        }

        .stat-card p {
            color: var(--gray-500);
            margin-top: 0.5rem;
            font-weight: 500;
            font-size: 0.95rem;
        }

        /* ===== MODALS ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            padding: 2rem;
            z-index: 1000;
            animation: fadeIn 0.3s var(--ease-out-expo);
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: var(--radius-xl);
            width: 100%;
            max-width: 720px;
            max-height: 90vh;
            overflow-y: auto;
            margin: auto;
            box-shadow: var(--shadow-2xl);
            animation: scaleIn 0.4s var(--ease-out-expo);
            border: 1px solid var(--gray-100);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--yb-hellblau-100);
        }

        .modal-header h2 {
            color: var(--yb-hellblau-dark);
            font-weight: 700;
        }

        .close {
            cursor: pointer;
            font-size: 1.75rem;
            color: var(--gray-400);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-full);
            transition: all var(--duration-fast) ease;
        }

        .close:hover {
            color: var(--danger);
            background: var(--danger-light);
            transform: rotate(90deg);
        }

        /* ===== HEADINGS ===== */
        h2 {
            color: var(--yb-hellblau-dark);
            font-weight: 700;
            font-size: 1.75rem;
            letter-spacing: -0.025em;
            margin-bottom: 1.5rem;
            position: relative;
            display: inline-block;
        }

        h2::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 60px;
            height: 4px;
            background: linear-gradient(90deg, var(--yb-gelb) 0%, var(--yb-hellblau) 100%);
            border-radius: var(--radius-full);
        }

        /* ===== BADGES ===== */
        .badge {
            background: linear-gradient(135deg, var(--yb-hellblau) 0%, var(--yb-hellblau-dark) 100%) !important;
            padding: 0.375rem 0.875rem;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
        }

        /* ===== NOTIFICATION SYSTEM ===== */
        .notification-bell {
            position: relative;
            cursor: pointer;
            font-size: 1.5rem;
            color: white;
            padding: 0.625rem;
            border-radius: var(--radius-full);
            transition: all var(--duration-normal) var(--ease-out-expo);
            background: rgba(255, 255, 255, 0.1);
        }

        .notification-bell:hover {
            color: var(--yb-gelb);
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1) rotate(15deg);
        }

        .notification-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            color: white;
            border-radius: var(--radius-full);
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            animation: pulse 2s infinite;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.5);
        }

        .btn-error-report {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            color: white;
            padding: 0.5rem 1rem;
            border: 1px solid rgba(255, 255, 255, 0.25);
            font-size: 0.875rem;
            border-radius: var(--radius-full);
            font-weight: 500;
        }

        .btn-error-report:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        /* ===== MESSAGES ===== */
        .message-unread {
            font-weight: 600;
            background: linear-gradient(90deg, var(--info-light) 0%, white 100%);
            border-left: 4px solid var(--info);
        }

        .message-item {
            padding: 1.25rem;
            border-bottom: 1px solid var(--gray-100);
            cursor: pointer;
            transition: all var(--duration-normal) var(--ease-out-expo);
            border-radius: var(--radius-sm);
            margin: 0.5rem 0;
        }

        .message-item:hover {
            background: var(--yb-hellblau-50);
            transform: translateX(8px);
            box-shadow: var(--shadow-sm);
        }

        .message-item:last-child {
            border-bottom: none;
        }

        .message-meta {
            font-size: 0.85rem;
            color: var(--gray-500);
            margin-top: 0.5rem;
        }

        .message-status {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .status-open {
            background: var(--warning-light);
            color: var(--warning);
        }

        .status-solved {
            background: var(--success-light);
            color: var(--success);
        }

        .status-not_solvable {
            background: var(--gray-200);
            color: var(--gray-600);
        }

        /* ===== TRAINER PROFILE MODAL ===== */
        .trainer-profile-modal .modal-content {
            max-width: 950px;
        }

        .trainer-profile-header {
            display: flex;
            gap: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 3px solid var(--yb-gelb);
            margin-bottom: 2rem;
            position: relative;
        }

        .trainer-profile-header::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            width: 100px;
            height: 3px;
            background: var(--yb-hellblau);
        }

        .trainer-profile-photo {
            width: 160px;
            height: 160px;
            border-radius: var(--radius-full);
            object-fit: cover;
            border: 5px solid var(--yb-hellblau);
            flex-shrink: 0;
            box-shadow: var(--shadow-xl);
            transition: all var(--duration-normal) var(--ease-out-expo);
        }

        .trainer-profile-photo:hover {
            transform: scale(1.05) rotate(3deg);
            box-shadow: var(--shadow-2xl);
        }

        .trainer-profile-photo-placeholder {
            width: 160px;
            height: 160px;
            border-radius: var(--radius-full);
            background: linear-gradient(135deg, var(--gray-300) 0%, var(--gray-400) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.5rem;
            color: white;
            flex-shrink: 0;
            box-shadow: var(--shadow-lg);
        }

        .trainer-profile-main {
            flex: 1;
        }

        .trainer-profile-name {
            font-size: 2rem;
            color: var(--yb-hellblau-dark);
            margin-bottom: 0.75rem;
            font-weight: 700;
        }

        .trainer-profile-contact {
            display: flex;
            flex-wrap: wrap;
            gap: 1.25rem;
            margin-bottom: 1rem;
        }

        .trainer-profile-contact-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--gray-600);
            font-size: 0.95rem;
        }

        .trainer-profile-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .trainer-profile-badge {
            background: linear-gradient(135deg, var(--yb-hellblau) 0%, var(--yb-hellblau-dark) 100%);
            color: white;
            padding: 0.375rem 1rem;
            border-radius: var(--radius-full);
            font-size: 0.85rem;
            font-weight: 500;
            transition: all var(--duration-fast) ease;
        }

        .trainer-profile-badge:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .trainer-profile-section {
            margin-bottom: 2rem;
        }

        .trainer-profile-section-title {
            font-size: 1.15rem;
            color: var(--yb-hellblau-dark);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--gray-100);
            font-weight: 600;
        }

        .trainer-profile-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.25rem;
        }

        .trainer-profile-field {
            margin-bottom: 0.5rem;
            padding: 0.75rem;
            background: var(--gray-50);
            border-radius: var(--radius-sm);
            transition: all var(--duration-fast) ease;
        }

        .trainer-profile-field:hover {
            background: var(--yb-hellblau-50);
        }

        .trainer-profile-field-label {
            font-size: 0.8rem;
            color: var(--gray-500);
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
        }

        .trainer-profile-field-value {
            color: var(--gray-800);
            font-weight: 500;
        }

        .trainer-profile-trainings {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .trainer-profile-training-card {
            background: white;
            padding: 1.25rem;
            border-radius: var(--radius-md);
            border-left: 5px solid var(--yb-gelb);
            box-shadow: var(--shadow-sm);
            transition: all var(--duration-normal) var(--ease-out-expo);
        }

        .trainer-profile-training-card:hover {
            transform: translateX(8px);
            box-shadow: var(--shadow-md);
        }

        .trainer-profile-training-title {
            font-weight: 600;
            color: var(--yb-hellblau-dark);
            margin-bottom: 0.5rem;
            font-size: 1.05rem;
        }

        .trainer-profile-training-meta {
            font-size: 0.85rem;
            color: var(--gray-500);
        }

        .trainer-profile-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.25rem;
            margin-bottom: 2rem;
        }

        .trainer-profile-stat {
            background: white;
            padding: 1.5rem;
            border-radius: var(--radius-md);
            text-align: center;
            border-top: 4px solid var(--yb-gelb);
            box-shadow: var(--shadow-sm);
            transition: all var(--duration-normal) var(--ease-out-expo);
        }

        .trainer-profile-stat:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .trainer-profile-stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--yb-hellblau);
            line-height: 1;
        }

        .trainer-profile-stat-label {
            font-size: 0.85rem;
            color: var(--gray-500);
            margin-top: 0.5rem;
            font-weight: 500;
        }

        .trainer-profile-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 2px solid var(--gray-100);
        }

        .trainer-application-table {
            width: 100%;
            font-size: 0.9rem;
        }

        .trainer-application-table th {
            background: var(--gray-50);
            padding: 0.75rem;
            font-weight: 600;
        }

        .trainer-application-table td {
            padding: 0.75rem;
        }

        /* ===== STATUS BADGES ===== */
        .status-accepted {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
            padding: 0.3rem 0.75rem;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .status-rejected {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            color: white;
            padding: 0.3rem 0.75rem;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-pending {
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
            color: white;
            padding: 0.3rem 0.75rem;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
            animation: pulse 2s infinite;
        }

        /* ===== FIELDSETS ===== */
        fieldset {
            border: 2px solid var(--gray-200);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: var(--radius-lg);
            background: white;
            transition: all var(--duration-normal) var(--ease-out-expo);
        }

        fieldset:hover {
            border-color: var(--yb-hellblau-light);
            box-shadow: var(--shadow-sm);
        }

        legend {
            font-weight: 600;
            padding: 0.25rem 1rem;
            color: var(--yb-hellblau-dark);
            background: white;
            border-radius: var(--radius-sm);
            font-size: 0.95rem;
        }

        /* ===== SCROLLBAR STYLING ===== */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--gray-100);
            border-radius: var(--radius-full);
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--yb-hellblau-light) 0%, var(--yb-hellblau) 100%);
            border-radius: var(--radius-full);
            border: 2px solid var(--gray-100);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, var(--yb-hellblau) 0%, var(--yb-hellblau-dark) 100%);
        }

        /* ===== SELECTION STYLING ===== */
        ::selection {
            background: var(--yb-gelb);
            color: var(--gray-900);
        }

        /* ===== LOADING SKELETON ===== */
        .skeleton {
            background: linear-gradient(90deg, var(--gray-200) 25%, var(--gray-100) 50%, var(--gray-200) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: var(--radius-sm);
        }

        /* ===== TOOLTIPS ===== */
        [data-tooltip] {
            position: relative;
        }

        [data-tooltip]::before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-5px);
            background: var(--gray-900);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all var(--duration-fast) ease;
            z-index: 1000;
        }

        [data-tooltip]:hover::before {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 1024px) {
            .sidebar {
                width: 220px;
            }

            .trainer-profile-grid {
                grid-template-columns: 1fr;
            }

            .trainer-profile-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -280px;
                top: 68px;
                height: calc(100vh - 68px);
                z-index: 99;
                transition: left var(--duration-normal) var(--ease-out-expo);
            }

            .sidebar.open {
                left: 0;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .trainer-profile-header {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .trainer-profile-stats {
                grid-template-columns: 1fr;
            }

            .modal-content {
                padding: 1.5rem;
                margin: 1rem;
            }
        }

        /* ===== PRINT STYLES ===== */
        @media print {
            .sidebar, .header, .btn {
                display: none !important;
            }

            .content {
                padding: 0;
            }

            .card {
                box-shadow: none;
                border: 1px solid var(--gray-300);
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-box" id="loginBox">
            <img src="https://www.yellow-boat.com/wp-content/uploads/2016/10/yellowBoatLogoico.png" alt="Yellow-Boat Academy" class="login-logo">
            <h1>Yellow-Boat Academy</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Benutzername / E-Mail</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Passwort</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn btn-primary">Anmelden</button>
                <div class="error" id="loginError"></div>
            </form>
            <div style="margin-top: 1.5rem; text-align: center; border-top: 1px solid #ddd; padding-top: 1rem;">
                <a href="#" onclick="showTrainerApplicationForm()" style="color: var(--yb-hellblau); text-decoration: none;">Als Trainer bewerben</a>
            </div>
        </div>

        <!-- Trainer Application Form - Step 1 -->
        <div class="login-box" id="applicationStep1" style="display: none; max-width: 500px;">
            <img src="https://www.yellow-boat.com/wp-content/uploads/2016/10/yellowBoatLogoico.png" alt="Yellow-Boat Academy" class="login-logo">
            <h1 style="font-size: 1.3rem;">Trainer-Bewerbung</h1>
            <p style="text-align: center; color: #666; margin-bottom: 1rem;">Schritt 1 von 2</p>
            <form id="applicationFormStep1">
                <fieldset style="border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                    <legend style="font-weight: 600; padding: 0 0.5rem; color: var(--yb-hellblau);">Login-Daten</legend>
                    <div class="form-group">
                        <label>E-Mail-Adresse * (wird auch als Benutzername verwendet)</label>
                        <input type="email" name="email" id="appEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Passwort *</label>
                        <input type="password" name="password" id="appPassword" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label>Passwort bestätigen *</label>
                        <input type="password" name="password_confirm" id="appPasswordConfirm" required minlength="6">
                    </div>
                </fieldset>

                <fieldset style="border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                    <legend style="font-weight: 600; padding: 0 0.5rem; color: var(--yb-hellblau);">Persönliche Daten</legend>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Vorname *</label>
                            <input type="text" name="first_name" id="appFirstName" required>
                        </div>
                        <div class="form-group">
                            <label>Nachname *</label>
                            <input type="text" name="last_name" id="appLastName" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Telefon *</label>
                        <input type="tel" name="phone" id="appPhone" required>
                    </div>
                </fieldset>

                <button type="submit" class="btn btn-primary">Weiter zu Schritt 2</button>
                <div class="error" id="applicationError1"></div>
            </form>
            <div style="margin-top: 1rem; text-align: center;">
                <a href="#" onclick="showLoginForm()" style="color: var(--yb-hellblau); text-decoration: none;">Zurück zum Login</a>
            </div>
        </div>

        <!-- Trainer Application Form - Step 2 -->
        <div class="login-box" id="applicationStep2" style="display: none; max-width: 700px;">
            <img src="https://www.yellow-boat.com/wp-content/uploads/2016/10/yellowBoatLogoico.png" alt="Yellow-Boat Academy" class="login-logo">
            <h1 style="font-size: 1.3rem;">Trainer-Bewerbung</h1>
            <p style="text-align: center; color: #666; margin-bottom: 1rem;">Schritt 2 von 2</p>
            <form id="applicationFormStep2">
                <fieldset style="border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                    <legend style="font-weight: 600; padding: 0 0.5rem; color: var(--yb-hellblau);">Adresse</legend>
                    <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Straße</label>
                            <input type="text" name="street">
                        </div>
                        <div class="form-group">
                            <label>Hausnr.</label>
                            <input type="text" name="house_number">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem;">
                        <div class="form-group">
                            <label>PLZ</label>
                            <input type="text" name="postal_code">
                        </div>
                        <div class="form-group">
                            <label>Ort</label>
                            <input type="text" name="city">
                        </div>
                    </div>
                </fieldset>

                <fieldset style="border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                    <legend style="font-weight: 600; padding: 0 0.5rem; color: var(--yb-hellblau);">Berufliche Informationen</legend>
                    <div class="form-group">
                        <label>Region</label>
                        <input type="text" name="region" placeholder="z.B. Bayern, NRW">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>USt-IdNr.</label>
                            <input type="text" name="vat_number">
                        </div>
                        <div class="form-group">
                            <label>Kontonummer / IBAN</label>
                            <input type="text" name="bank_account" placeholder="DE...">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Weitere Informationen</label>
                        <textarea name="additional_info" style="width:100%; min-height: 100px;" placeholder="Beschreiben Sie Ihre Erfahrung und Qualifikationen..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Spezialisierungen (kommagetrennt)</label>
                        <input type="text" name="specializations" placeholder="z.B. Agile, Scrum, Leadership">
                    </div>
                    <div class="form-group">
                        <label>LinkedIn Profil</label>
                        <div style="display: flex; align-items: center;">
                            <span style="background: #e9ecef; padding: 0.5rem; border: 1px solid #ced4da; border-right: none; border-radius: 4px 0 0 4px; font-size: 0.85rem; white-space: nowrap;">linkedin.com/in/</span>
                            <input type="text" name="linkedin_url" placeholder="ihr-profil" style="border-radius: 0 4px 4px 0; flex: 1;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Website</label>
                        <div style="display: flex; align-items: center;">
                            <span style="background: #e9ecef; padding: 0.5rem; border: 1px solid #ced4da; border-right: none; border-radius: 4px 0 0 4px; font-size: 0.85rem; white-space: nowrap;">https://</span>
                            <input type="text" name="website" placeholder="www.ihre-website.de" style="border-radius: 0 4px 4px 0; flex: 1;">
                        </div>
                    </div>
                </fieldset>

                <fieldset style="border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                    <legend style="font-weight: 600; padding: 0 0.5rem; color: var(--yb-hellblau);">Meine Trainings die ich zusätzlich anbiete</legend>
                    <p style="font-size: 0.85rem; color: #666; margin-bottom: 1rem;">
                        Sie können, sofern gewünscht, bis zu 10 EIGENE Trainings eintragen, die Yellow-Boat und die Submarken in eigenem Namen anbieten werden. Sie erhalten bevorzugt den Zuschlag bei Anfragen. In Einzelfällen kann, davon abweichend, ein anderer Trainer beauftragt werden, sofern hierfür triftige Gründe vorliegen. Das stellt jedoch eine seltene Ausnahme dar. Der angeforderte Angebotspreis ist rein informativ und kann nicht zugesichert werden. Dies erfolgt in direkter Absprache sobald ein Lead für das entsprechende Training vorliegt.
                    </p>
                    <div id="trainingsContainer">
                        <!-- Training entries will be added here dynamically -->
                    </div>
                    <button type="button" class="btn btn-success" id="addTrainingBtn" onclick="addNewTraining()" style="margin-top: 0.5rem;">
                        + Training hinzufügen
                    </button>
                </fieldset>

                <div style="display: flex; gap: 1rem;">
                    <button type="button" class="btn" style="background: #6c757d; color: white;" onclick="goBackToStep1()">Zurück</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Bewerbung absenden</button>
                </div>
                <div class="error" id="applicationError2"></div>
            </form>
            <div style="margin-top: 1rem; text-align: center;">
                <a href="#" onclick="showLoginForm()" style="color: var(--yb-hellblau); text-decoration: none;">Abbrechen</a>
            </div>
        </div>
    </div>

    <!-- App -->
    <div class="app-container" id="appContainer">
        <header class="header">
            <h1>
                <img src="https://www.yellow-boat.com/wp-content/uploads/2016/10/yellowBoatLogoico.png" alt="Yellow-Boat" class="header-logo">
                Yellow-Boat Academy
            </h1>
            <div class="user-info">
                <button class="btn btn-error-report" onclick="showErrorReportModal()">⚠ Fehler melden</button>
                <div class="notification-bell" onclick="showSection('messages')" title="Nachrichten">
                    🔔
                    <span class="notification-badge" id="unreadBadge" style="display:none;">0</span>
                </div>
                <span id="currentUser"></span>
                <button class="btn btn-logout" onclick="logout()">Abmelden</button>
            </div>
        </header>

        <div class="main-content">
            <nav class="sidebar">
                <a href="#" onclick="showSection('dashboard')" class="active" data-section="dashboard">Dashboard</a>
                <a href="#" onclick="showSection('trainings')" data-section="trainings">Trainings</a>
                <a href="#" onclick="showSection('customers')" data-section="customers">Kunden</a>
                <a href="#" onclick="showSection('trainers')" data-section="trainers">Trainer</a>
                <a href="#" onclick="showSection('brands')" data-section="brands">Marken</a>
                <a href="#" onclick="showSection('locations')" data-section="locations">Locations</a>
                <a href="#" onclick="showSection('messages')" data-section="messages">Nachrichten</a>
                <div id="adminNav" style="display:none; border-top: 1px solid #ddd; margin-top: 1rem; padding-top: 1rem;">
                    <small style="padding: 0 1.5rem; color: #6c757d;">Admin</small>
                    <a href="#" onclick="showSection('users')" data-section="users">Benutzer</a>
                    <a href="#" onclick="showSection('trainer-registrations')" data-section="trainer-registrations">Neue Trainer</a>
                </div>
                <div id="trainerNav" style="display:none; border-top: 1px solid #ddd; margin-top: 1rem; padding-top: 1rem;">
                    <small style="padding: 0 1.5rem; color: #6c757d;">Trainer Portal</small>
                    <a href="#" onclick="showSection('trainer-dashboard')" data-section="trainer-dashboard">Mein Dashboard</a>
                    <a href="#" onclick="showSection('my-profile')" data-section="my-profile">Mein Profil</a>
                    <a href="#" onclick="showSection('open-trainings')" data-section="open-trainings">Offene Trainings</a>
                </div>
            </nav>

            <main class="content">
                <!-- Dashboard -->
                <div id="section-dashboard" class="section">
                    <h2>Dashboard</h2>
                    <div class="stats" id="dashboardStats">
                        <div class="stat-card">
                            <h3 id="statTrainings">-</h3>
                            <p>Trainings</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="statCustomers">-</h3>
                            <p>Kunden</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="statTrainers">-</h3>
                            <p>Trainer</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="statBrands">-</h3>
                            <p>Marken</p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">Letzte Trainings</div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr><th>Titel</th><th>Status</th><th>Datum</th></tr>
                                </thead>
                                <tbody id="recentTrainings"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Trainings -->
                <div id="section-trainings" class="section" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            Trainings
                            <button class="btn btn-sm btn-success" onclick="showCreateModal('training')">+ Neu</button>
                        </div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr><th>Titel</th><th>Status</th><th>Datum</th><th>Aktionen</th></tr>
                                </thead>
                                <tbody id="trainingsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Customers -->
                <div id="section-customers" class="section" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            Kunden
                            <button class="btn btn-sm btn-success" onclick="showCreateModal('customer')">+ Neu</button>
                        </div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr><th>Name</th><th>Email</th><th>Firma</th><th>Aktionen</th></tr>
                                </thead>
                                <tbody id="customersTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Trainers -->
                <div id="section-trainers" class="section" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            Trainer
                            <button class="btn btn-sm btn-success" onclick="showCreateModal('trainer')">+ Neu</button>
                        </div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr><th>Name</th><th>Email</th><th>Spezialisierung</th><th>Aktionen</th></tr>
                                </thead>
                                <tbody id="trainersTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Brands -->
                <div id="section-brands" class="section" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            Marken
                            <button class="btn btn-sm btn-success" onclick="showCreateModal('brand')">+ Neu</button>
                        </div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr><th>Name</th><th>Beschreibung</th><th>Aktionen</th></tr>
                                </thead>
                                <tbody id="brandsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Locations -->
                <div id="section-locations" class="section" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            Locations
                            <button class="btn btn-sm btn-success" onclick="showCreateModal('location')">+ Neu</button>
                        </div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Ort</th>
                                        <th>Max TN</th>
                                        <th>Catering</th>
                                        <th>Aktionen</th>
                                    </tr>
                                </thead>
                                <tbody id="locationsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Users (Admin only) -->
                <div id="section-users" class="section" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            Benutzer verwalten
                            <button class="btn btn-sm btn-success" onclick="showCreateModal('user')">+ Neuer Benutzer</button>
                        </div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr><th>Benutzername</th><th>Email</th><th>Rolle</th><th>Status</th><th>Trainer-Profil</th><th>Aktionen</th></tr>
                                </thead>
                                <tbody id="usersTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Trainer Registrations (Admin only) - New trainers applying to join -->
                <div id="section-trainer-registrations" class="section" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            Neue Trainer-Bewerbungen
                        </div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>E-Mail</th>
                                        <th>Region</th>
                                        <th>Spezialisierungen</th>
                                        <th>Status</th>
                                        <th>Datum</th>
                                        <th>Aktionen</th>
                                    </tr>
                                </thead>
                                <tbody id="trainerRegistrationsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>


                <!-- Trainer Dashboard -->
                <div id="section-trainer-dashboard" class="section" style="display:none;">
                    <h2>Mein Trainer Dashboard</h2>
                    <div class="stats" id="trainerStats">
                        <div class="stat-card">
                            <h3 id="statMyTrainings">-</h3>
                            <p>Meine Trainings</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="statCompleted">-</h3>
                            <p>Abgeschlossen</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="statEarnings">-</h3>
                            <p>Verdienst (€)</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="statPendingApps">-</h3>
                            <p>Offene Bewerbungen</p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">Meine letzten Trainings</div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr><th>Titel / Ort</th><th>Datum</th><th>Status</th><th>Aktionen</th></tr>
                                </thead>
                                <tbody id="myTrainingsTable"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card" style="margin-top: 1rem;">
                        <div class="card-header">Meine Bewerbungen</div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr><th>Training</th><th>Tagessatz</th><th>Nachricht</th><th>Status</th><th>Datum</th><th>Aktionen</th></tr>
                                </thead>
                                <tbody id="myApplicationsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Open Trainings for Application -->
                <div id="section-open-trainings" class="section" style="display:none;">
                    <h2>Offene Trainings</h2>
                    <p style="color: #6c757d; margin-bottom: 1rem;">Hier findest du Trainings, auf die du dich bewerben kannst.</p>
                    <div id="openTrainingsList"></div>
                </div>

                <!-- My Profile (Trainer) -->
                <div id="section-my-profile" class="section" style="display:none;">
                    <h2>Mein Profil</h2>
                    <div class="card">
                        <div class="card-body">
                            <form id="myProfileForm">
                                <div style="display: flex; gap: 2rem; margin-bottom: 1.5rem;">
                                    <div style="flex-shrink: 0;">
                                        <div id="profilePhotoPreview" style="width: 150px; height: 150px; border-radius: 50%; background: #e9ecef; display: flex; align-items: center; justify-content: center; overflow: hidden; margin-bottom: 0.5rem;">
                                            <span style="color: #6c757d;">Kein Foto</span>
                                        </div>
                                        <input type="file" id="profilePhotoInput" accept="image/*" style="display: none;" onchange="previewProfilePhoto(this)">
                                        <button type="button" class="btn btn-sm btn-secondary" onclick="document.getElementById('profilePhotoInput').click()" style="width: 100%;">Foto ändern</button>
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                            <div class="form-group">
                                                <label>Vorname *</label>
                                                <input type="text" name="first_name" id="profile_first_name" required style="width:100%;padding:0.5rem;">
                                            </div>
                                            <div class="form-group">
                                                <label>Nachname *</label>
                                                <input type="text" name="last_name" id="profile_last_name" required style="width:100%;padding:0.5rem;">
                                            </div>
                                        </div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                            <div class="form-group">
                                                <label>Email *</label>
                                                <input type="email" name="email" id="profile_email" required style="width:100%;padding:0.5rem;">
                                            </div>
                                            <div class="form-group">
                                                <label>Telefon</label>
                                                <input type="text" name="phone" id="profile_phone" style="width:100%;padding:0.5rem;">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label>Straße</label>
                                        <input type="text" name="street" id="profile_street" style="width:100%;padding:0.5rem;">
                                    </div>
                                    <div class="form-group">
                                        <label>Hausnr.</label>
                                        <input type="text" name="house_number" id="profile_house_number" style="width:100%;padding:0.5rem;">
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label>PLZ</label>
                                        <input type="text" name="postal_code" id="profile_postal_code" style="width:100%;padding:0.5rem;">
                                    </div>
                                    <div class="form-group">
                                        <label>Ort</label>
                                        <input type="text" name="city" id="profile_city" style="width:100%;padding:0.5rem;">
                                    </div>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label>USt-ID</label>
                                        <input type="text" name="vat_number" id="profile_vat_number" style="width:100%;padding:0.5rem;">
                                    </div>
                                    <div class="form-group">
                                        <label>Kontonummer / IBAN</label>
                                        <input type="text" name="bank_account" id="profile_bank_account" style="width:100%;padding:0.5rem;" placeholder="DE...">
                                    </div>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label>LinkedIn Profil</label>
                                        <div style="display: flex; align-items: center;">
                                            <span style="background: #e9ecef; padding: 0.5rem; border: 1px solid #ced4da; border-right: none; border-radius: 4px 0 0 4px; font-size: 0.85rem; white-space: nowrap;">linkedin.com/in/</span>
                                            <input type="text" name="linkedin_url" id="profile_linkedin_url" placeholder="ihr-profil" style="padding:0.5rem; border-radius: 0 4px 4px 0; flex: 1;">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Website</label>
                                        <div style="display: flex; align-items: center;">
                                            <span style="background: #e9ecef; padding: 0.5rem; border: 1px solid #ced4da; border-right: none; border-radius: 4px 0 0 4px; font-size: 0.85rem; white-space: nowrap;">https://</span>
                                            <input type="text" name="website" id="profile_website" placeholder="www.ihre-website.de" style="padding:0.5rem; border-radius: 0 4px 4px 0; flex: 1;">
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>Region</label>
                                    <input type="text" name="region" id="profile_region" style="width:100%;padding:0.5rem;">
                                </div>

                                <div class="form-group">
                                    <label>Weitere Informationen</label>
                                    <textarea name="additional_info" id="profile_additional_info" style="width:100%;padding:0.5rem;min-height:100px;"></textarea>
                                </div>

                                <fieldset style="border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                                    <legend style="font-weight: 600; padding: 0 0.5rem;">Spezialisierungen</legend>
                                    <div id="profileSpecializations" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem;"></div>
                                    <div style="margin-top: 1rem;">
                                        <label>Weitere Spezialisierungen (kommagetrennt)</label>
                                        <input type="text" id="profile_custom_specs" style="width:100%;padding:0.5rem;" placeholder="z.B. AI, Machine Learning">
                                    </div>
                                </fieldset>

                                <div class="form-group">
                                    <label>Notizen</label>
                                    <textarea name="notes" id="profile_notes" style="width:100%;padding:0.5rem;min-height:80px;"></textarea>
                                </div>

                                <fieldset style="border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                                    <legend style="font-weight: 600; padding: 0 0.5rem;">Meine Trainings die ich zusätzlich anbiete</legend>
                                    <p style="font-size: 0.85rem; color: #666; margin-bottom: 1rem;">
                                        Sie können, sofern gewünscht, bis zu 10 EIGENE Trainings eintragen, die Yellow-Boat und die Submarken in eigenem Namen anbieten werden.
                                    </p>
                                    <div id="profileTrainingsContainer">
                                        <!-- Profile training entries will be added here dynamically -->
                                    </div>
                                    <button type="button" class="btn btn-success" id="addProfileTrainingBtn" onclick="addProfileTrainingEntry()" style="margin-top: 0.5rem;">
                                        + Training hinzufügen
                                    </button>
                                </fieldset>

                                <button type="submit" class="btn btn-primary">Profil speichern</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Messages / Nachrichten -->
                <div id="section-messages" class="section" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            Nachrichten
                            <button class="btn btn-sm btn-success" onclick="showNewMessageModal()">+ Neue Nachricht</button>
                        </div>
                        <div class="card-body">
                            <div id="messagesList">
                                <p style="color: #6c757d;">Laden...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Create Modal -->
    <div class="modal" id="createModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Neu erstellen</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <form id="createForm">
                <div id="modalFields"></div>
                <button type="submit" class="btn btn-primary" style="margin-top: 1rem;">Speichern</button>
            </form>
        </div>
    </div>

    <!-- Error Report Modal -->
    <div class="modal" id="errorReportModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Fehler melden</h3>
                <span class="close" onclick="closeErrorReportModal()">&times;</span>
            </div>
            <form id="errorReportForm">
                <div class="form-group">
                    <label>Betreff</label>
                    <input type="text" name="subject" required style="width:100%;padding:0.5rem;">
                </div>
                <div class="form-group">
                    <label>Beschreibung des Problems</label>
                    <textarea name="content" required style="width:100%;padding:0.5rem;min-height:150px;" placeholder="Beschreiben Sie das Problem so genau wie möglich..."></textarea>
                </div>
                <input type="hidden" name="page_url" id="errorPageUrl">
                <button type="submit" class="btn btn-primary" style="margin-top: 1rem;">Fehler melden</button>
            </form>
        </div>
    </div>

    <!-- Message View Modal -->
    <div class="modal" id="messageViewModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="messageViewTitle">Nachricht</h3>
                <span class="close" onclick="closeMessageViewModal()">&times;</span>
            </div>
            <div id="messageViewContent">
                <div class="message-detail">
                    <p><strong>Von:</strong> <span id="messageFrom"></span></p>
                    <p><strong>An:</strong> <span id="messageTo"></span></p>
                    <p><strong>Datum:</strong> <span id="messageDate"></span></p>
                    <p id="messageStatusRow" style="display:none;"><strong>Status:</strong> <span id="messageStatusDisplay"></span></p>
                </div>
                <hr style="margin: 1rem 0;">
                <div id="messageBody" style="white-space: pre-wrap; margin-bottom: 1rem;"></div>

                <!-- Admin status controls for error reports -->
                <div id="adminStatusControls" style="display:none; margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
                    <label><strong>Status ändern:</strong></label>
                    <select id="messageStatusSelect" style="margin-left: 0.5rem; padding: 0.3rem;">
                        <option value="open">Offen</option>
                        <option value="solved">Gelöst</option>
                        <option value="not_solvable">Nicht lösbar</option>
                    </select>
                    <button class="btn btn-sm btn-primary" onclick="updateMessageStatus()" style="margin-left: 0.5rem;">Speichern</button>
                </div>

                <!-- Trainer application approval controls -->
                <div id="trainerApprovalControls" style="display:none; margin-bottom: 1rem; padding: 1rem; background: #e8f5e9; border-radius: 4px;">
                    <button class="btn btn-success" onclick="approveTrainerApplication()" style="margin-right: 0.5rem;">
                        ✓ Trainer anlegen
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="rejectTrainerApplication()">
                        ✗ Ablehnen
                    </button>
                </div>

                <!-- Reply form -->
                <div id="replySection" style="margin-top: 1rem;">
                    <h4>Antworten</h4>
                    <textarea id="replyContent" style="width:100%;padding:0.5rem;min-height:100px;" placeholder="Ihre Antwort..."></textarea>
                    <button class="btn btn-primary" onclick="sendReply()" style="margin-top: 0.5rem;">Antwort senden</button>
                </div>
            </div>
            <div style="margin-top: 1rem; text-align: right;">
                <button class="btn btn-danger btn-sm" onclick="deleteCurrentMessage()">Löschen</button>
            </div>
        </div>
    </div>

    <!-- New Message Modal -->
    <div class="modal" id="newMessageModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Neue Nachricht</h3>
                <span class="close" onclick="closeNewMessageModal()">&times;</span>
            </div>
            <form id="newMessageForm">
                <div class="form-group">
                    <label>Empfänger</label>
                    <select name="recipient_id" id="messageRecipient" style="width:100%;padding:0.5rem;">
                        <option value="">Laden...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Betreff</label>
                    <input type="text" name="subject" required style="width:100%;padding:0.5rem;">
                </div>
                <div class="form-group">
                    <label>Nachricht</label>
                    <textarea name="content" required style="width:100%;padding:0.5rem;min-height:150px;"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="margin-top: 1rem;">Senden</button>
            </form>
        </div>
    </div>

    <!-- Trainer Profile Modal -->
    <div class="modal trainer-profile-modal" id="trainerProfileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Trainer-Profil</h3>
                <span class="close" onclick="closeTrainerProfileModal()">&times;</span>
            </div>
            <div id="trainerProfileContent">
                <!-- Content will be dynamically inserted -->
            </div>
        </div>
    </div>

    <script>
        const API_URL = '';
        let token = localStorage.getItem('token');
        let currentUser = null;

        // URL formatting helpers
        function formatLinkedInUrl(value) {
            if (!value) return '';
            // Remove any existing prefix
            value = value.replace(/^(https?:\/\/)?(www\.)?linkedin\.com\/in\//i, '');
            return value ? 'https://linkedin.com/in/' + value : '';
        }

        function formatWebsiteUrl(value) {
            if (!value) return '';
            // Remove any existing prefix
            value = value.replace(/^https?:\/\//i, '');
            return value ? 'https://' + value : '';
        }

        function stripLinkedInPrefix(url) {
            if (!url) return '';
            return url.replace(/^(https?:\/\/)?(www\.)?linkedin\.com\/in\//i, '');
        }

        function stripWebsitePrefix(url) {
            if (!url) return '';
            return url.replace(/^https?:\/\//i, '');
        }

        // Check if logged in
        if (token) {
            checkAuth();
        }

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const formData = new URLSearchParams();
                formData.append('username', username);
                formData.append('password', password);

                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });

                const data = await res.json();

                if (res.ok) {
                    token = data.access_token;
                    localStorage.setItem('token', token);
                    checkAuth();
                } else {
                    document.getElementById('loginError').textContent = data.error || 'Login fehlgeschlagen';
                }
            } catch (err) {
                document.getElementById('loginError').textContent = 'Verbindungsfehler';
            }
        });

        // Trainer Application Functions - Two Step Form
        let applicationStep1Data = {};
        let trainingsCount = 0;
        const MAX_TRAININGS = 10;

        function showTrainerApplicationForm() {
            document.getElementById('loginBox').style.display = 'none';
            document.getElementById('applicationStep1').style.display = 'block';
            document.getElementById('applicationStep2').style.display = 'none';
            document.getElementById('applicationError1').textContent = '';
            document.getElementById('applicationError2').textContent = '';
            applicationStep1Data = {};
            trainingsCount = 0;
            initTrainingsContainer();
        }

        function showLoginForm() {
            document.getElementById('applicationStep1').style.display = 'none';
            document.getElementById('applicationStep2').style.display = 'none';
            document.getElementById('loginBox').style.display = 'block';
            document.getElementById('loginError').textContent = '';
        }

        function goBackToStep1() {
            document.getElementById('applicationStep2').style.display = 'none';
            document.getElementById('applicationStep1').style.display = 'block';
            // Restore saved data
            document.getElementById('appEmail').value = applicationStep1Data.email || '';
            document.getElementById('appPassword').value = applicationStep1Data.password || '';
            document.getElementById('appPasswordConfirm').value = applicationStep1Data.password || '';
            document.getElementById('appFirstName').value = applicationStep1Data.first_name || '';
            document.getElementById('appLastName').value = applicationStep1Data.last_name || '';
            document.getElementById('appPhone').value = applicationStep1Data.phone || '';
        }

        function initTrainingsContainer() {
            document.getElementById('trainingsContainer').innerHTML = '';
            trainingsCount = 0;
            addTrainingEntry();
        }

        function addTrainingEntry() {
            if (trainingsCount >= MAX_TRAININGS) {
                alert('Maximal 10 Trainings können eingetragen werden.');
                return;
            }

            const container = document.getElementById('trainingsContainer');
            const index = trainingsCount;
            trainingsCount++;

            const entryHtml = `
                <div class="training-entry" id="training-${index}" style="border: 1px solid #e0e0e0; padding: 1rem; margin-bottom: 1rem; border-radius: 4px; background: #fafafa;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <strong style="color: var(--yb-hellblau);">Training ${index + 1}</strong>
                        <button type="button" onclick="removeTrainingEntry(${index})" style="background: none; border: none; color: #dc3545; cursor: pointer; font-size: 1.2rem;" title="Training löschen">&times;</button>
                    </div>
                    <div class="form-group">
                        <label>Titel</label>
                        <input type="text" name="training_title_${index}">
                    </div>
                    <div class="form-group">
                        <label>Kurzbeschreibung</label>
                        <textarea name="training_description_${index}" style="width:100%; min-height: 60px;"></textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Dauer</label>
                            <input type="number" name="training_duration_${index}" min="1" max="999" style="height: 38px;">
                        </div>
                        <div class="form-group">
                            <label>Einheit</label>
                            <select name="training_duration_unit_${index}" style="height: 38px;">
                                <option value="">Bitte wählen</option>
                                <option value="Stunden">Stunden</option>
                                <option value="Tage">Tage</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" name="training_materials_${index}" style="width: auto;">
                            Trainingsmaterialien vorhanden
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Zielgruppe</label>
                        <input type="text" name="training_target_${index}">
                    </div>
                    <div class="form-group">
                        <label>Mein Angebotspreis netto komplett an Yellow-Boat (EUR)</label>
                        <input type="number" name="training_price_${index}" step="0.01" min="0">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">
                            Hinweis: Für die Abwicklung und Vermarktung kommt seitens Yellow-Boat ein Aufschlag zum Verkaufspreis vor Kunden.
                        </small>
                    </div>
                    <button type="button" class="btn btn-sm btn-primary" onclick="saveTrainingEntry(${index})" style="margin-top: 0.5rem;">
                        Training speichern
                    </button>
                    <span id="training-saved-${index}" style="display: none; color: #28a745; margin-left: 0.5rem;">✓ Gespeichert</span>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', entryHtml);
            updateAddTrainingButton();
        }

        function removeTrainingEntry(index) {
            const entry = document.getElementById(`training-${index}`);
            if (entry) {
                entry.remove();
                updateAddTrainingButton();
            }
        }

        function saveTrainingEntry(index) {
            const form = document.getElementById('applicationFormStep2');
            const title = form.querySelector(`[name="training_title_${index}"]`)?.value;

            if (!title) {
                alert('Bitte geben Sie mindestens einen Titel ein.');
                return;
            }

            // Show saved indicator
            const savedIndicator = document.getElementById(`training-saved-${index}`);
            if (savedIndicator) {
                savedIndicator.style.display = 'inline';
                setTimeout(() => {
                    savedIndicator.style.display = 'none';
                }, 3000);
            }
        }

        function addNewTraining() {
            addTrainingEntry();
        }

        function updateAddTrainingButton() {
            const btn = document.getElementById('addTrainingBtn');
            const currentCount = document.querySelectorAll('.training-entry').length;
            if (btn) {
                if (currentCount >= MAX_TRAININGS) {
                    btn.style.display = 'none';
                } else {
                    btn.style.display = 'inline-block';
                }
            }
        }

        function collectTrainings() {
            const form = document.getElementById('applicationFormStep2');
            const trainings = [];

            for (let i = 0; i < trainingsCount; i++) {
                const title = form.querySelector(`[name="training_title_${i}"]`)?.value;
                if (!title) continue; // Skip empty entries

                trainings.push({
                    title: title,
                    description: form.querySelector(`[name="training_description_${i}"]`)?.value || '',
                    duration: parseInt(form.querySelector(`[name="training_duration_${i}"]`)?.value) || 0,
                    duration_unit: form.querySelector(`[name="training_duration_unit_${i}"]`)?.value || '',
                    materials_available: form.querySelector(`[name="training_materials_${i}"]`)?.checked || false,
                    target_audience: form.querySelector(`[name="training_target_${i}"]`)?.value || '',
                    price: parseFloat(form.querySelector(`[name="training_price_${i}"]`)?.value) || 0
                });
            }

            return trainings;
        }

        // Step 1 form submission
        document.getElementById('applicationFormStep1').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);

            // Validate passwords match
            if (formData.get('password') !== formData.get('password_confirm')) {
                document.getElementById('applicationError1').textContent = 'Passwörter stimmen nicht überein';
                return;
            }

            // Validate password length
            if (formData.get('password').length < 6) {
                document.getElementById('applicationError1').textContent = 'Passwort muss mindestens 6 Zeichen lang sein';
                return;
            }

            // Save step 1 data
            applicationStep1Data = {
                email: formData.get('email'),
                password: formData.get('password'),
                first_name: formData.get('first_name'),
                last_name: formData.get('last_name'),
                phone: formData.get('phone')
            };

            // Go to step 2
            document.getElementById('applicationStep1').style.display = 'none';
            document.getElementById('applicationStep2').style.display = 'block';
            initTrainingsContainer();
        });

        // Step 2 form submission
        document.getElementById('applicationFormStep2').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);

            const data = {
                email: applicationStep1Data.email,
                password: applicationStep1Data.password,
                first_name: applicationStep1Data.first_name,
                last_name: applicationStep1Data.last_name,
                phone: applicationStep1Data.phone,
                street: formData.get('street'),
                house_number: formData.get('house_number'),
                postal_code: formData.get('postal_code'),
                city: formData.get('city'),
                vat_number: formData.get('vat_number'),
                bank_account: formData.get('bank_account'),
                linkedin_url: formatLinkedInUrl(formData.get('linkedin_url')),
                website: formatWebsiteUrl(formData.get('website')),
                region: formData.get('region'),
                additional_info: formData.get('additional_info'),
                specializations: formData.get('specializations'),
                proposed_trainings: collectTrainings()
            };

            try {
                const res = await fetch(`${API_URL}/trainer/apply`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                let result;
                try {
                    result = await res.json();
                } catch (parseError) {
                    console.error('JSON parse error:', parseError);
                    const text = await res.text();
                    console.error('Response text:', text);
                    document.getElementById('applicationError2').textContent = 'Server-Fehler: Ungültige Antwort (Status: ' + res.status + ')';
                    return;
                }

                if (res.ok) {
                    alert('Ihre Bewerbung wurde erfolgreich eingereicht! Sie erhalten eine Benachrichtigung, sobald Ihre Bewerbung geprüft wurde.');
                    document.getElementById('applicationFormStep1').reset();
                    document.getElementById('applicationFormStep2').reset();
                    applicationStep1Data = {};
                    showLoginForm();
                } else {
                    console.error('Application error:', result);
                    document.getElementById('applicationError2').textContent = result.error || 'Fehler beim Einreichen der Bewerbung';
                }
            } catch (err) {
                console.error('Error submitting application:', err);
                document.getElementById('applicationError2').textContent = 'Verbindungsfehler: ' + err.message;
            }
        });

        async function checkAuth() {
            try {
                const res = await fetch(`${API_URL}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    currentUser = await res.json();
                    document.getElementById('currentUser').textContent = currentUser.username;
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('appContainer').style.display = 'block';

                    // Show role-specific navigation
                    if (currentUser.role === 'admin') {
                        document.getElementById('adminNav').style.display = 'block';
                    }
                    if (currentUser.role === 'trainer') {
                        document.getElementById('trainerNav').style.display = 'block';
                        // Hide sections trainers shouldn't see
                        document.querySelector('[data-section="dashboard"]').style.display = 'none';
                        document.querySelector('[data-section="customers"]').style.display = 'none';
                        document.querySelector('[data-section="trainers"]').style.display = 'none';
                        // Trainers can view brands but not create
                        const brandsLink = document.querySelector('[data-section="brands"]');
                        if (brandsLink) brandsLink.textContent = 'Marken (Ansicht)';
                        // Start on trainer dashboard instead
                        showSection('trainer-dashboard');
                        updateUnreadCount();
                        return;
                    }

                    loadDashboard();
                    updateUnreadCount();
                } else {
                    logout();
                }
            } catch (err) {
                logout();
            }
        }

        function logout() {
            token = null;
            currentUser = null;
            localStorage.removeItem('token');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('currentUser').textContent = '';
            document.getElementById('adminNav').style.display = 'none';
            document.getElementById('trainerNav').style.display = 'none';
        }

        function showSection(name) {
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
            document.getElementById(`section-${name}`).style.display = 'block';
            document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
            const navItem = document.querySelector(`[data-section="${name}"]`);
            if (navItem) navItem.classList.add('active');

            if (name === 'dashboard') loadDashboard();
            else if (name === 'trainings') loadTrainings();
            else if (name === 'customers') loadCustomers();
            else if (name === 'trainers') loadTrainers();
            else if (name === 'brands') loadBrands();
            else if (name === 'locations') loadLocations();
            else if (name === 'users') loadUsers();
            else if (name === 'trainer-registrations') loadTrainerRegistrations();
            else if (name === 'trainer-dashboard') loadTrainerDashboard();
            else if (name === 'my-profile') loadMyProfile();
            else if (name === 'open-trainings') loadOpenTrainings();
            else if (name === 'messages') loadMessages();
        }

        async function loadTrainerDashboard() {
            try {
                // Load dashboard stats and detailed trainings
                const [dashboardRes, trainingsRes] = await Promise.all([
                    apiCall('/trainer/dashboard'),
                    apiCall('/trainer/my-trainings')
                ]);

                const data = await dashboardRes.json();
                const detailedTrainings = trainingsRes.ok ? await trainingsRes.json() : [];

                if (data.error) {
                    document.getElementById('trainerStats').innerHTML = `<p style="color: #dc3545;">${data.error}</p>`;
                    return;
                }

                // Update stats
                document.getElementById('statMyTrainings').textContent = data.stats.total_trainings;
                document.getElementById('statCompleted').textContent = data.stats.completed_trainings;
                document.getElementById('statEarnings').textContent = data.stats.total_earnings.toFixed(2);
                document.getElementById('statPendingApps').textContent = data.stats.pending_applications;

                // Update my trainings table with detailed info
                document.getElementById('myTrainingsTable').innerHTML = detailedTrainings.map(t => `
                    <tr>
                        <td>
                            <strong>${t.title || '-'}</strong>
                            ${t.location ? `<br><small style="color:#6c757d;">${t.location}</small>` : ''}
                        </td>
                        <td>
                            ${t.start_date ? new Date(t.start_date).toLocaleDateString('de') : '-'}
                            ${t.duration_days ? `<br><small>(${t.duration_days} Tag/e)</small>` : ''}
                        </td>
                        <td><span class="status-badge" style="padding:0.25rem 0.5rem;border-radius:4px;background:${
                            t.status === 'delivered' ? '#28a745' :
                            t.status === 'invoiced' ? '#17a2b8' :
                            t.status === 'planning' ? '#ffc107' : '#6c757d'
                        };color:white;font-size:0.75rem;">${t.status || '-'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="showTrainingDetails(${t.id})" title="Details anzeigen">Details</button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="4">Keine Trainings</td></tr>';

                // Store detailed trainings for modal
                window.trainerDetailedTrainings = detailedTrainings;

                // Update applications table
                document.getElementById('myApplicationsTable').innerHTML = data.applications.map(a => `
                    <tr>
                        <td>Training #${a.training_id}</td>
                        <td>${a.proposed_rate ? a.proposed_rate.toFixed(2) + ' €' : '-'}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${a.message || ''}">${a.message || '-'}</td>
                        <td><span style="color: ${a.status === 'accepted' ? '#28a745' : a.status === 'rejected' ? '#dc3545' : '#ffc107'};">${a.status}</span></td>
                        <td>${a.created_at ? new Date(a.created_at).toLocaleDateString('de') : '-'}</td>
                        <td>
                            ${a.status === 'pending' ? `<button class="btn btn-sm btn-danger" onclick="withdrawApplication(${a.id})">Zurückziehen</button>` : ''}
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="6">Keine Bewerbungen</td></tr>';
            } catch (err) {
                console.error('Error loading trainer dashboard:', err);
            }
        }

        function showTrainingDetails(trainingId) {
            const training = window.trainerDetailedTrainings?.find(t => t.id === trainingId);
            if (!training) {
                alert('Training nicht gefunden');
                return;
            }

            let detailsHtml = `
                <h3 style="margin-bottom: 1rem;">${training.title}</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <p><strong>Status:</strong> ${training.status || '-'}</p>
                        <p><strong>Datum:</strong> ${training.start_date ? new Date(training.start_date).toLocaleDateString('de') : '-'} ${training.end_date ? '- ' + new Date(training.end_date).toLocaleDateString('de') : ''}</p>
                        <p><strong>Dauer:</strong> ${training.duration_days || '-'} Tag(e)</p>
                        <p><strong>Format:</strong> ${training.training_format || '-'} / ${training.training_type || '-'}</p>
                        <p><strong>Max TN:</strong> ${training.max_participants || '-'}</p>
                        <p><strong>Sprache:</strong> ${training.language || '-'}</p>
                    </div>
                    <div>
                        <p><strong>Ort:</strong> ${training.location || '-'}</p>
                        ${training.location_booking ? `<p><strong>Location Buchung:</strong> ${training.location_booking}</p>` : ''}
                        ${training.catering_booking ? `<p><strong>Catering:</strong> ${training.catering_booking}</p>` : ''}
                        ${training.online_link ? `<p><strong>Online-Link:</strong> <a href="${training.online_link}" target="_blank">${training.online_link}</a></p>` : ''}
                    </div>
                </div>
            `;

            if (training.location_details) {
                detailsHtml += `<p style="margin-top:1rem;"><strong>Location Details:</strong><br>${training.location_details}</p>`;
            }

            if (training.logistics_notes) {
                detailsHtml += `<p style="margin-top:1rem;"><strong>Logistik:</strong><br>${training.logistics_notes}</p>`;
            }

            if (training.communication_notes) {
                detailsHtml += `<p style="margin-top:1rem;"><strong>Kommunikation:</strong><br>${training.communication_notes}</p>`;
            }

            if (training.internal_notes) {
                detailsHtml += `<p style="margin-top:1rem;"><strong>Notizen:</strong><br>${training.internal_notes}</p>`;
            }

            // Show in modal
            document.getElementById('modalTitle').textContent = 'Training Details';
            document.getElementById('modalFields').innerHTML = detailsHtml;
            document.querySelector('#createForm button[type="submit"]').style.display = 'none';
            document.getElementById('createModal').style.display = 'flex';
        }

        async function loadOpenTrainings() {
            try {
                const trainings = await apiCall('/trainer/open-trainings').then(r => r.json());

                if (trainings.error) {
                    document.getElementById('openTrainingsList').innerHTML = `<p style="color: #dc3545;">${trainings.error}</p>`;
                    return;
                }

                document.getElementById('openTrainingsList').innerHTML = trainings.map(t => `
                    <div class="card" style="margin-bottom: 1rem;">
                        <div class="card-header">
                            ${t.title}
                            ${t.already_applied
                                ? '<span style="color: #28a745; float: right;">✓ Beworben</span>'
                                : `<button class="btn btn-sm btn-success" style="float: right;" onclick="applyForTraining(${t.id})">Bewerben</button>`
                            }
                        </div>
                        <div class="card-body">
                            <p><strong>Datum:</strong> ${t.start_date ? new Date(t.start_date).toLocaleDateString('de') : 'TBD'} ${t.end_date ? '- ' + new Date(t.end_date).toLocaleDateString('de') : ''}</p>
                            <p><strong>Dauer:</strong> ${t.duration_days || '?'} Tag(e)</p>
                            <p><strong>Ort:</strong> ${t.location || 'TBD'}</p>
                            ${t.description ? `<p><strong>Details:</strong> ${t.description}</p>` : ''}
                        </div>
                    </div>
                `).join('') || '<p>Keine offenen Trainings verfügbar.</p>';
            } catch (err) {
                console.error('Error loading open trainings:', err);
            }
        }

        async function applyForTraining(trainingId) {
            const rate = prompt('Dein Tagessatz (€):', '');
            if (rate === null) return;

            const message = prompt('Nachricht (optional):', '');

            try {
                const res = await apiCall(`/trainer/apply/${trainingId}`, {
                    method: 'POST',
                    body: JSON.stringify({
                        proposed_rate: rate ? parseFloat(rate) : null,
                        message: message || null
                    })
                });

                const data = await res.json();
                if (res.ok) {
                    alert('Bewerbung erfolgreich eingereicht!');
                    loadOpenTrainings();
                } else {
                    alert(data.error || 'Fehler bei der Bewerbung');
                }
            } catch (err) {
                alert('Fehler bei der Bewerbung');
            }
        }

        async function withdrawApplication(applicationId) {
            if (!confirm('Bewerbung wirklich zurückziehen?')) return;

            try {
                await apiCall(`/trainer/applications/${applicationId}`, { method: 'DELETE' });
                loadTrainerDashboard();
            } catch (err) {
                alert('Fehler beim Zurückziehen');
            }
        }

        // My Profile functions
        let myTrainerId = null;

        async function loadMyProfile() {
            try {
                const data = await apiCall('/trainer/dashboard').then(r => r.json());
                if (data.error) {
                    alert(data.error);
                    return;
                }

                const trainer = data.trainer;
                myTrainerId = trainer.id;

                // Fill form fields
                document.getElementById('profile_first_name').value = trainer.first_name || '';
                document.getElementById('profile_last_name').value = trainer.last_name || '';
                document.getElementById('profile_email').value = trainer.email || '';
                document.getElementById('profile_phone').value = trainer.phone || '';
                document.getElementById('profile_street').value = trainer.street || '';
                document.getElementById('profile_house_number').value = trainer.house_number || '';
                document.getElementById('profile_postal_code').value = trainer.postal_code || '';
                document.getElementById('profile_city').value = trainer.city || '';
                document.getElementById('profile_vat_number').value = trainer.vat_number || '';
                document.getElementById('profile_bank_account').value = trainer.bank_account || '';
                document.getElementById('profile_linkedin_url').value = stripLinkedInPrefix(trainer.linkedin_url || '');
                document.getElementById('profile_website').value = stripWebsitePrefix(trainer.website || '');
                document.getElementById('profile_region').value = trainer.region || '';
                document.getElementById('profile_additional_info').value = trainer.additional_info || '';
                document.getElementById('profile_notes').value = trainer.notes || '';

                // Photo
                const photoPreview = document.getElementById('profilePhotoPreview');
                if (trainer.photo_path) {
                    photoPreview.innerHTML = `<img src="${trainer.photo_path}" style="width: 100%; height: 100%; object-fit: cover;">`;
                } else {
                    photoPreview.innerHTML = '<span style="color: #6c757d;">Kein Foto</span>';
                }

                // Specializations
                const specs = trainer.specializations || { selected: [], custom: [] };
                const specsContainer = document.getElementById('profileSpecializations');
                specsContainer.innerHTML = TRAINER_SPECIALIZATIONS.map(spec => `
                    <label style="display: flex; align-items: center; gap: 0.25rem;">
                        <input type="checkbox" name="profile_spec" value="${spec}" ${specs.selected && specs.selected.includes(spec) ? 'checked' : ''}>
                        ${spec}
                    </label>
                `).join('');
                document.getElementById('profile_custom_specs').value = specs.custom ? specs.custom.join(', ') : '';

                // Load trainings
                loadProfileTrainings(trainer.proposed_trainings || []);

            } catch (err) {
                console.error('Error loading profile:', err);
                alert('Fehler beim Laden des Profils');
            }
        }

        // Profile Trainings Functions
        let profileTrainingsCount = 0;
        const MAX_PROFILE_TRAININGS = 10;

        function loadProfileTrainings(trainings) {
            const container = document.getElementById('profileTrainingsContainer');
            container.innerHTML = '';
            profileTrainingsCount = 0;

            if (trainings && trainings.length > 0) {
                trainings.forEach((training, index) => {
                    addProfileTrainingEntry(training);
                });
            }
            updateAddProfileTrainingButton();
        }

        function addProfileTrainingEntry(existingData = null) {
            if (profileTrainingsCount >= MAX_PROFILE_TRAININGS) {
                alert('Maximal 10 Trainings können eingetragen werden.');
                return;
            }

            const container = document.getElementById('profileTrainingsContainer');
            const index = profileTrainingsCount;
            profileTrainingsCount++;

            const entryHtml = `
                <div class="profile-training-entry" id="profile-training-${index}" style="border: 1px solid #e0e0e0; padding: 1rem; margin-bottom: 1rem; border-radius: 4px; background: #fafafa;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <strong style="color: var(--yb-hellblau);">Training ${index + 1}</strong>
                        <button type="button" onclick="removeProfileTrainingEntry(${index})" style="background: none; border: none; color: #dc3545; cursor: pointer; font-size: 1.2rem;" title="Training löschen">&times;</button>
                    </div>
                    <div class="form-group">
                        <label>Titel</label>
                        <input type="text" id="profile_training_title_${index}" value="${existingData?.title || ''}" style="width:100%;padding:0.5rem;">
                    </div>
                    <div class="form-group">
                        <label>Kurzbeschreibung</label>
                        <textarea id="profile_training_description_${index}" style="width:100%;padding:0.5rem;min-height:60px;">${existingData?.description || ''}</textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Dauer</label>
                            <input type="number" id="profile_training_duration_${index}" min="1" max="999" value="${existingData?.duration || ''}" style="width:100%;padding:0.5rem;height:38px;">
                        </div>
                        <div class="form-group">
                            <label>Einheit</label>
                            <select id="profile_training_duration_unit_${index}" style="width:100%;padding:0.5rem;height:38px;">
                                <option value="">Bitte wählen</option>
                                <option value="Stunden" ${existingData?.duration_unit === 'Stunden' ? 'selected' : ''}>Stunden</option>
                                <option value="Tage" ${existingData?.duration_unit === 'Tage' ? 'selected' : ''}>Tage</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="profile_training_materials_${index}" ${existingData?.materials_available ? 'checked' : ''} style="width: auto;">
                            Trainingsmaterialien vorhanden
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Zielgruppe</label>
                        <input type="text" id="profile_training_target_${index}" value="${existingData?.target_audience || ''}" style="width:100%;padding:0.5rem;">
                    </div>
                    <div class="form-group">
                        <label>Mein Angebotspreis netto komplett an Yellow-Boat (EUR)</label>
                        <input type="number" id="profile_training_price_${index}" step="0.01" min="0" value="${existingData?.price || ''}" style="width:100%;padding:0.5rem;">
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', entryHtml);
            updateAddProfileTrainingButton();
        }

        function removeProfileTrainingEntry(index) {
            const entry = document.getElementById(`profile-training-${index}`);
            if (entry) {
                entry.remove();
                updateAddProfileTrainingButton();
            }
        }

        function updateAddProfileTrainingButton() {
            const btn = document.getElementById('addProfileTrainingBtn');
            const currentCount = document.querySelectorAll('.profile-training-entry').length;
            if (btn) {
                if (currentCount >= MAX_PROFILE_TRAININGS) {
                    btn.style.display = 'none';
                } else {
                    btn.style.display = 'inline-block';
                }
            }
        }

        function collectProfileTrainings() {
            const trainings = [];
            const entries = document.querySelectorAll('.profile-training-entry');

            entries.forEach(entry => {
                const index = entry.id.replace('profile-training-', '');
                const title = document.getElementById(`profile_training_title_${index}`)?.value;
                if (!title) return; // Skip empty entries

                trainings.push({
                    title: title,
                    description: document.getElementById(`profile_training_description_${index}`)?.value || '',
                    duration: parseInt(document.getElementById(`profile_training_duration_${index}`)?.value) || 0,
                    duration_unit: document.getElementById(`profile_training_duration_unit_${index}`)?.value || '',
                    materials_available: document.getElementById(`profile_training_materials_${index}`)?.checked || false,
                    target_audience: document.getElementById(`profile_training_target_${index}`)?.value || '',
                    price: parseFloat(document.getElementById(`profile_training_price_${index}`)?.value) || 0
                });
            });

            return trainings;
        }

        function previewProfilePhoto(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('profilePhotoPreview').innerHTML =
                        `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;">`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Profile form submit
        document.addEventListener('DOMContentLoaded', function() {
            const profileForm = document.getElementById('myProfileForm');
            if (profileForm) {
                profileForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    if (!myTrainerId) {
                        alert('Trainer-Profil nicht geladen');
                        return;
                    }

                    // Collect specializations
                    const selectedSpecs = Array.from(document.querySelectorAll('input[name="profile_spec"]:checked')).map(cb => cb.value);
                    const customSpecs = document.getElementById('profile_custom_specs').value
                        .split(',')
                        .map(s => s.trim())
                        .filter(s => s);

                    const profileData = {
                        first_name: document.getElementById('profile_first_name').value,
                        last_name: document.getElementById('profile_last_name').value,
                        email: document.getElementById('profile_email').value,
                        phone: document.getElementById('profile_phone').value,
                        street: document.getElementById('profile_street').value,
                        house_number: document.getElementById('profile_house_number').value,
                        postal_code: document.getElementById('profile_postal_code').value,
                        city: document.getElementById('profile_city').value,
                        vat_number: document.getElementById('profile_vat_number').value,
                        bank_account: document.getElementById('profile_bank_account').value,
                        linkedin_url: formatLinkedInUrl(document.getElementById('profile_linkedin_url').value),
                        website: formatWebsiteUrl(document.getElementById('profile_website').value),
                        region: document.getElementById('profile_region').value,
                        additional_info: document.getElementById('profile_additional_info').value,
                        notes: document.getElementById('profile_notes').value,
                        specializations: {
                            selected: selectedSpecs,
                            custom: customSpecs
                        },
                        proposed_trainings: collectProfileTrainings()
                    };

                    try {
                        const res = await apiCall(`/trainer/profile`, {
                            method: 'PUT',
                            body: JSON.stringify(profileData)
                        });

                        if (!res.ok) {
                            const error = await res.json();
                            alert(error.error || 'Fehler beim Speichern');
                            return;
                        }

                        // Upload photo if selected
                        const photoInput = document.getElementById('profilePhotoInput');
                        if (photoInput.files && photoInput.files[0]) {
                            const formData = new FormData();
                            formData.append('photo', photoInput.files[0]);

                            const photoRes = await fetch(`/trainers/${myTrainerId}/photo`, {
                                method: 'POST',
                                headers: { 'Authorization': `Bearer ${token}` },
                                body: formData
                            });

                            if (!photoRes.ok) {
                                alert('Profil gespeichert, aber Foto-Upload fehlgeschlagen');
                                return;
                            }
                        }

                        alert('Profil erfolgreich gespeichert!');
                        loadMyProfile();
                    } catch (err) {
                        console.error('Error saving profile:', err);
                        alert('Fehler beim Speichern des Profils');
                    }
                });
            }
        });

        async function loadUsers() {
            if (currentUser.role !== 'admin') {
                document.getElementById('usersTable').innerHTML = '<tr><td colspan="6">Keine Berechtigung</td></tr>';
                return;
            }

            const users = await apiCall('/auth/users').then(r => r.json());
            document.getElementById('usersTable').innerHTML = users.map(u => `
                <tr>
                    <td>${u.username}</td>
                    <td>${u.email}</td>
                    <td><span class="badge" style="background: ${u.role === 'admin' ? '#dc3545' : u.role === 'trainer' ? '#28a745' : '#007bff'}; color: white; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.75rem;">${u.role}</span></td>
                    <td>${u.is_active ? '<span style="color: #28a745;">Aktiv</span>' : '<span style="color: #dc3545;">Inaktiv</span>'}</td>
                    <td>
                        ${u.role === 'trainer' ? `
                            ${u.trainer_id
                                ? `<span style="color: #28a745;">${u.trainer_name}</span>`
                                : `<span style="color: #6c757d;" title="Wird automatisch per E-Mail verknüpft">Keine Verknüpfung</span>`
                            }
                        ` : '-'}
                    </td>
                    <td>
                        ${u.id !== currentUser.id ? `<button class="btn btn-sm btn-danger" onclick="deleteUser(${u.id})">Löschen</button>` : '<em>Aktueller User</em>'}
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="6">Keine Benutzer</td></tr>';
        }

        async function deleteUser(id) {
            if (!confirm('Benutzer wirklich löschen?')) return;
            const res = await apiCall(`/auth/users/${id}`, { method: 'DELETE' });
            if (!res.ok) {
                const error = await res.json().catch(() => ({}));
                alert(error.error || 'Fehler beim Löschen');
                return;
            }
            loadUsers();
        }

        async function loadTrainingApplications() {
            if (currentUser.role !== 'admin' && currentUser.role !== 'backoffice_user') {
                document.getElementById('trainingApplicationsTable').innerHTML = '<tr><td colspan="7">Keine Berechtigung</td></tr>';
                return;
            }

            try {
                const res = await apiCall('/admin/training-applications');
                if (!res.ok) {
                    document.getElementById('trainingApplicationsTable').innerHTML = '<tr><td colspan="7">Fehler beim Laden</td></tr>';
                    return;
                }
                const applications = await res.json();

                if (applications.length === 0) {
                    document.getElementById('trainingApplicationsTable').innerHTML = '<tr><td colspan="7">Keine Bewerbungen vorhanden</td></tr>';
                    return;
                }

                document.getElementById('trainingApplicationsTable').innerHTML = applications.map(app => `
                    <tr>
                        <td>
                            <strong>${app.trainer_name}</strong><br>
                            <small style="color: #6c757d;">${app.trainer_email || ''}</small>
                        </td>
                        <td>${app.training_title}</td>
                        <td>${app.proposed_rate ? app.proposed_rate + ' €' : '-'}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${app.message || '-'}</td>
                        <td>
                            <span class="badge" style="background: ${app.status === 'pending' ? '#ffc107' : app.status === 'accepted' ? '#28a745' : '#dc3545'}; color: ${app.status === 'pending' ? '#000' : '#fff'}; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.75rem;">
                                ${app.status === 'pending' ? 'Offen' : app.status === 'accepted' ? 'Akzeptiert' : 'Abgelehnt'}
                            </span>
                        </td>
                        <td>${app.created_at ? new Date(app.created_at).toLocaleDateString('de') : '-'}</td>
                        <td>
                            ${app.status === 'pending' ? `
                                <button class="btn btn-sm btn-success" onclick="acceptTrainingApplication(${app.id})" style="margin-right: 0.25rem;">Akzeptieren</button>
                                <button class="btn btn-sm btn-danger" onclick="rejectTrainingApplication(${app.id})">Ablehnen</button>
                            ` : '-'}
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading training applications:', error);
                document.getElementById('trainingApplicationsTable').innerHTML = '<tr><td colspan="7">Fehler beim Laden</td></tr>';
            }
        }

        async function acceptTrainingApplication(appId) {
            if (!confirm('Bewerbung akzeptieren und Trainer dem Training zuweisen?')) return;

            const res = await apiCall(`/admin/training-applications/${appId}/accept`, {
                method: 'POST'
            });

            if (!res.ok) {
                const error = await res.json().catch(() => ({}));
                alert(error.error || 'Fehler beim Akzeptieren');
                return;
            }

            const result = await res.json();
            alert(result.message || 'Bewerbung akzeptiert');
            loadTrainingApplications();
        }

        async function rejectTrainingApplication(appId) {
            if (!confirm('Bewerbung wirklich ablehnen?')) return;

            const res = await apiCall(`/admin/training-applications/${appId}/reject`, {
                method: 'POST'
            });

            if (!res.ok) {
                const error = await res.json().catch(() => ({}));
                alert(error.error || 'Fehler beim Ablehnen');
                return;
            }

            loadTrainingApplications();
        }

        // ============== Trainer Registrations (New trainers applying to join) ==============
        async function loadTrainerRegistrations() {
            if (currentUser.role !== 'admin' && currentUser.role !== 'backoffice_user') {
                document.getElementById('trainerRegistrationsTable').innerHTML = '<tr><td colspan="7">Keine Berechtigung</td></tr>';
                return;
            }

            try {
                const res = await apiCall('/trainer/applications');
                if (!res.ok) {
                    document.getElementById('trainerRegistrationsTable').innerHTML = '<tr><td colspan="7">Fehler beim Laden</td></tr>';
                    return;
                }
                const registrations = await res.json();

                if (registrations.length === 0) {
                    document.getElementById('trainerRegistrationsTable').innerHTML = '<tr><td colspan="7">Keine neuen Bewerbungen</td></tr>';
                    return;
                }

                document.getElementById('trainerRegistrationsTable').innerHTML = registrations.map(reg => `
                    <tr>
                        <td>
                            <strong>${reg.first_name} ${reg.last_name}</strong>
                            ${reg.photo_url ? `<br><img src="${reg.photo_url}" style="width: 40px; height: 40px; border-radius: 50%; margin-top: 0.25rem;">` : ''}
                        </td>
                        <td>
                            ${reg.email}<br>
                            <small style="color: #6c757d;">${reg.phone || ''}</small>
                        </td>
                        <td>${reg.region || '-'}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${reg.specializations || '-'}</td>
                        <td>
                            <span class="badge" style="background: ${reg.status === 'pending' ? '#ffc107' : reg.status === 'approved' ? '#28a745' : '#dc3545'}; color: ${reg.status === 'pending' ? '#000' : '#fff'}; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.75rem;">
                                ${reg.status === 'pending' ? 'Offen' : reg.status === 'approved' ? 'Genehmigt' : 'Abgelehnt'}
                            </span>
                        </td>
                        <td>${reg.created_at ? new Date(reg.created_at).toLocaleDateString('de') : '-'}</td>
                        <td>
                            <button class="btn btn-sm" onclick="viewTrainerRegistration(${reg.id})" style="margin-right: 0.25rem;">Details</button>
                            ${reg.status === 'pending' ? `
                                <button class="btn btn-sm btn-success" onclick="approveTrainerRegistration(${reg.id})" style="margin-right: 0.25rem;">Genehmigen</button>
                                <button class="btn btn-sm btn-danger" onclick="rejectTrainerRegistration(${reg.id})">Ablehnen</button>
                            ` : ''}
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading trainer registrations:', error);
                document.getElementById('trainerRegistrationsTable').innerHTML = '<tr><td colspan="7">Fehler beim Laden</td></tr>';
            }
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function closeTrainerProfileModal() {
            document.getElementById('trainerProfileModal').style.display = 'none';
        }

        async function viewTrainerRegistration(regId) {
            try {
                const res = await apiCall(`/trainer/applications/${regId}`);
                if (!res.ok) {
                    alert('Fehler beim Laden der Bewerbung');
                    return;
                }
                const reg = await res.json();

                // Parse specializations
                const specs = reg.specializations ? reg.specializations.split(',').map(s => s.trim()).filter(s => s) : [];

                // Parse proposed trainings
                let proposedTrainingsHtml = '<p style="color: #6c757d;">Keine Trainings angegeben</p>';
                if (reg.proposed_trainings) {
                    try {
                        const trainings = JSON.parse(reg.proposed_trainings);
                        if (trainings.length > 0) {
                            proposedTrainingsHtml = trainings.map(t => `
                                <div class="trainer-profile-training-card">
                                    <div class="trainer-profile-training-title">${escapeHtml(t.title) || 'Ohne Titel'}</div>
                                    <p style="margin-bottom: 0.5rem;">${escapeHtml(t.description) || ''}</p>
                                    <div class="trainer-profile-training-meta">
                                        <span>Dauer: ${escapeHtml(t.duration) || '-'} ${escapeHtml(t.duration_unit) || ''}</span>
                                        <span style="margin-left: 1rem;">Preis: ${t.price ? t.price + ' €' : '-'}</span>
                                    </div>
                                </div>
                            `).join('');
                        }
                    } catch (e) {
                        proposedTrainingsHtml = `<p>${escapeHtml(reg.proposed_trainings)}</p>`;
                    }
                }

                const statusLabel = reg.status === 'pending' ? 'Offen' : reg.status === 'approved' ? 'Genehmigt' : 'Abgelehnt';
                const statusClass = reg.status === 'pending' ? 'status-pending' : reg.status === 'approved' ? 'status-accepted' : 'status-rejected';

                const profileHtml = `
                    <div class="trainer-profile-header">
                        ${reg.photo_url
                            ? `<img src="${escapeHtml(reg.photo_url)}" class="trainer-profile-photo" alt="Foto">`
                            : `<div class="trainer-profile-photo-placeholder">${escapeHtml((reg.first_name || '?')[0])}${escapeHtml((reg.last_name || '?')[0])}</div>`
                        }
                        <div class="trainer-profile-main">
                            <h2 class="trainer-profile-name">${escapeHtml(reg.first_name)} ${escapeHtml(reg.last_name)}</h2>
                            <div class="trainer-profile-contact">
                                <div class="trainer-profile-contact-item">
                                    <span>📧</span> ${escapeHtml(reg.email) || '-'}
                                </div>
                                <div class="trainer-profile-contact-item">
                                    <span>📱</span> ${escapeHtml(reg.phone) || '-'}
                                </div>
                                <div class="trainer-profile-contact-item">
                                    <span>📍</span> ${escapeHtml(reg.region) || '-'}
                                </div>
                            </div>
                            <div class="trainer-profile-badges">
                                <span class="${statusClass}">${statusLabel}</span>
                                ${specs.map(s => `<span class="trainer-profile-badge">${escapeHtml(s)}</span>`).join('')}
                            </div>
                        </div>
                    </div>

                    <div class="trainer-profile-section">
                        <h4 class="trainer-profile-section-title">Kontaktdaten & Adresse</h4>
                        <div class="trainer-profile-grid">
                            <div class="trainer-profile-field">
                                <div class="trainer-profile-field-label">Straße</div>
                                <div class="trainer-profile-field-value">${escapeHtml(reg.street) || '-'} ${escapeHtml(reg.house_number) || ''}</div>
                            </div>
                            <div class="trainer-profile-field">
                                <div class="trainer-profile-field-label">PLZ / Ort</div>
                                <div class="trainer-profile-field-value">${escapeHtml(reg.postal_code) || ''} ${escapeHtml(reg.city) || '-'}</div>
                            </div>
                            <div class="trainer-profile-field">
                                <div class="trainer-profile-field-label">USt-ID</div>
                                <div class="trainer-profile-field-value">${escapeHtml(reg.vat_number) || '-'}</div>
                            </div>
                            <div class="trainer-profile-field">
                                <div class="trainer-profile-field-label">Bankverbindung</div>
                                <div class="trainer-profile-field-value">${escapeHtml(reg.bank_account) || '-'}</div>
                            </div>
                            <div class="trainer-profile-field">
                                <div class="trainer-profile-field-label">LinkedIn</div>
                                <div class="trainer-profile-field-value">
                                    ${reg.linkedin_url ? `<a href="${escapeHtml(reg.linkedin_url)}" target="_blank">${escapeHtml(reg.linkedin_url)}</a>` : '-'}
                                </div>
                            </div>
                            <div class="trainer-profile-field">
                                <div class="trainer-profile-field-label">Website</div>
                                <div class="trainer-profile-field-value">
                                    ${reg.website ? `<a href="${escapeHtml(reg.website)}" target="_blank">${escapeHtml(reg.website)}</a>` : '-'}
                                </div>
                            </div>
                        </div>
                    </div>

                    ${reg.additional_info ? `
                    <div class="trainer-profile-section">
                        <h4 class="trainer-profile-section-title">Weitere Informationen</h4>
                        <p style="white-space: pre-wrap;">${escapeHtml(reg.additional_info)}</p>
                    </div>
                    ` : ''}

                    <div class="trainer-profile-section">
                        <h4 class="trainer-profile-section-title">Angebotene Trainings</h4>
                        <div class="trainer-profile-trainings">
                            ${proposedTrainingsHtml}
                        </div>
                    </div>

                    <div class="trainer-profile-section">
                        <div class="trainer-profile-field">
                            <div class="trainer-profile-field-label">Bewerbung eingegangen</div>
                            <div class="trainer-profile-field-value">${reg.created_at ? new Date(reg.created_at).toLocaleString('de') : '-'}</div>
                        </div>
                    </div>

                    ${reg.status === 'pending' ? `
                    <div class="trainer-profile-actions">
                        <button class="btn btn-success" onclick="approveTrainerRegistration(${reg.id}); closeTrainerProfileModal();">
                            Genehmigen
                        </button>
                        <button class="btn btn-danger" onclick="rejectTrainerRegistration(${reg.id}); closeTrainerProfileModal();">
                            Ablehnen
                        </button>
                    </div>
                    ` : ''}
                `;

                document.getElementById('trainerProfileContent').innerHTML = profileHtml;
                document.getElementById('trainerProfileModal').style.display = 'flex';
            } catch (error) {
                console.error('Error:', error);
                alert('Fehler beim Laden');
            }
        }

        async function approveTrainerRegistration(regId) {
            if (!confirm('Bewerbung genehmigen und Trainer-Account erstellen?')) return;

            try {
                const res = await apiCall(`/trainer/applications/${regId}/approve`, {
                    method: 'POST'
                });

                if (!res.ok) {
                    const error = await res.json().catch(() => ({}));
                    alert(error.error || 'Fehler beim Genehmigen');
                    return;
                }

                const result = await res.json();
                alert(result.message || 'Trainer erfolgreich angelegt!');
                loadTrainerRegistrations();
            } catch (error) {
                console.error('Error approving registration:', error);
                alert('Fehler beim Genehmigen der Bewerbung');
            }
        }

        async function rejectTrainerRegistration(regId) {
            const reason = prompt('Grund für Ablehnung (optional):');
            if (reason === null) return; // User cancelled

            try {
                const res = await apiCall(`/trainer/applications/${regId}/reject`, {
                    method: 'POST',
                    body: JSON.stringify({ reason: reason || null })
                });

                if (!res.ok) {
                    const error = await res.json().catch(() => ({}));
                    alert(error.error || 'Fehler beim Ablehnen');
                    return;
                }

                alert('Bewerbung abgelehnt');
                loadTrainerRegistrations();
            } catch (error) {
                console.error('Error rejecting registration:', error);
                alert('Fehler beim Ablehnen der Bewerbung');
            }
        }

        async function apiCall(endpoint, options = {}) {
            const res = await fetch(`${API_URL}${endpoint}`, {
                ...options,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });
            if (res.status === 401) logout();
            return res;
        }

        async function loadDashboard() {
            const [trainingsData, customersData, trainersData, brandsData] = await Promise.all([
                apiCall('/trainings').then(r => r.json()),
                apiCall('/customers').then(r => r.json()),
                apiCall('/trainers').then(r => r.json()),
                apiCall('/brands').then(r => r.json())
            ]);

            // Handle both paginated and non-paginated responses
            const trainings = trainingsData.items || trainingsData;
            const customers = customersData.items || customersData;
            const trainers = trainersData.items || trainersData;
            const brands = brandsData.items || brandsData;

            document.getElementById('statTrainings').textContent = trainingsData.total || trainings.length;
            document.getElementById('statCustomers').textContent = customersData.total || customers.length;
            document.getElementById('statTrainers').textContent = trainersData.total || trainers.length;
            document.getElementById('statBrands').textContent = brandsData.total || brands.length;

            const recent = trainings.slice(0, 5);
            document.getElementById('recentTrainings').innerHTML = recent.map(t => `
                <tr>
                    <td>${t.title || '-'}</td>
                    <td>${t.status || '-'}</td>
                    <td>${t.date ? new Date(t.date).toLocaleDateString('de') : '-'}</td>
                </tr>
            `).join('') || '<tr><td colspan="3">Keine Trainings</td></tr>';
        }

        async function loadTrainings() {
            try {
                const res = await apiCall('/trainings');
                if (!res.ok) {
                    console.error('Failed to load trainings:', res.status);
                    document.getElementById('trainingsTable').innerHTML = '<tr><td colspan="4">Fehler beim Laden</td></tr>';
                    return;
                }
                const data = await res.json();
                const trainings = data.items || data;
                document.getElementById('trainingsTable').innerHTML = trainings.map(t => `
                    <tr>
                        <td>${t.title || '-'}</td>
                        <td>${t.status || '-'}</td>
                        <td>${t.date ? new Date(t.date).toLocaleDateString('de') : '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="showEditModal('training', ${t.id})" style="margin-right:0.25rem;">Bearbeiten</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteItem('trainings', ${t.id})">Löschen</button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="4">Keine Trainings</td></tr>';
            } catch (err) {
                console.error('Error loading trainings:', err);
                document.getElementById('trainingsTable').innerHTML = '<tr><td colspan="4">Fehler beim Laden</td></tr>';
            }
        }

        async function loadCustomers() {
            try {
                const res = await apiCall('/customers');
                if (!res.ok) {
                    console.error('Failed to load customers:', res.status);
                    document.getElementById('customersTable').innerHTML = '<tr><td colspan="4">Fehler beim Laden</td></tr>';
                    return;
                }
                const data = await res.json();
                const customers = data.items || data;
                document.getElementById('customersTable').innerHTML = customers.map(c => `
                    <tr>
                        <td title="Tel: ${c.phone || '-'}\nAdresse: ${c.street || ''} ${c.street_number || ''}, ${c.postal_code || ''} ${c.city || ''}">${c.name || c.company || '-'}</td>
                        <td>${c.email || '-'}</td>
                        <td>${c.company || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="showEditModal('customer', ${c.id})" style="margin-right:0.25rem;">Bearbeiten</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteItem('customers', ${c.id})">Löschen</button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="4">Keine Kunden</td></tr>';
            } catch (err) {
                console.error('Error loading customers:', err);
                document.getElementById('customersTable').innerHTML = '<tr><td colspan="4">Fehler beim Laden</td></tr>';
            }
        }

        async function loadTrainers() {
            try {
                const res = await apiCall('/trainers');
                if (!res.ok) {
                    console.error('Failed to load trainers:', res.status);
                    document.getElementById('trainersTable').innerHTML = '<tr><td colspan="4">Fehler beim Laden</td></tr>';
                    return;
                }
                const data = await res.json();
                const trainers = data.items || data;
                document.getElementById('trainersTable').innerHTML = trainers.map(t => {
                    const specs = t.specializations || {selected: [], custom: []};
                    const allSpecs = [...(specs.selected || []), ...(specs.custom || [])];
                    return `
                        <tr>
                            <td style="cursor: pointer;" onclick="showTrainerProfile(${t.id})" title="Klicken für Profil">
                                ${t.photo_path ? `<img src="${escapeHtml(t.photo_path)}" style="width:30px;height:30px;border-radius:50%;margin-right:0.5rem;vertical-align:middle;">` : ''}
                                <strong>${escapeHtml(t.name) || '-'}</strong>
                            </td>
                            <td>${escapeHtml(t.email) || '-'}</td>
                            <td>${allSpecs.slice(0, 3).map(s => escapeHtml(s)).join(', ') || '-'}${allSpecs.length > 3 ? '...' : ''}</td>
                            <td>
                                <button class="btn btn-sm" onclick="showTrainerProfile(${t.id})" style="margin-right:0.25rem;">Profil</button>
                                <button class="btn btn-sm btn-secondary" onclick="showEditModal('trainer', ${t.id})" style="margin-right:0.25rem;">Bearbeiten</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteItem('trainers', ${t.id})">Löschen</button>
                            </td>
                        </tr>
                    `;
                }).join('') || '<tr><td colspan="4">Keine Trainer</td></tr>';
            } catch (err) {
                console.error('Error loading trainers:', err);
                document.getElementById('trainersTable').innerHTML = '<tr><td colspan="4">Fehler beim Laden</td></tr>';
            }
        }

        async function showTrainerProfile(trainerId) {
            try {
                // Load trainer data
                const trainerRes = await apiCall(`/trainers/${trainerId}`);
                if (!trainerRes.ok) {
                    alert('Fehler beim Laden des Trainers');
                    return;
                }
                const trainer = await trainerRes.json();

                // Load training applications for this trainer
                let applications = [];
                let totalRevenue = 0;
                let completedTrainings = 0;
                let acceptedApplications = 0;
                let rejectedApplications = 0;

                try {
                    const appsRes = await apiCall(`/trainers/${trainerId}/applications`);
                    if (appsRes.ok) {
                        applications = await appsRes.json();
                        applications.forEach(app => {
                            if (app.status === 'accepted') {
                                acceptedApplications++;
                                if (app.training_status === 'completed' || app.training_status === 'durchgeführt') {
                                    completedTrainings++;
                                    totalRevenue += app.agreed_rate || app.proposed_rate || 0;
                                }
                            } else if (app.status === 'rejected') {
                                rejectedApplications++;
                            }
                        });
                    }
                } catch (e) {
                    console.log('Could not load trainer applications:', e);
                }

                // Parse specializations
                const specs = trainer.specializations || {selected: [], custom: []};
                const allSpecs = [...(specs.selected || []), ...(specs.custom || [])];

                // Build applications table
                let applicationsHtml = '<p style="color: #6c757d;">Keine Bewerbungen vorhanden</p>';
                if (applications.length > 0) {
                    applicationsHtml = `
                        <table class="trainer-application-table">
                            <thead>
                                <tr>
                                    <th>Training</th>
                                    <th>Status</th>
                                    <th>Tagessatz</th>
                                    <th>Datum</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${applications.map(app => {
                                    const statusLabel = app.status === 'accepted' ? 'Zuschlag' : app.status === 'rejected' ? 'Abgelehnt' : 'Offen';
                                    const statusClass = app.status === 'accepted' ? 'status-accepted' : app.status === 'rejected' ? 'status-rejected' : 'status-pending';
                                    return `
                                        <tr>
                                            <td>${escapeHtml(app.training_title) || '-'}</td>
                                            <td><span class="${statusClass}">${statusLabel}</span></td>
                                            <td>${app.agreed_rate || app.proposed_rate ? (app.agreed_rate || app.proposed_rate) + ' €' : '-'}</td>
                                            <td>${app.created_at ? new Date(app.created_at).toLocaleDateString('de') : '-'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    `;
                }

                const profileHtml = `
                    <div class="trainer-profile-header">
                        ${trainer.photo_path
                            ? `<img src="${escapeHtml(trainer.photo_path)}" class="trainer-profile-photo" alt="Foto">`
                            : `<div class="trainer-profile-photo-placeholder">${escapeHtml((trainer.first_name || trainer.name || '?')[0])}</div>`
                        }
                        <div class="trainer-profile-main">
                            <h2 class="trainer-profile-name">${escapeHtml(trainer.name || (trainer.first_name + ' ' + trainer.last_name))}</h2>
                            <div class="trainer-profile-contact">
                                <div class="trainer-profile-contact-item">
                                    <span>📧</span> ${escapeHtml(trainer.email) || '-'}
                                </div>
                                <div class="trainer-profile-contact-item">
                                    <span>📱</span> ${escapeHtml(trainer.phone) || '-'}
                                </div>
                                <div class="trainer-profile-contact-item">
                                    <span>📍</span> ${escapeHtml(trainer.region) || '-'}
                                </div>
                                <div class="trainer-profile-contact-item">
                                    <span>💰</span> ${trainer.default_day_rate ? trainer.default_day_rate + ' €/Tag' : '-'}
                                </div>
                            </div>
                            <div class="trainer-profile-badges">
                                ${allSpecs.map(s => `<span class="trainer-profile-badge">${escapeHtml(s)}</span>`).join('')}
                            </div>
                        </div>
                    </div>

                    <div class="trainer-profile-stats">
                        <div class="trainer-profile-stat">
                            <div class="trainer-profile-stat-value">${completedTrainings}</div>
                            <div class="trainer-profile-stat-label">Trainings durchgeführt</div>
                        </div>
                        <div class="trainer-profile-stat">
                            <div class="trainer-profile-stat-value">${acceptedApplications}</div>
                            <div class="trainer-profile-stat-label">Zuschläge erhalten</div>
                        </div>
                        <div class="trainer-profile-stat">
                            <div class="trainer-profile-stat-value">${totalRevenue.toLocaleString('de')} €</div>
                            <div class="trainer-profile-stat-label">Umsatz mit uns</div>
                        </div>
                    </div>

                    <div class="trainer-profile-section">
                        <h4 class="trainer-profile-section-title">Kontaktdaten & Adresse</h4>
                        <div class="trainer-profile-grid">
                            <div class="trainer-profile-field">
                                <div class="trainer-profile-field-label">Straße</div>
                                <div class="trainer-profile-field-value">${escapeHtml(trainer.street) || '-'} ${escapeHtml(trainer.street_number) || ''}</div>
                            </div>
                            <div class="trainer-profile-field">
                                <div class="trainer-profile-field-label">PLZ / Ort</div>
                                <div class="trainer-profile-field-value">${escapeHtml(trainer.postal_code) || ''} ${escapeHtml(trainer.city) || '-'}</div>
                            </div>
                            <div class="trainer-profile-field">
                                <div class="trainer-profile-field-label">USt-ID</div>
                                <div class="trainer-profile-field-value">${escapeHtml(trainer.vat_id) || '-'}</div>
                            </div>
                            <div class="trainer-profile-field">
                                <div class="trainer-profile-field-label">Region</div>
                                <div class="trainer-profile-field-value">${escapeHtml(trainer.region) || '-'}</div>
                            </div>
                            <div class="trainer-profile-field">
                                <div class="trainer-profile-field-label">LinkedIn</div>
                                <div class="trainer-profile-field-value">
                                    ${trainer.linkedin_url ? `<a href="${escapeHtml(trainer.linkedin_url)}" target="_blank">LinkedIn Profil</a>` : '-'}
                                </div>
                            </div>
                            <div class="trainer-profile-field">
                                <div class="trainer-profile-field-label">Website</div>
                                <div class="trainer-profile-field-value">
                                    ${trainer.website ? `<a href="${escapeHtml(trainer.website)}" target="_blank">${escapeHtml(trainer.website)}</a>` : '-'}
                                </div>
                            </div>
                        </div>
                    </div>

                    ${trainer.bio ? `
                    <div class="trainer-profile-section">
                        <h4 class="trainer-profile-section-title">Bio</h4>
                        <p style="white-space: pre-wrap;">${escapeHtml(trainer.bio)}</p>
                    </div>
                    ` : ''}

                    ${trainer.notes ? `
                    <div class="trainer-profile-section">
                        <h4 class="trainer-profile-section-title">Interne Notizen</h4>
                        <p style="white-space: pre-wrap;">${escapeHtml(trainer.notes)}</p>
                    </div>
                    ` : ''}

                    <div class="trainer-profile-section">
                        <h4 class="trainer-profile-section-title">Training-Bewerbungen</h4>
                        ${applicationsHtml}
                    </div>

                    <div class="trainer-profile-actions">
                        <button class="btn btn-secondary" onclick="showEditModal('trainer', ${trainer.id}); closeTrainerProfileModal();">
                            Bearbeiten
                        </button>
                        ${trainer.linkedin_url ? `
                        <a href="${escapeHtml(trainer.linkedin_url)}" target="_blank" class="btn btn-secondary">
                            LinkedIn
                        </a>
                        ` : ''}
                    </div>
                `;

                document.getElementById('trainerProfileContent').innerHTML = profileHtml;
                document.getElementById('trainerProfileModal').style.display = 'flex';
            } catch (error) {
                console.error('Error:', error);
                alert('Fehler beim Laden des Trainer-Profils');
            }
        }

        async function loadBrands() {
            try {
                console.log('Loading brands...');
                const res = await apiCall('/brands');
                console.log('Brands response status:', res.status);
                if (!res.ok) {
                    console.error('Failed to load brands:', res.status);
                    document.getElementById('brandsTable').innerHTML = '<tr><td colspan="3">Fehler beim Laden</td></tr>';
                    return;
                }
                const data = await res.json();
                const brands = data.items || data;
                console.log('Loaded brands:', brands);

                // Hide create button for trainers
                const createBrandBtn = document.querySelector('#section-brands .btn-success');
                if (createBrandBtn && currentUser && currentUser.role === 'trainer') {
                    createBrandBtn.style.display = 'none';
                }

                document.getElementById('brandsTable').innerHTML = brands.map(b => `
                    <tr>
                        <td>${b.name || '-'}</td>
                        <td>${b.description || '-'}</td>
                        <td>
                            ${currentUser && currentUser.role !== 'trainer' ? `
                                <button class="btn btn-sm btn-secondary" onclick="showEditModal('brand', ${b.id})" style="margin-right:0.25rem;">Bearbeiten</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteItem('brands', ${b.id})">Löschen</button>
                            ` : ''}
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="3">Keine Marken</td></tr>';
            } catch (err) {
                console.error('Error loading brands:', err);
                document.getElementById('brandsTable').innerHTML = '<tr><td colspan="3">Fehler beim Laden</td></tr>';
            }
        }

        async function loadLocations() {
            try {
                console.log('Loading locations...');
                const res = await apiCall('/locations');
                console.log('Locations response status:', res.status);
                if (!res.ok) {
                    console.error('Failed to load locations:', res.status);
                    document.getElementById('locationsTable').innerHTML = '<tr><td colspan="5">Fehler beim Laden</td></tr>';
                    return;
                }
                const data = await res.json();
                const locations = data.items || data;
                console.log('Loaded locations:', locations);

                const cateringLabels = { yes: 'Ja', no: 'Nein', external: 'Extern' };

                document.getElementById('locationsTable').innerHTML = locations.map(loc => `
                    <tr>
                        <td>${loc.name || '-'}</td>
                        <td>${loc.city || '-'}</td>
                        <td>${loc.max_participants || '-'}</td>
                        <td>${cateringLabels[loc.catering_available] || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="showEditModal('location', ${loc.id})" style="margin-right:0.25rem;">Bearbeiten</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteItem('locations', ${loc.id})">Löschen</button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="5">Keine Locations</td></tr>';
            } catch (err) {
                console.error('Error loading locations:', err);
                document.getElementById('locationsTable').innerHTML = '<tr><td colspan="5">Fehler beim Laden</td></tr>';
            }
        }

        async function deleteItem(type, id) {
            if (!confirm('Wirklich löschen?')) return;
            const res = await apiCall(`/${type}/${id}`, { method: 'DELETE' });
            if (!res.ok) {
                const error = await res.json().catch(() => ({}));
                alert(error.error || 'Fehler beim Löschen');
                return;
            }
            showSection(type);
        }

        // Predefined specializations for trainers
        const TRAINER_SPECIALIZATIONS = [
            'Leadership', 'Agile/Scrum', 'Project Management', 'Communication',
            'Sales', 'Marketing', 'IT/Software', 'Data Science', 'Cloud/DevOps',
            'Security', 'Change Management', 'Team Building', 'Presentation Skills'
        ];

        const formFields = {
            training: 'custom', // Special handling for extended training form
            customer: 'custom', // Special handling for customer form
            trainer: 'custom', // Special handling for trainer form
            location: 'custom', // Special handling for location form
            brand: [
                { name: 'name', label: 'Name', type: 'text', required: true },
                { name: 'description', label: 'Beschreibung', type: 'textarea' }
            ],
            user: [
                { name: 'username', label: 'Benutzername', type: 'text', required: true },
                { name: 'email', label: 'Email', type: 'email', required: true },
                { name: 'password', label: 'Passwort', type: 'password', required: true },
                { name: 'role', label: 'Rolle', type: 'select', options: ['backoffice_user', 'trainer', 'admin'] },
                { name: 'is_active', label: 'Aktiv', type: 'checkbox' }
            ]
        };

        // Cache for dropdowns
        let cachedBrands = [];
        let cachedCustomers = [];
        let cachedTrainers = [];
        let cachedLocations = [];

        async function loadFormData() {
            const [brandsRes, customersRes, trainersRes, locationsRes] = await Promise.all([
                apiCall('/brands'),
                apiCall('/customers'),
                apiCall('/trainers'),
                apiCall('/locations')
            ]);
            if (brandsRes.ok) cachedBrands = await brandsRes.json();
            if (customersRes.ok) cachedCustomers = await customersRes.json();
            if (trainersRes.ok) cachedTrainers = await trainersRes.json();
            if (locationsRes.ok) cachedLocations = await locationsRes.json();
        }

        // Store form data for inline customer creation
        let savedTrainingFormData = null;

        function generateTrainingForm(data = {}) {
            const durationValue = data.duration_type === 'hours' ? (data.duration_hours || 8) : (data.duration_days || 1);
            return `
                <div class="form-group">
                    <label>Titel *</label>
                    <input type="text" name="title" value="${data.title || ''}" required style="width:100%;padding:0.5rem;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Marke</label>
                        <select name="brand_id" style="width:100%;padding:0.5rem;">
                            <option value="">-- Auswählen --</option>
                            ${cachedBrands.map(b => `<option value="${b.id}" ${data.brand_id == b.id ? 'selected' : ''}>${b.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Kunde</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <select name="customer_id" style="flex:1;padding:0.5rem;">
                                <option value="">-- Auswählen --</option>
                                ${cachedCustomers.map(c => `<option value="${c.id}" ${data.customer_id == c.id ? 'selected' : ''}>${c.company || c.name}</option>`).join('')}
                            </select>
                            <button type="button" onclick="openInlineCustomerCreate()" class="btn btn-sm btn-success" title="Neuen Kunden anlegen">+</button>
                        </div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Trainer</label>
                        <select name="trainer_id" style="width:100%;padding:0.5rem;">
                            <option value="">-- Kein Trainer --</option>
                            ${cachedTrainers.map(t => `<option value="${t.id}" ${data.trainer_id == t.id ? 'selected' : ''}>${t.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select name="status" style="width:100%;padding:0.5rem;">
                            ${['lead', 'appointment_scheduled', 'initial_contact', 'proposal_sent', 'trainer_outreach', 'trainer_confirmed', 'planning', 'delivered', 'invoiced'].map(s =>
                                `<option value="${s}" ${data.status === s ? 'selected' : ''}>${s}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Startdatum</label>
                        <input type="date" name="start_date" value="${data.start_date ? data.start_date.split('T')[0] : ''}" style="width:100%;padding:0.5rem;">
                    </div>
                    <div class="form-group">
                        <label>Enddatum</label>
                        <input type="date" name="end_date" value="${data.end_date ? data.end_date.split('T')[0] : ''}" style="width:100%;padding:0.5rem;">
                    </div>
                    <div class="form-group">
                        <label>Dauer</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="number" name="duration_value" value="${durationValue}" min="1" style="flex:1;padding:0.5rem;" onchange="calculateInternalPrice()">
                            <select name="duration_type" style="width:80px;padding:0.5rem;" onchange="calculateInternalPrice()">
                                <option value="days" ${data.duration_type !== 'hours' ? 'selected' : ''}>Tage</option>
                                <option value="hours" ${data.duration_type === 'hours' ? 'selected' : ''}>Std.</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Zeitraum (Wunschzeitraum des Kunden)</label>
                    <input type="text" name="zeitraum" value="${data.zeitraum || ''}" placeholder="z.B. Q1 2025, März-April, etc." style="width:100%;padding:0.5rem;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Trainingsart</label>
                        <select name="training_type" style="width:100%;padding:0.5rem;">
                            <option value="classroom" ${data.training_type === 'classroom' ? 'selected' : ''}>Präsenz</option>
                            <option value="online" ${data.training_type === 'online' ? 'selected' : ''}>Online</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Format</label>
                        <select name="training_format" style="width:100%;padding:0.5rem;">
                            <option value="inhouse" ${data.training_format === 'inhouse' ? 'selected' : ''}>Inhouse</option>
                            <option value="public" ${data.training_format === 'public' ? 'selected' : ''}>Öffentlich</option>
                        </select>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Location buchen</label>
                        <input type="text" name="location_booking" value="${data.location_booking || ''}" placeholder="z.B. Hotel, Konferenzraum..." style="width:100%;padding:0.5rem;">
                    </div>
                    <div class="form-group">
                        <label>Catering buchen</label>
                        <input type="text" name="catering_booking" value="${data.catering_booking || ''}" placeholder="z.B. Mittagessen, Getränke..." style="width:100%;padding:0.5rem;">
                    </div>
                </div>
                <div class="form-group">
                    <label>Ort</label>
                    <input type="text" name="location" value="${data.location || ''}" style="width:100%;padding:0.5rem;">
                </div>

                <fieldset style="border: 1px solid #ddd; padding: 1rem; margin: 1rem 0; border-radius: 4px;">
                    <legend style="font-weight: 600; padding: 0 0.5rem; color: var(--yb-hellblau);">Kosten & Preise</legend>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Tagessatz Trainer (€)</label>
                            <input type="number" name="tagessatz" id="tagessatz" value="${data.tagessatz || ''}" step="0.01" style="width:100%;padding:0.5rem;" onchange="calculateInternalPrice()">
                        </div>
                        <div class="form-group">
                            <label>Location-Kosten (€)</label>
                            <input type="number" name="location_cost" id="location_cost" value="${data.location_cost || ''}" step="0.01" style="width:100%;padding:0.5rem;" onchange="calculateInternalPrice()">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Catering-Kosten (€)</label>
                            <input type="number" name="catering_cost" id="catering_cost" value="${data.catering_cost || ''}" step="0.01" style="width:100%;padding:0.5rem;" onchange="calculateInternalPrice()">
                        </div>
                        <div class="form-group">
                            <label>Provision (€)</label>
                            <input type="number" name="provision" id="provision" value="${data.provision || ''}" step="0.01" style="width:100%;padding:0.5rem;" onchange="calculateInternalPrice()">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Sonstige Kosten (€)</label>
                        <input type="number" name="other_costs" id="other_costs" value="${data.other_costs || ''}" step="0.01" style="width:100%;padding:0.5rem;" onchange="calculateInternalPrice()">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #ddd;">
                        <div class="form-group">
                            <label><strong>Preis Intern (€)</strong> <small style="color: #666;">(berechnet)</small></label>
                            <input type="number" name="price_internal" id="price_internal" value="${data.price_internal || ''}" step="0.01" style="width:100%;padding:0.5rem;background:#f5f5f5;" readonly>
                        </div>
                        <div class="form-group">
                            <label><strong>Preis Extern (€)</strong></label>
                            <input type="number" name="price_external" id="price_external" value="${data.price_external || ''}" step="0.01" style="width:100%;padding:0.5rem;" onchange="calculatePricePerParticipant()">
                        </div>
                        <div class="form-group">
                            <label><strong>Preis/Teilnehmer (€)</strong></label>
                            <input type="number" name="price_per_participant" id="price_per_participant" value="${data.price_per_participant || ''}" step="0.01" style="width:100%;padding:0.5rem;background:#f5f5f5;" readonly>
                        </div>
                    </div>
                </fieldset>

                <div class="form-group">
                    <label>Max. Teilnehmer</label>
                    <input type="number" name="max_participants" id="max_participants" value="${data.max_participants || ''}" style="width:100%;padding:0.5rem;" onchange="calculatePricePerParticipant()">
                </div>
                <div class="form-group">
                    <label>Interne Notizen</label>
                    <textarea name="internal_notes" style="width:100%;padding:0.5rem;min-height:60px;">${data.internal_notes || ''}</textarea>
                </div>
            `;
        }

        function calculateInternalPrice() {
            const tagessatz = parseFloat(document.getElementById('tagessatz')?.value) || 0;
            const locationCost = parseFloat(document.getElementById('location_cost')?.value) || 0;
            const cateringCost = parseFloat(document.getElementById('catering_cost')?.value) || 0;
            const provision = parseFloat(document.getElementById('provision')?.value) || 0;
            const otherCosts = parseFloat(document.getElementById('other_costs')?.value) || 0;

            // Get duration
            const durationValue = parseFloat(document.querySelector('[name="duration_value"]')?.value) || 1;
            const durationType = document.querySelector('[name="duration_type"]')?.value || 'days';
            const days = durationType === 'hours' ? durationValue / 8 : durationValue;

            // Calculate trainer cost
            const trainerCost = tagessatz * days;

            // Calculate total
            const total = trainerCost + locationCost + cateringCost + provision + otherCosts;

            const priceInternalField = document.getElementById('price_internal');
            if (priceInternalField) {
                priceInternalField.value = total.toFixed(2);
            }
        }

        function calculatePricePerParticipant() {
            const priceExternal = parseFloat(document.getElementById('price_external')?.value) || 0;
            const maxParticipants = parseInt(document.getElementById('max_participants')?.value) || 0;

            const pricePerParticipantField = document.getElementById('price_per_participant');
            if (pricePerParticipantField) {
                if (maxParticipants > 0) {
                    pricePerParticipantField.value = (priceExternal / maxParticipants).toFixed(2);
                } else {
                    pricePerParticipantField.value = '';
                }
            }
        }

        function openInlineCustomerCreate() {
            // Save current training form data
            const form = document.getElementById('createForm');
            const formData = new FormData(form);
            savedTrainingFormData = {};
            for (let [key, value] of formData.entries()) {
                if (key.startsWith('spec_')) {
                    if (!savedTrainingFormData[key]) savedTrainingFormData[key] = [];
                    savedTrainingFormData[key].push(value);
                } else {
                    savedTrainingFormData[key] = value;
                }
            }

            // Show customer form
            document.getElementById('modalTitle').textContent = 'Neuen Kunden anlegen';
            document.getElementById('modalFields').innerHTML = generateCustomerForm() + `
                <input type="hidden" name="return_to_training" value="true">
            `;
            currentFormType = 'customer';
        }

        async function returnToTrainingForm(newCustomerId = null) {
            if (savedTrainingFormData) {
                await loadFormData(); // Reload to get new customer
                if (newCustomerId) {
                    savedTrainingFormData.customer_id = newCustomerId;
                }
                currentFormType = 'training';
                document.getElementById('modalTitle').textContent = 'Training erstellen';
                document.getElementById('modalFields').innerHTML = generateTrainingForm(savedTrainingFormData);
                savedTrainingFormData = null;
            }
        }

        function generateCustomerForm() {
            return `
                <div class="form-group">
                    <label>Firma *</label>
                    <input type="text" name="company_name" required style="width:100%;padding:0.5rem;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Anrede</label>
                        <select name="salutation" style="width:100%;padding:0.5rem;">
                            <option value="">---</option>
                            <option value="Frau">Frau</option>
                            <option value="Herr">Herr</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Vorname</label>
                        <input type="text" name="first_name" style="width:100%;padding:0.5rem;">
                    </div>
                    <div class="form-group">
                        <label>Nachname</label>
                        <input type="text" name="last_name" style="width:100%;padding:0.5rem;">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" name="contact_email" style="width:100%;padding:0.5rem;">
                    </div>
                    <div class="form-group">
                        <label>Telefon</label>
                        <input type="text" name="contact_phone" style="width:100%;padding:0.5rem;">
                    </div>
                </div>
                <div class="form-group">
                    <label>VAT/USt-ID</label>
                    <input type="text" name="vat_number" style="width:100%;padding:0.5rem;">
                </div>
                <fieldset style="border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                    <legend style="font-weight: 600; padding: 0 0.5rem;">Rechnungsadresse</legend>
                    <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Straße</label>
                            <input type="text" name="street" style="width:100%;padding:0.5rem;">
                        </div>
                        <div class="form-group">
                            <label>Nr.</label>
                            <input type="text" name="street_number" style="width:100%;padding:0.5rem;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem;">
                        <div class="form-group">
                            <label>PLZ</label>
                            <input type="text" name="postal_code" style="width:100%;padding:0.5rem;">
                        </div>
                        <div class="form-group">
                            <label>Ort</label>
                            <input type="text" name="city" style="width:100%;padding:0.5rem;">
                        </div>
                    </div>
                </fieldset>
                <div class="form-group">
                    <label>Konditionen</label>
                    <textarea name="conditions" style="width:100%;padding:0.5rem;min-height:60px;" placeholder="Zahlungsbedingungen, Rabatte, etc."></textarea>
                </div>
                <div class="form-group">
                    <label>Kommentar</label>
                    <textarea name="comment" style="width:100%;padding:0.5rem;min-height:80px;"></textarea>
                </div>
            `;
        }

        function generateTrainerForm() {
            return `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Vorname *</label>
                        <input type="text" name="first_name" required style="width:100%;padding:0.5rem;">
                    </div>
                    <div class="form-group">
                        <label>Nachname *</label>
                        <input type="text" name="last_name" required style="width:100%;padding:0.5rem;">
                    </div>
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" name="email" required style="width:100%;padding:0.5rem;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Telefon</label>
                        <input type="text" name="phone" style="width:100%;padding:0.5rem;">
                    </div>
                    <div class="form-group">
                        <label>VAT/USt-ID</label>
                        <input type="text" name="vat_number" style="width:100%;padding:0.5rem;">
                    </div>
                </div>
                <div class="form-group">
                    <label>Adresse</label>
                    <textarea name="address" style="width:100%;padding:0.5rem;min-height:60px;"></textarea>
                </div>
                <div class="form-group">
                    <label>LinkedIn URL</label>
                    <input type="url" name="linkedin_url" placeholder="https://linkedin.com/in/..." style="width:100%;padding:0.5rem;">
                </div>
                <div class="form-group">
                    <label>Webseite</label>
                    <input type="url" name="website" placeholder="https://www.beispiel.de" style="width:100%;padding:0.5rem;">
                </div>
                <div class="form-group">
                    <label>Spezialisierungen</label>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-bottom: 0.5rem;">
                        ${TRAINER_SPECIALIZATIONS.map(spec => `
                            <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal;">
                                <input type="checkbox" name="spec_selected" value="${spec}">
                                ${spec}
                            </label>
                        `).join('')}
                    </div>
                    <div id="customSpecsContainer">
                        <div class="custom-spec-row" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <input type="text" name="spec_custom" placeholder="Eigene Spezialisierung..." style="flex:1;padding:0.5rem;">
                        </div>
                    </div>
                    <button type="button" onclick="addCustomSpecField()" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;">+ Weitere</button>
                </div>
                <div class="form-group">
                    <label>Tagessatz (€)</label>
                    <input type="number" name="default_day_rate" step="0.01" style="width:100%;padding:0.5rem;">
                </div>
                <div class="form-group">
                    <label>Region</label>
                    <input type="text" name="region" style="width:100%;padding:0.5rem;">
                </div>
                <div class="form-group">
                    <label>Bio</label>
                    <textarea name="bio" style="width:100%;padding:0.5rem;min-height:80px;"></textarea>
                </div>
                <div class="form-group">
                    <label>Notizen</label>
                    <textarea name="notes" style="width:100%;padding:0.5rem;min-height:60px;"></textarea>
                </div>
            `;
        }

        function addCustomSpecField() {
            const container = document.getElementById('customSpecsContainer');
            const newRow = document.createElement('div');
            newRow.className = 'custom-spec-row';
            newRow.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem;';
            newRow.innerHTML = `<input type="text" name="spec_custom" placeholder="Eigene Spezialisierung..." style="flex:1;padding:0.5rem;">`;
            container.appendChild(newRow);
        }

        let currentFormType = '';
        let editingId = null;

        async function showCreateModal(type) {
            currentFormType = type;
            editingId = null;
            const titles = { training: 'Training', customer: 'Kunde', trainer: 'Trainer', brand: 'Marke', user: 'Benutzer', location: 'Location' };
            document.getElementById('modalTitle').textContent = `${titles[type]} erstellen`;

            // Ensure submit button is visible (may have been hidden for view-only modals)
            const submitBtn = document.querySelector('#createForm button[type="submit"]');
            if (submitBtn) submitBtn.style.display = 'block';

            const fields = formFields[type];

            if (fields === 'custom') {
                if (type === 'training') {
                    await loadFormData();
                    document.getElementById('modalFields').innerHTML = generateTrainingForm();
                } else if (type === 'trainer') {
                    document.getElementById('modalFields').innerHTML = generateTrainerForm();
                } else if (type === 'customer') {
                    document.getElementById('modalFields').innerHTML = generateCustomerForm();
                } else if (type === 'location') {
                    document.getElementById('modalFields').innerHTML = generateLocationForm();
                }
            } else {
                document.getElementById('modalFields').innerHTML = fields.map(f => `
                    <div class="form-group">
                        <label>${f.label}</label>
                        ${f.type === 'textarea'
                            ? `<textarea name="${f.name}" style="width:100%;padding:0.5rem;min-height:80px;"></textarea>`
                            : f.type === 'select'
                            ? `<select name="${f.name}" style="width:100%;padding:0.5rem;">
                                ${f.options.map(o => `<option value="${o}">${o}</option>`).join('')}
                               </select>`
                            : f.type === 'checkbox'
                            ? `<input type="checkbox" name="${f.name}" checked>`
                            : `<input type="${f.type}" name="${f.name}" ${f.required ? 'required' : ''} style="width:100%;padding:0.5rem;">`
                        }
                    </div>
                `).join('');
            }

            document.getElementById('createModal').style.display = 'flex';
        }

        async function showEditModal(type, id) {
            currentFormType = type;
            editingId = id;
            const titles = { training: 'Training', customer: 'Kunde', trainer: 'Trainer', brand: 'Marke', user: 'Benutzer', location: 'Location' };
            document.getElementById('modalTitle').textContent = `${titles[type]} bearbeiten`;

            // Ensure submit button is visible (may have been hidden for view-only modals)
            const submitBtn = document.querySelector('#createForm button[type="submit"]');
            if (submitBtn) submitBtn.style.display = 'block';

            // Load the item data
            const res = await apiCall(`/${type}s/${id}`);
            if (!res.ok) {
                alert('Fehler beim Laden');
                return;
            }
            const data = await res.json();

            const fields = formFields[type];

            if (fields === 'custom') {
                if (type === 'training') {
                    await loadFormData();
                    document.getElementById('modalFields').innerHTML = generateTrainingForm(data);
                } else if (type === 'trainer') {
                    document.getElementById('modalFields').innerHTML = generateTrainerFormWithData(data);
                } else if (type === 'customer') {
                    document.getElementById('modalFields').innerHTML = generateCustomerFormWithData(data);
                } else if (type === 'location') {
                    document.getElementById('modalFields').innerHTML = generateLocationFormWithData(data);
                }
            } else {
                document.getElementById('modalFields').innerHTML = fields.map(f => `
                    <div class="form-group">
                        <label>${f.label}</label>
                        ${f.type === 'textarea'
                            ? `<textarea name="${f.name}" style="width:100%;padding:0.5rem;min-height:80px;">${data[f.name] || ''}</textarea>`
                            : f.type === 'select'
                            ? `<select name="${f.name}" style="width:100%;padding:0.5rem;">
                                ${f.options.map(o => `<option value="${o}" ${data[f.name] === o ? 'selected' : ''}>${o}</option>`).join('')}
                               </select>`
                            : f.type === 'checkbox'
                            ? `<input type="checkbox" name="${f.name}" ${data[f.name] ? 'checked' : ''}>`
                            : `<input type="${f.type}" name="${f.name}" value="${data[f.name] || ''}" ${f.required ? 'required' : ''} style="width:100%;padding:0.5rem;">`
                        }
                    </div>
                `).join('');
            }

            document.getElementById('createModal').style.display = 'flex';
        }

        function generateCustomerFormWithData(data) {
            return `
                <div class="form-group">
                    <label>Firma *</label>
                    <input type="text" name="company_name" value="${data.company || ''}" required style="width:100%;padding:0.5rem;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Anrede</label>
                        <select name="salutation" style="width:100%;padding:0.5rem;">
                            <option value="" ${!data.salutation ? 'selected' : ''}>---</option>
                            <option value="Frau" ${data.salutation === 'Frau' ? 'selected' : ''}>Frau</option>
                            <option value="Herr" ${data.salutation === 'Herr' ? 'selected' : ''}>Herr</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Vorname</label>
                        <input type="text" name="first_name" value="${data.first_name || ''}" style="width:100%;padding:0.5rem;">
                    </div>
                    <div class="form-group">
                        <label>Nachname</label>
                        <input type="text" name="last_name" value="${data.last_name || ''}" style="width:100%;padding:0.5rem;">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" name="contact_email" value="${data.email || ''}" style="width:100%;padding:0.5rem;">
                    </div>
                    <div class="form-group">
                        <label>Telefon</label>
                        <input type="text" name="contact_phone" value="${data.phone || ''}" style="width:100%;padding:0.5rem;">
                    </div>
                </div>
                <div class="form-group">
                    <label>VAT/USt-ID</label>
                    <input type="text" name="vat_number" value="${data.vat_number || ''}" style="width:100%;padding:0.5rem;">
                </div>
                <fieldset style="border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                    <legend style="font-weight: 600; padding: 0 0.5rem;">Rechnungsadresse</legend>
                    <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Straße</label>
                            <input type="text" name="street" value="${data.street || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                        <div class="form-group">
                            <label>Nr.</label>
                            <input type="text" name="street_number" value="${data.street_number || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem;">
                        <div class="form-group">
                            <label>PLZ</label>
                            <input type="text" name="postal_code" value="${data.postal_code || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                        <div class="form-group">
                            <label>Ort</label>
                            <input type="text" name="city" value="${data.city || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                    </div>
                </fieldset>
                <div class="form-group">
                    <label>Konditionen</label>
                    <textarea name="conditions" style="width:100%;padding:0.5rem;min-height:60px;">${data.conditions || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Kommentar</label>
                    <textarea name="comment" style="width:100%;padding:0.5rem;min-height:80px;">${data.comment || ''}</textarea>
                </div>
            `;
        }

        function generateLocationForm() {
            return generateLocationFormWithData({});
        }

        function generateLocationFormWithData(data) {
            return `
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" name="name" value="${data.name || ''}" required style="width:100%;padding:0.5rem;">
                </div>

                <fieldset style="border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                    <legend style="font-weight: 600; padding: 0 0.5rem;">Adresse</legend>
                    <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Straße</label>
                            <input type="text" name="street" value="${data.street || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                        <div class="form-group">
                            <label>Nr.</label>
                            <input type="text" name="street_number" value="${data.street_number || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem;">
                        <div class="form-group">
                            <label>PLZ</label>
                            <input type="text" name="postal_code" value="${data.postal_code || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                        <div class="form-group">
                            <label>Ort</label>
                            <input type="text" name="city" value="${data.city || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                    </div>
                </fieldset>

                <fieldset style="border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                    <legend style="font-weight: 600; padding: 0 0.5rem;">Rechnungsadresse</legend>
                    <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Straße</label>
                            <input type="text" name="billing_street" value="${data.billing_street || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                        <div class="form-group">
                            <label>Nr.</label>
                            <input type="text" name="billing_street_number" value="${data.billing_street_number || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem;">
                        <div class="form-group">
                            <label>PLZ</label>
                            <input type="text" name="billing_postal_code" value="${data.billing_postal_code || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                        <div class="form-group">
                            <label>Ort</label>
                            <input type="text" name="billing_city" value="${data.billing_city || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>VAT/USt-ID</label>
                        <input type="text" name="billing_vat" value="${data.billing_vat || ''}" style="width:100%;padding:0.5rem;">
                    </div>
                </fieldset>

                <fieldset style="border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                    <legend style="font-weight: 600; padding: 0 0.5rem;">Ansprechpartner</legend>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Vorname</label>
                            <input type="text" name="contact_first_name" value="${data.contact_first_name || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                        <div class="form-group">
                            <label>Nachname</label>
                            <input type="text" name="contact_last_name" value="${data.contact_last_name || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" name="contact_email" value="${data.contact_email || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                        <div class="form-group">
                            <label>Telefon</label>
                            <input type="text" name="contact_phone" value="${data.contact_phone || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Hinweise</label>
                        <textarea name="contact_notes" style="width:100%;padding:0.5rem;min-height:60px;">${data.contact_notes || ''}</textarea>
                    </div>
                </fieldset>

                <fieldset style="border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                    <legend style="font-weight: 600; padding: 0 0.5rem;">Location Details</legend>
                    <div class="form-group">
                        <label>Location Beschreibung</label>
                        <textarea name="description" style="width:100%;padding:0.5rem;min-height:80px;">${data.description || ''}</textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Max Teilnehmer</label>
                            <input type="number" name="max_participants" value="${data.max_participants || ''}" style="width:100%;padding:0.5rem;">
                        </div>
                        <div class="form-group">
                            <label>Catering vorhanden</label>
                            <select name="catering_available" style="width:100%;padding:0.5rem;">
                                <option value="no" ${data.catering_available === 'no' || !data.catering_available ? 'selected' : ''}>Nein</option>
                                <option value="yes" ${data.catering_available === 'yes' ? 'selected' : ''}>Ja</option>
                                <option value="external" ${data.catering_available === 'external' ? 'selected' : ''}>Extern</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Features</label>
                        <textarea name="features" style="width:100%;padding:0.5rem;min-height:60px;" placeholder="z.B. Beamer, Whiteboard, WLAN...">${data.features || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Link zur Location</label>
                        <input type="url" name="website_link" value="${data.website_link || ''}" style="width:100%;padding:0.5rem;" placeholder="https://...">
                    </div>
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Mietkosten (€)</label>
                            <input type="number" name="rental_cost" value="${data.rental_cost || ''}" step="0.01" style="width:100%;padding:0.5rem;">
                        </div>
                        <div class="form-group">
                            <label>Kosten pro</label>
                            <select name="rental_cost_type" style="width:100%;padding:0.5rem;">
                                <option value="day" ${data.rental_cost_type === 'day' || !data.rental_cost_type ? 'selected' : ''}>Tag</option>
                                <option value="hour" ${data.rental_cost_type === 'hour' ? 'selected' : ''}>Stunde</option>
                                <option value="total" ${data.rental_cost_type === 'total' ? 'selected' : ''}>Gesamt</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Parken</label>
                        <textarea name="parking" style="width:100%;padding:0.5rem;min-height:60px;">${data.parking || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Anreise</label>
                        <textarea name="directions" style="width:100%;padding:0.5rem;min-height:60px;">${data.directions || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Informationen für TN</label>
                        <textarea name="participant_info" style="width:100%;padding:0.5rem;min-height:80px;">${data.participant_info || ''}</textarea>
                    </div>
                </fieldset>
            `;
        }

        function generateTrainerFormWithData(data) {
            const specs = data.specializations || {selected: [], custom: []};
            return `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Vorname *</label>
                        <input type="text" name="first_name" value="${data.first_name || ''}" required style="width:100%;padding:0.5rem;">
                    </div>
                    <div class="form-group">
                        <label>Nachname *</label>
                        <input type="text" name="last_name" value="${data.last_name || ''}" required style="width:100%;padding:0.5rem;">
                    </div>
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" name="email" value="${data.email || ''}" required style="width:100%;padding:0.5rem;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Telefon</label>
                        <input type="text" name="phone" value="${data.phone || ''}" style="width:100%;padding:0.5rem;">
                    </div>
                    <div class="form-group">
                        <label>VAT/USt-ID</label>
                        <input type="text" name="vat_number" value="${data.vat_number || ''}" style="width:100%;padding:0.5rem;">
                    </div>
                </div>
                <div class="form-group">
                    <label>Adresse</label>
                    <textarea name="address" style="width:100%;padding:0.5rem;min-height:60px;">${data.address || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>LinkedIn URL</label>
                    <input type="url" name="linkedin_url" value="${data.linkedin_url || ''}" style="width:100%;padding:0.5rem;">
                </div>
                <div class="form-group">
                    <label>Webseite</label>
                    <input type="url" name="website" value="${data.website || ''}" style="width:100%;padding:0.5rem;">
                </div>
                <div class="form-group">
                    <label>Spezialisierungen</label>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-bottom: 0.5rem;">
                        ${TRAINER_SPECIALIZATIONS.map(spec => `
                            <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal;">
                                <input type="checkbox" name="spec_selected" value="${spec}" ${specs.selected && specs.selected.includes(spec) ? 'checked' : ''}>
                                ${spec}
                            </label>
                        `).join('')}
                    </div>
                    <div id="customSpecsContainer">
                        ${(specs.custom || []).map(c => `
                            <div class="custom-spec-row" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <input type="text" name="spec_custom" value="${c}" style="flex:1;padding:0.5rem;">
                            </div>
                        `).join('')}
                        <div class="custom-spec-row" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <input type="text" name="spec_custom" placeholder="Eigene Spezialisierung..." style="flex:1;padding:0.5rem;">
                        </div>
                    </div>
                    <button type="button" onclick="addCustomSpecField()" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;">+ Weitere</button>
                </div>
                <div class="form-group">
                    <label>Tagessatz (€)</label>
                    <input type="number" name="default_day_rate" value="${data.default_day_rate || ''}" step="0.01" style="width:100%;padding:0.5rem;">
                </div>
                <div class="form-group">
                    <label>Region</label>
                    <input type="text" name="region" value="${data.region || ''}" style="width:100%;padding:0.5rem;">
                </div>
                <div class="form-group">
                    <label>Bio</label>
                    <textarea name="bio" style="width:100%;padding:0.5rem;min-height:80px;">${data.bio || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Notizen</label>
                    <textarea name="notes" style="width:100%;padding:0.5rem;min-height:60px;">${data.notes || ''}</textarea>
                </div>
            `;
        }

        function closeModal() {
            document.getElementById('createModal').style.display = 'none';
            // Reset submit button visibility (may have been hidden for view-only modals)
            const submitBtn = document.querySelector('#createForm button[type="submit"]');
            if (submitBtn) submitBtn.style.display = 'block';
        }

        document.getElementById('createForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            let data = {};

            const endpoints = { training: 'trainings', customer: 'customers', trainer: 'trainers', brand: 'brands', user: 'auth/register', location: 'locations' };

            if (currentFormType === 'training') {
                // Handle training form with all extended fields
                const durationValue = parseFloat(formData.get('duration_value')) || 1;
                const durationType = formData.get('duration_type') || 'days';

                data = {
                    title: formData.get('title'),
                    brand_id: formData.get('brand_id') ? parseInt(formData.get('brand_id')) : null,
                    customer_id: formData.get('customer_id') ? parseInt(formData.get('customer_id')) : null,
                    trainer_id: formData.get('trainer_id') ? parseInt(formData.get('trainer_id')) : null,
                    status: formData.get('status'),
                    start_date: formData.get('start_date') || null,
                    end_date: formData.get('end_date') || null,
                    duration_days: durationType === 'days' ? durationValue : Math.ceil(durationValue / 8),
                    duration_hours: durationType === 'hours' ? durationValue : durationValue * 8,
                    duration_type: durationType,
                    zeitraum: formData.get('zeitraum') || null,
                    training_type: formData.get('training_type'),
                    training_format: formData.get('training_format'),
                    location: formData.get('location'),
                    location_booking: formData.get('location_booking') || null,
                    catering_booking: formData.get('catering_booking') || null,
                    tagessatz: formData.get('tagessatz') ? parseFloat(formData.get('tagessatz')) : null,
                    location_cost: formData.get('location_cost') ? parseFloat(formData.get('location_cost')) : null,
                    catering_cost: formData.get('catering_cost') ? parseFloat(formData.get('catering_cost')) : null,
                    provision: formData.get('provision') ? parseFloat(formData.get('provision')) : null,
                    other_costs: formData.get('other_costs') ? parseFloat(formData.get('other_costs')) : null,
                    price_external: formData.get('price_external') ? parseFloat(formData.get('price_external')) : null,
                    price_internal: formData.get('price_internal') ? parseFloat(formData.get('price_internal')) : null,
                    price_per_participant: formData.get('price_per_participant') ? parseFloat(formData.get('price_per_participant')) : null,
                    max_participants: formData.get('max_participants') ? parseInt(formData.get('max_participants')) : null,
                    language: formData.get('language') || null,
                    online_link: formData.get('online_link') || null,
                    internal_notes: formData.get('internal_notes')
                };
            } else if (currentFormType === 'trainer') {
                // Handle trainer form specially
                data = {
                    first_name: formData.get('first_name'),
                    last_name: formData.get('last_name'),
                    email: formData.get('email'),
                    phone: formData.get('phone'),
                    address: formData.get('address'),
                    vat_number: formData.get('vat_number'),
                    linkedin_url: formData.get('linkedin_url'),
                    website: formData.get('website'),
                    default_day_rate: formData.get('default_day_rate') ? parseFloat(formData.get('default_day_rate')) : null,
                    region: formData.get('region'),
                    bio: formData.get('bio'),
                    notes: formData.get('notes'),
                    specializations: {
                        selected: formData.getAll('spec_selected'),
                        custom: formData.getAll('spec_custom').filter(s => s.trim() !== '')
                    }
                };
            } else if (currentFormType === 'customer') {
                // Handle customer form specially
                data = {
                    company_name: formData.get('company_name'),
                    first_name: formData.get('first_name'),
                    last_name: formData.get('last_name'),
                    salutation: formData.get('salutation'),
                    contact_email: formData.get('contact_email'),
                    contact_phone: formData.get('contact_phone'),
                    vat_number: formData.get('vat_number'),
                    street: formData.get('street'),
                    street_number: formData.get('street_number'),
                    postal_code: formData.get('postal_code'),
                    city: formData.get('city'),
                    conditions: formData.get('conditions'),
                    comment: formData.get('comment')
                };
            } else if (currentFormType === 'location') {
                // Handle location form
                data = {
                    name: formData.get('name'),
                    city: formData.get('city'),
                    street: formData.get('street'),
                    street_number: formData.get('street_number'),
                    postal_code: formData.get('postal_code'),
                    billing_street: formData.get('billing_street'),
                    billing_street_number: formData.get('billing_street_number'),
                    billing_postal_code: formData.get('billing_postal_code'),
                    billing_city: formData.get('billing_city'),
                    billing_vat: formData.get('billing_vat'),
                    contact_first_name: formData.get('contact_first_name'),
                    contact_last_name: formData.get('contact_last_name'),
                    contact_email: formData.get('contact_email'),
                    contact_phone: formData.get('contact_phone'),
                    contact_notes: formData.get('contact_notes'),
                    description: formData.get('description'),
                    max_participants: formData.get('max_participants') ? parseInt(formData.get('max_participants')) : null,
                    features: formData.get('features'),
                    website_link: formData.get('website_link'),
                    catering_available: formData.get('catering_available'),
                    rental_cost: formData.get('rental_cost') ? parseFloat(formData.get('rental_cost')) : null,
                    rental_cost_type: formData.get('rental_cost_type'),
                    parking: formData.get('parking'),
                    directions: formData.get('directions'),
                    participant_info: formData.get('participant_info')
                };
            } else if (currentFormType === 'user') {
                // Handle user form - checkbox needs special handling
                data = {
                    username: formData.get('username'),
                    email: formData.get('email'),
                    password: formData.get('password'),
                    role: formData.get('role'),
                    is_active: formData.get('is_active') === 'on'
                };
            } else {
                data = Object.fromEntries(formData);
            }

            // Determine if this is create or update
            const isUpdate = editingId !== null;
            let url = `/${endpoints[currentFormType]}`;
            let method = 'POST';

            if (isUpdate) {
                url = `/${endpoints[currentFormType]}/${editingId}`;
                method = 'PUT';
            }

            const res = await apiCall(url, {
                method: method,
                body: JSON.stringify(data)
            });

            console.log(`${isUpdate ? 'Update' : 'Create'} response status:`, res.status);

            if (!res.ok) {
                const error = await res.json().catch(() => ({}));
                console.error(`${isUpdate ? 'Update' : 'Create'} error:`, error);
                alert(error.error || 'Fehler beim Speichern');
                return;
            }

            const result = await res.json();
            console.log(`${isUpdate ? 'Updated' : 'Created'} item:`, result);

            // Check if we need to return to training form after creating customer
            if (currentFormType === 'customer' && formData.get('return_to_training') === 'true') {
                await returnToTrainingForm(result.id);
                return;
            }

            closeModal();
            // Special handling for users section name
            const sectionName = currentFormType === 'user' ? 'users' : endpoints[currentFormType];
            console.log('Refreshing section:', sectionName);
            showSection(sectionName);
        });

        // ========== MESSAGING FUNCTIONS ==========

        let currentMessageId = null;
        let availableUsers = [];

        async function updateUnreadCount() {
            try {
                const res = await apiCall('/messages/unread-count');
                if (res.ok) {
                    const data = await res.json();
                    const badge = document.getElementById('unreadBadge');
                    if (data.count > 0) {
                        badge.textContent = data.count > 99 ? '99+' : data.count;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            } catch (err) {
                console.error('Error updating unread count:', err);
            }
        }

        async function loadMessages() {
            try {
                const res = await apiCall('/messages');
                if (!res.ok) throw new Error('Failed to load messages');
                const messages = await res.json();

                const container = document.getElementById('messagesList');
                if (messages.length === 0) {
                    container.innerHTML = '<p style="color: #6c757d; text-align: center; padding: 2rem;">Keine Nachrichten vorhanden.</p>';
                    return;
                }

                container.innerHTML = messages.map(m => {
                    const isUnread = !m.is_read;
                    const statusBadge = (m.message_type === 'error_report' || m.message_type === 'trainer_application')
                        ? `<span class="message-status status-${m.status}">${getStatusLabel(m.status)}</span>`
                        : '';
                    let typeIcon = '✉️';
                    if (m.message_type === 'error_report') typeIcon = '⚠️';
                    if (m.message_type === 'trainer_application') typeIcon = '👤';

                    return `
                        <div class="message-item ${isUnread ? 'message-unread' : ''}" onclick="viewMessage(${m.id})">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <strong>${typeIcon} ${m.subject || '(Kein Betreff)'}</strong>
                                    ${statusBadge}
                                </div>
                            </div>
                            <div class="message-meta">
                                Von: ${m.sender_name} | ${new Date(m.created_at).toLocaleString('de-DE')}
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (err) {
                console.error('Error loading messages:', err);
                document.getElementById('messagesList').innerHTML =
                    '<p style="color: #dc3545; text-align: center;">Fehler beim Laden der Nachrichten.</p>';
            }
        }

        function getStatusLabel(status) {
            const labels = {
                'open': 'Offen',
                'solved': 'Gelöst',
                'not_solvable': 'Nicht lösbar'
            };
            return labels[status] || status;
        }

        let currentApplicationId = null;

        async function viewMessage(id) {
            try {
                const res = await apiCall(`/messages/${id}`);
                if (!res.ok) throw new Error('Failed to load message');
                const message = await res.json();

                currentMessageId = id;
                currentApplicationId = null;

                document.getElementById('messageViewTitle').textContent = message.subject || 'Nachricht';
                document.getElementById('messageFrom').textContent = message.sender_name;
                document.getElementById('messageTo').textContent = message.recipient_name || 'Alle Admins';
                document.getElementById('messageDate').textContent = new Date(message.created_at).toLocaleString('de-DE');
                document.getElementById('messageBody').textContent = message.content;

                // Reset all special controls
                document.getElementById('messageStatusRow').style.display = 'none';
                document.getElementById('adminStatusControls').style.display = 'none';
                document.getElementById('trainerApprovalControls').style.display = 'none';

                // Show controls based on message type
                if (message.message_type === 'error_report') {
                    document.getElementById('messageStatusRow').style.display = 'block';
                    document.getElementById('messageStatusDisplay').innerHTML =
                        `<span class="message-status status-${message.status}">${getStatusLabel(message.status)}</span>`;

                    // Show admin controls for error reports
                    if (currentUser.role === 'admin' || currentUser.role === 'backoffice_user') {
                        document.getElementById('adminStatusControls').style.display = 'block';
                        document.getElementById('messageStatusSelect').value = message.status;
                    }

                    // Show page URL if available
                    if (message.page_url) {
                        document.getElementById('messageBody').textContent =
                            `Seite: ${message.page_url}\n\n${message.content}`;
                    }
                } else if (message.message_type === 'trainer_application') {
                    // Extract application ID from message content
                    const appIdMatch = message.content.match(/Application ID: (\d+)/);
                    if (appIdMatch) {
                        currentApplicationId = parseInt(appIdMatch[1]);
                    }

                    document.getElementById('messageStatusRow').style.display = 'block';
                    document.getElementById('messageStatusDisplay').innerHTML =
                        `<span class="message-status status-${message.status}">${getStatusLabel(message.status)}</span>`;

                    // Show trainer approval controls for admins/backoffice if application is pending
                    if ((currentUser.role === 'admin' || currentUser.role === 'backoffice_user') && message.status === 'open') {
                        document.getElementById('trainerApprovalControls').style.display = 'block';
                    }
                }

                document.getElementById('replyContent').value = '';
                document.getElementById('messageViewModal').style.display = 'flex';

                // Update unread count and refresh list
                updateUnreadCount();
                loadMessages();

            } catch (err) {
                console.error('Error viewing message:', err);
                alert('Fehler beim Laden der Nachricht');
            }
        }

        async function approveTrainerApplication() {
            if (!currentApplicationId) {
                alert('Keine Bewerbungs-ID gefunden');
                return;
            }

            if (!confirm('Möchten Sie diese Trainerbewerbung genehmigen und den Trainer anlegen?')) {
                return;
            }

            try {
                const res = await fetch(`${API_URL}/trainer/applications/${currentApplicationId}/approve`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await res.json();

                if (res.ok) {
                    alert('Trainer wurde erfolgreich angelegt!');
                    // Mark message as solved
                    await fetch(`${API_URL}/messages/${currentMessageId}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ status: 'solved' })
                    });
                    closeMessageViewModal();
                    loadMessages();
                } else {
                    alert(result.error || 'Fehler beim Anlegen des Trainers');
                }
            } catch (err) {
                console.error('Error approving application:', err);
                alert('Fehler beim Genehmigen der Bewerbung');
            }
        }

        async function rejectTrainerApplication() {
            if (!currentApplicationId) {
                alert('Keine Bewerbungs-ID gefunden');
                return;
            }

            if (!confirm('Möchten Sie diese Trainerbewerbung ablehnen?')) {
                return;
            }

            try {
                const res = await fetch(`${API_URL}/trainer/applications/${currentApplicationId}/reject`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await res.json();

                if (res.ok) {
                    alert('Bewerbung wurde abgelehnt');
                    // Mark message as not solvable
                    await fetch(`${API_URL}/messages/${currentMessageId}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ status: 'not_solvable' })
                    });
                    closeMessageViewModal();
                    loadMessages();
                } else {
                    alert(result.error || 'Fehler beim Ablehnen der Bewerbung');
                }
            } catch (err) {
                console.error('Error rejecting application:', err);
                alert('Fehler beim Ablehnen der Bewerbung');
            }
        }

        async function updateMessageStatus() {
            if (!currentMessageId) return;

            const status = document.getElementById('messageStatusSelect').value;
            try {
                const res = await fetch(`${API_URL}/messages/${currentMessageId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status })
                });

                if (res.ok) {
                    alert('Status aktualisiert');
                    document.getElementById('messageStatusDisplay').innerHTML =
                        `<span class="message-status status-${status}">${getStatusLabel(status)}</span>`;
                    loadMessages();
                } else {
                    const error = await res.json();
                    alert(error.error || 'Fehler beim Aktualisieren');
                }
            } catch (err) {
                console.error('Error updating status:', err);
                alert('Fehler beim Aktualisieren');
            }
        }

        async function sendReply() {
            if (!currentMessageId) return;

            const content = document.getElementById('replyContent').value.trim();
            if (!content) {
                alert('Bitte geben Sie eine Antwort ein');
                return;
            }

            try {
                // Get the original message to reply to the sender
                const res = await apiCall(`/messages/${currentMessageId}`);
                const originalMessage = await res.json();

                const replyRes = await fetch(`${API_URL}/messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        recipient_id: originalMessage.sender_id,
                        subject: `Re: ${originalMessage.subject || '(Kein Betreff)'}`,
                        content: content,
                        parent_id: currentMessageId,
                        message_type: 'message'
                    })
                });

                if (replyRes.ok) {
                    alert('Antwort gesendet');
                    document.getElementById('replyContent').value = '';
                    closeMessageViewModal();
                    loadMessages();
                } else {
                    const error = await replyRes.json();
                    alert(error.error || 'Fehler beim Senden');
                }
            } catch (err) {
                console.error('Error sending reply:', err);
                alert('Fehler beim Senden der Antwort');
            }
        }

        async function deleteCurrentMessage() {
            if (!currentMessageId) return;

            if (!confirm('Möchten Sie diese Nachricht wirklich löschen?')) return;

            try {
                const res = await fetch(`${API_URL}/messages/${currentMessageId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (res.ok) {
                    closeMessageViewModal();
                    loadMessages();
                    updateUnreadCount();
                } else {
                    const error = await res.json();
                    alert(error.error || 'Fehler beim Löschen');
                }
            } catch (err) {
                console.error('Error deleting message:', err);
                alert('Fehler beim Löschen');
            }
        }

        function closeMessageViewModal() {
            document.getElementById('messageViewModal').style.display = 'none';
            currentMessageId = null;
        }

        // Error Report Modal
        function showErrorReportModal() {
            document.getElementById('errorPageUrl').value = window.location.href;
            document.getElementById('errorReportForm').reset();
            document.getElementById('errorReportModal').style.display = 'flex';
        }

        function closeErrorReportModal() {
            document.getElementById('errorReportModal').style.display = 'none';
        }

        document.getElementById('errorReportForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const data = {
                message_type: 'error_report',
                subject: formData.get('subject'),
                content: formData.get('content'),
                page_url: formData.get('page_url'),
                recipient_id: null  // Send to all admins
            };

            try {
                const res = await fetch(`${API_URL}/messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    alert('Fehlermeldung wurde gesendet. Vielen Dank!');
                    closeErrorReportModal();
                } else {
                    const error = await res.json();
                    alert(error.error || 'Fehler beim Senden');
                }
            } catch (err) {
                console.error('Error sending error report:', err);
                alert('Fehler beim Senden der Meldung');
            }
        });

        // New Message Modal
        async function showNewMessageModal() {
            // Load available users
            try {
                const res = await apiCall('/users/list');
                if (res.ok) {
                    availableUsers = await res.json();
                    const select = document.getElementById('messageRecipient');
                    select.innerHTML = '<option value="">Bitte wählen...</option>';

                    // Group by role
                    const admins = availableUsers.filter(u => u.role === 'admin');
                    const trainers = availableUsers.filter(u => u.role === 'trainer');

                    if (admins.length > 0) {
                        select.innerHTML += '<optgroup label="Admins">' +
                            admins.map(u => `<option value="${u.id}">${u.username}</option>`).join('') +
                            '</optgroup>';
                    }
                    if (trainers.length > 0) {
                        select.innerHTML += '<optgroup label="Trainer">' +
                            trainers.map(u => `<option value="${u.id}">${u.username}</option>`).join('') +
                            '</optgroup>';
                    }
                }
            } catch (err) {
                console.error('Error loading users:', err);
            }

            document.getElementById('newMessageForm').reset();
            document.getElementById('newMessageModal').style.display = 'flex';
        }

        function closeNewMessageModal() {
            document.getElementById('newMessageModal').style.display = 'none';
        }

        document.getElementById('newMessageForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const recipientId = formData.get('recipient_id');

            if (!recipientId) {
                alert('Bitte wählen Sie einen Empfänger');
                return;
            }

            const data = {
                message_type: 'message',
                recipient_id: parseInt(recipientId),
                subject: formData.get('subject'),
                content: formData.get('content')
            };

            try {
                const res = await fetch(`${API_URL}/messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    alert('Nachricht gesendet');
                    closeNewMessageModal();
                    loadMessages();
                } else {
                    const error = await res.json();
                    alert(error.error || 'Fehler beim Senden');
                }
            } catch (err) {
                console.error('Error sending message:', err);
                alert('Fehler beim Senden');
            }
        });
    </script>
</body>
</html>
